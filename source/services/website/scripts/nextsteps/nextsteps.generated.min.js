var Control=function Control$(){};Control.noDelay={delay:{show:0,hide:0}};Control.ttDelay={delay:{show:500,hide:200}};Control.preventDefault=function Control$preventDefault(b){b.preventDefault()};Control.delegate=function Control$delegate(f,e){var d={object:f,handler:e};d.invoke=function(){return this.object[this.handler]()};return d};Control.get=function Control$get(b){return $(b).data("control")};Control.findParent=function Control$findParent(c,d){while(c.parentControl!=null){c=c.parentControl;if(c[d]!=null){return c}}return null};Control.expand=function Control$expand(d,e,f){if(e==true){d.show("blind",{direction:"vertical"},400,f)}else{d.collapse("show")}};Control.collapse=function Control$collapse(d,e,f){if(e==true){d.hide("blind",{direction:"vertical"},300,f)}else{d.collapse("hide")}};Control.alert=function Control$alert(h,g,f){var e=$("#modalMessage");if(e.length==0){h.replace("<br>","\r");alert(h);if(f!=null){f()}}else{if(g==null){g="Warning!"}e.find(".modal-header h3").html(g);e.find(".modal-body p").html(h);e.modal("show");if(f!=null){e.find(".modal-header .close").click(function(){f()});e.find(".modal-footer .btn-primary").click(function(){f()})}}};Control.confirm=function Control$confirm(j,i,h,g){var f=$("#modalPrompt");if(f.length==0){j.replace("<br>","\r");if(confirm(j)==true){if(h!=null){h()}}else{if(g!=null){g()}}}else{if(i==null){i="Confirm?"}f.find(".modal-header h3").html(i);f.find(".modal-body p").html(j);f.modal({backdrop:"static",keyboard:false});f.find(".modal-footer .btn-primary").click(function(){f.modal("hide");if(h!=null){h()}});f.find(".modal-footer .btn-cancel").click(function(){f.modal("hide");if(g!=null){g()}})}};var Browser=function Browser$(){};Browser.IsMSIE=function Browser$IsMSIE(){return(navigator.appName=="Microsoft Internet Explorer")};Browser.IsMobile=function Browser$IsMobile(b){if(b!==undefined){Browser.isMobile=b}return Browser.isMobile};Browser.isMobile=false;Browser.MSIE_Version=function Browser$MSIE_Version(){var d=-1;if(Browser.IsMSIE){var c=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(c.exec(navigator.userAgent)!=null){d=parseFloat(RegExp.$1)}}return d};Control.Icons={};Control.Icons.forSources=function Control$Icons$forSources(k){var h=$("<span />");if(k.HasField(FieldNames.Sources)){var l=k.GetFieldValue(FieldNames.Sources);if(l!=null){l=l.split(",");for(var j in l){switch(l[j]){case"Facebook":var i=k.GetFieldValue(FieldNames.FacebookID);var g=$('<i class="icon-facebook-sign" />').appendTo(h);if(i!=null){g.click(function(){window.open("http://www.facebook.com/"+i);return false})}break;case"Directory":h.append('<i class="icon-azure" />');break}}}else{if(k.ItemTypeID==ItemTypes.Contact){h.append('<i class="icon-user"></i>')}}}return h};Control.Icons.forItemType=function Control$Icons$forItemType(e){var f=e;if(typeof(e)=="object"){f=e.ItemTypeID}var d=$("<i></i>");switch(f){case ItemTypes.Activity:d.addClass("icon-time");break;case ItemTypes.Step:d.addClass("icon-check");break;case ItemTypes.Contact:d.addClass("icon-user");break;case ItemTypes.Location:d.addClass("icon-map-marker");break;case ItemTypes.Category:default:d.addClass("icon-folder-close");break}return d};Control.Icons.forActionType=function Control$Icons$forActionType(e){var f=e;if(e!=null&&typeof(e)=="object"){f=e.Name}var d=$("<i></i>");switch(f){case ActionTypes.Call:d.addClass("icon-phone");break;case ActionTypes.SendEmail:d.addClass("icon-envelope");break;case ActionTypes.Find:d.addClass("icon-search");break;case ActionTypes.Schedule:d.addClass("icon-calendar");break;case ActionTypes.Map:d.addClass("icon-map-marker");break;case ActionTypes.TextMessage:d.addClass("icon-list-alt");break;case ActionTypes.Default:d.addClass("icon-question-sign");break;default:d.addClass("icon-question-sign");break}return d};Control.Icons.forMap=function Control$Icons$forMap(i){var j=i.GetFieldValue(FieldNames.WebLinks);if(j!=null&&j.length>0){var l=new LinkArray(j).Links();for(var h in l){var k=l[h];if(k.Name=="Map"&&k.Url!=null){var g=$('<i class="icon-map-marker"></i>');g.attr("href",k.Url);g.attr("title","Map").tooltip(Control.ttDelay);g.click(function(){window.open($(this).attr("href"));return false});return g}}}return $("<i></i>")};Control.Icons.deleteBtn=function Control$Icons$deleteBtn(d){var c=$('<i class="icon-remove-sign"></i>');c.css("cursor","pointer");c.data("item",d);c.attr("title","Delete").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");var f=a.data("item");var b=(f.ParentID==null)?f.GetFolder():f.GetParent();f.Delete(b);return false});return $('<a class="icon" />').append(c)};Control.Icons.completeBtn=function Control$Icons$completeBtn(d){var c=$('<h2 class="icon-check"></h2>');c.css("cursor","pointer");c.data("item",d);c.attr("title","Complete").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");b.Complete();return true});return $('<a class="icon" />').append(c)};Control.Icons.skipBtn=function Control$Icons$skipBtn(d){var c=$('<h2 class="icon-step-forward"></h2>');c.css("cursor","pointer");c.data("item",d);c.attr("title","Skip").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");b.Skip();return true});return $('<a class="icon" />').append(c)};Control.Icons.deferBtn=function Control$Icons$deferBtn(d){var c=$('<h2 class="icon-calendar"></h2>');c.css("cursor","pointer");c.data("item",d);c.attr("title","Defer").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");return true});return $('<a class="icon" />').append(c)};Control.Icons.callBtn=function Control$Icons$callBtn(d){var c=$('<h2 class="icon-phone"></h2>');c.css("cursor","pointer");c.data("item",d);c.attr("title","Call").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");var f=b.GetPhoneNumber();if(f!=null){window.open("tel:"+f);return false}return false});return $('<a class="icon" />').append(c)};Control.Icons.mapBtn=function Control$Icons$mapBtn(e){var f=e.GetMapLink();if(f!=null){var d=$('<h2 class="icon-map-marker"></h2>');d.attr("href",f.Url);d.attr("title","Map").tooltip(Control.ttDelay);d.click(function(){window.open($(this).attr("href"));return false});return d}};Control.Text={};Control.Text.render=function Control$Text$render(i,l,k,m,o,n){var m=(m==null)?"span":m;var j;var p=l.GetFieldValue(k);if(k.DisplayType==DisplayTypes.DatePicker){p=Control.DateTime.format(p)}else{if(k.DisplayType==DisplayTypes.DateTimePicker){p=Control.DateTime.format(p)}}if(p!=null){j=$("<"+m+"/>").appendTo(i);j.addClass(k.Class);p=((o==null)?"":o)+p+((n==null)?"":n);j.html(p)}return j};Control.Text.renderLabel=function Control$Text$renderLabel(f,i,h){var g;var j=i.GetFieldValue(h);if(j!=null){g=$("<label><strong>"+j+"</strong></label>").appendTo(f);g.addClass(h.Class)}return g};Control.Text.renderH2Label=function Control$Text$renderH2Label(f,i,h){var g;var j=i.GetFieldValue(h);if(j!=null){g=$("<label><h2>"+j+"</h2></label>").appendTo(f);g.addClass(h.Class)}return g};Control.Text.renderEmail=function Control$Text$renderEmail(f,i,h){var g;var j=i.GetFieldValue(h);if(j!=null){g=$("<a />").appendTo(f);g.addClass(h.Class);g.attr("href","mailto:"+j);g.html(j)}return g};Control.Text.renderInput=function Control$Text$renderInput(d,f,e){$text=$('<input type="text" />').appendTo(d);$text=Control.Text.base($text,f,e);Control.Text.placeholder($text,e);$text.change(function(a){Control.Text.update($(a.srcElement))});$text.keypress(function(a){if(a.which==13){Control.Text.update($(a.srcElement));return false}});return $text};Control.Text.renderInputNew=function Control$Text$renderInput(e,g,f,h){$text=$('<input type="text" />').appendTo(e);$text=Control.Text.base($text,g,f);$text.data("list",h);$text.keypress(function(a){if(a.which==13){Control.Text.insert($(a.srcElement));return false}});if(g.ItemTypeID==ItemTypes.Location){Control.Text.autoCompletePlace($text,Control.Text.insert)}else{if(g.ItemTypeID==ItemTypes.Contact){Control.Text.autoCompleteContact($text,Control.Text.insert);Control.Text.placeholder($text,"Enter a contact")}else{if(g.ItemTypeID==ItemTypes.Grocery){Control.Text.autoCompleteGrocery($text,Control.Text.insert);Control.Text.placeholder($text,"Enter an item")}else{if(g.ItemTypeID==ItemTypes.Task){Control.Text.placeholder($text,"Enter a task")}else{if(g.ItemTypeID==ItemTypes.Appointment){Control.Text.placeholder($text,"Enter an appointment")}else{Control.Text.placeholder($text,"Enter an item")}}}}}return $text};Control.Text.renderTextArea=function Control$Text$renderTextArea(d,f,e){$text=$("<textarea></textarea>").appendTo(d);$text=Control.Text.base($text,f,e);Control.Text.placeholder($text,e);$text.change(function(a){Control.Text.update($(a.srcElement))});return $text};Control.Text.renderInputAddress=function Control$Text$renderInputAddress(d,f,e){$text=$('<input type="text" />').appendTo(d);$text=Control.Text.base($text,f,e);$text.keypress(function(a){if(a.which==13){Control.Text.updateAddress($(a.srcElement));return false}});$text=Control.Text.autoCompletePlace($text,Control.Text.updateAddress);return $text};Control.Text.renderInputGrocery=function Control$Text$renderInputGrocery(d,f,e){$text=$('<input type="text" />').appendTo(d);$text=Control.Text.base($text,f,e);$text.keypress(function(a){if(a.which==13){Control.Text.updateGrocery($(a.srcElement));return false}});$text=Control.Text.autoCompleteGrocery($text,Control.Text.updateGrocery);return $text};Control.Text.autoCompletePlace=function Control$Text$autoCompletePlace(f,j){f.unbind("keypress");$text.keypress(function(a){if(a.which==13){return false}});var g=new google.maps.places.Autocomplete(f[0]);var h=function(a,b){var c=0.5;return new google.maps.LatLngBounds(new google.maps.LatLng(a-c,b-c),new google.maps.LatLng(a+c,b+c))};var i=h(47.65,-122.3);g.setBounds(i);google.maps.event.addListener(g,"place_changed",function(){f.data("place",g.getPlace());j(f)});return f};Control.Text.autoCompleteAddress=function Control$Text$autoCompleteAddress(c,d){c.autocomplete({source:function(a,b){Service.Geocoder().geocode({address:a.term},function(i,j){if(j==google.maps.GeocoderStatus.OK){var h=$.map(i,function(e){return{label:e.formatted_address,value:e.formatted_address,latlong:e.geometry.location.toUrlValue()}});b(h)}})},select:function(a,b){$(this).val(b.item.label);$(this).data(FieldNames.LatLong,b.item.latlong);d($(this));return false},minLength:2});return c};Control.Text.autoCompleteContact=function Control$Text$autoCompleteContact(c,d){c.autocomplete({source:function(a,b){Service.InvokeController("UserInfo","PossibleContacts",{startsWith:a.term},function(k){var l=k.result;var i=[];if(l.Count>0){for(var j in l.Contacts){i.push({label:j,value:j,json:l.Contacts[j]})}}b(i)})},select:function(a,b){$(this).val(b.item.label);$(this).data(FieldNames.Contacts,b.item.json);d($(this));return false},minLength:1});return c};Control.Text.autoCompleteGrocery=function Control$Text$autoCompleteGrocery(c,d){c.autocomplete({source:function(a,b){Service.InvokeController("Grocery","GroceryNames",{startsWith:a.term},function(m){var n=m.result;var i=[];if(n.Count>0){for(var k in n.Groceries){var l=n.Groceries[k];i.push({label:l.Name,value:l.Name,json:l})}}b(i)})},select:function(a,b){$(this).val(b.item.label);$(this).data("grocery",b.item.json);d($(this));return false},minLength:1});return c};Control.Text.insert=function Control$Text$insert(j){var k=j.data("field");if(k.Name==FieldNames.Name){var r=j.val();if(r==null||r.length==0){return false}var m=j.data("item");var p=j.data("list");if(m.ItemTypeID==ItemTypes.Location){var q=j.data("place");var o=j.data(FieldNames.LatLong);if(q!=null&&q.geometry!=null){m=Control.Text.applyPlace(m,q);r=q.name}else{if(o!=null){m.SetFieldValue(FieldNames.LatLong,o);m.SetFieldValue(FieldNames.Address,r)}}}if(m.ItemTypeID==ItemTypes.Contact){var n=j.data(FieldNames.Contacts);if(n!=null){contact=$.parseJSON(n);if(contact.ItemTypeID==ItemTypes.Contact){m=Item.Extend(contact)}}}if(m.ItemTypeID==ItemTypes.Grocery){var l=j.data("grocery");if(l!=null){Control.Text.applyGrocery(m,l);r=l.Name}}m.SetFieldValue(k,r);p.InsertItem(m)}};Control.Text.update=function Control$Text$update(h,i){var l=h.data("item");var k=h.data("field");var n=h.val();var j=l.GetFieldValue(k);if(k.FieldType==FieldTypes.DateTime){n=Control.DateTime.formatUTC(n)}if(n!=j){var m=l.Copy();m.SetFieldValue(k,n);l.Update(m,i)}};Control.Text.updateAddress=function Control$Text$updateAddress(j){var n=j.data("item");var m=j.data("field");var r=j.val();var l=n.GetFieldValue(m);var q=n.Copy();var p=j.data("place");var o=j.data(FieldNames.LatLong);if(p!=null&&p.geometry!=null){q=Control.Text.applyPlace(q,p,m.Name)}else{if(o!=null){var k=n.GetFieldValue(FieldNames.LatLong);if(k==null||k!=o){q.SetFieldValue(FieldNames.LatLong,o);q.SetFieldValue(m,r)}}else{if(r!=l){q.SetFieldValue(m,r)}}}n.Update(q)};Control.Text.applyPlace=function Control$Text$applyPlace(g,i,f){if(g.Name==null||f==FieldNames.Name){g.SetFieldValue(FieldNames.Name,i.name)}g.SetFieldValue(FieldNames.LatLong,i.geometry.location.toUrlValue());g.SetFieldValue(FieldNames.Address,i.formatted_address);if(i.formatted_phone_number!=null&&g.GetFieldValue(FieldNames.Phone)==null){g.SetFieldValue(FieldNames.Phone,i.formatted_phone_number)}var h=g.GetFieldValue(FieldNames.WebLinks);if(h==null||h=="[]"){var j=new LinkArray();if(i.types[0]=="street_address"){j.Add("http://maps.google.com/maps?z=15&t=m&q="+i.formatted_address,"Map")}else{j.Add(i.url,"Map")}if(i.website!=null){j.Add(i.website,"Website")}g.SetFieldValue(FieldNames.WebLinks,j.ToJson())}return g};Control.Text.updateGrocery=function Control$Text$updateGrocery(h){var l=h.data("item");var j=h.data("field");var n=h.val();var i=l.GetFieldValue(j);var m=l.Copy();var k=h.data("grocery");if(k!=null){m=Control.Text.applyGrocery(m,k,j.Name)}else{if(n!=i){m.SetFieldValue(j,n)}}l.Update(m)};Control.Text.applyGrocery=function Control$Text$applyGrocery(f,e,d){if(f.Name==null||d==FieldNames.Name){f.SetFieldValue(FieldNames.Name,e.Name)}f.SetFieldValue(FieldNames.Category,e.Category);f.SetFieldValue(FieldNames.Picture,e.ImageUrl);return f};Control.Text.base=function Control$Text$base(d,f,e){d.addClass(e.Class);d.data("item",f);d.data("field",e);d.val(f.GetFieldValue(e));return d};Control.Text.placeholder=function Control$Text$placeholder(c,d){if(typeof(d)=="object"){d="Enter "+d.DisplayName.toLowerCase()}c.attr("placeholder",d);if(Browser.IsMSIE()){if(c.val()==null||c.val().length==0){c.val(d);c.addClass("ie-placeholder")}c.focus(function(){var a=$(this);if(a.val()==a.attr("placeholder")){a.val("");a.removeClass("ie-placeholder")}});c.blur(function(){var a=$(this);if(a.val()==null||a.val().length==0){a.val(a.attr("placeholder"));a.addClass("ie-placeholder")}})}};Control.Checkbox={};Control.Checkbox.render=function Control$Checkbox$render(d,f,e){$checkbox=$('<input type="checkbox" class="checkbox" />').appendTo(d);$checkbox.addClass(e.Class);$checkbox.attr("title",e.DisplayName).tooltip(Control.ttDelay);if(f.GetFieldValue(e)==true){$checkbox.attr("checked","checked")}$checkbox.data("item",f);$checkbox.data("field",e);$checkbox.change(function(){Control.Checkbox.update($(this))});return $checkbox};Control.Checkbox.update=function Control$Checkbox$update(g){var j=g.data("item");var i=g.data("field");var l=(g.attr("checked")=="checked");var h=j.GetFieldValue(i);if(l!=h){g.tooltip("hide");var k=j.Copy();k.SetFieldValue(i,l);if(l==true&&i.Name==FieldNames.Complete&&j.HasField(FieldNames.CompletedOn)){k.SetFieldValue(FieldNames.CompletedOn,new Date().format())}j.Update(k)}};Control.LinkArray={};Control.LinkArray.render=function Control$LinkArray$render(i,p,n){var m=$('<div class="link-array" />').appendTo(i);$text=$('<input type="text" />').appendTo(m);$text=Control.Text.base($text,p,n);$text.val("");Control.Text.placeholder($text,"Add a link");$text.change(function(a){Control.LinkArray.update($(a.srcElement))});$text.keypress(function(a){if(a.which==13){Control.LinkArray.update($(a.srcElement));return false}});var r=new LinkArray(p.GetFieldValue(n));var s=r.Links();if(s.length>0){for(var o in s){Control.LinkArray.deleteBtn(o).appendTo(m);var q=s[o];var l=$("<a/>").appendTo(m);var t=(q.Name==null)?q.Url:q.Name;l.html(t);l.attr("href",q.Url);l.attr("target","new")}}return $text};Control.LinkArray.update=function Control$LinkArray$update(g){var i=g.data("item");var h=g.data("field");var j=new LinkArray(i.GetFieldValue(h));var l=g.val();if(l!=null&&l.length>0){j.Add(l);var k=i.Copy();k.SetFieldValue(h,j.ToJson());i.Update(k)}};Control.LinkArray.deleteBtn=function Control$Icons$deleteBtn(d){var c=$('<i class="icon-remove-circle"></i>');c.css("cursor","pointer");c.attr("title","Remove Link").tooltip(Control.noDelay);c.data("index",d);c.bind("click",function(){var b=$(this);b.tooltip("hide");var a=b.parents(".link-array").first().find("input");var j=a.data("item");var i=a.data("field");var k=new LinkArray(j.GetFieldValue(i));k.Remove(b.data("index"));var l=j.Copy();l.SetFieldValue(i,k.ToJson());j.Update(l);return false});return $('<a class="icon" />').append(c)};Control.DateTime={};Control.DateTime.renderDatePicker=function Control$DateTime$renderDatePicker(d,f,e){$date=$('<input type="text" />').appendTo(d);$date.addClass(e.Class);$date.data("item",f);$date.data("field",e);$date.val(Control.DateTime.format(f.GetFieldValue(e),"shortDate"));$date.datepicker({numberOfMonths:2,onClose:function(b,a){Control.DateTime.update(a.input)}});return $date};Control.DateTime.renderDateTimePicker=function Control$DateTime$renderDateTimePicker(d,f,e){$date=$('<input type="text" />').appendTo(d);$date.addClass(e.Class);$date.data("item",f);$date.data("field",e);$date.val(Control.DateTime.format(f.GetFieldValue(e),"shortDateTime"));$date.datetimepicker({ampm:true,timeFormat:"h:mm TT",hourGrid:4,minuteGrid:15,stepMinute:15,numberOfMonths:2,onClose:function(b,a){Control.DateTime.update(a.input)}});return $date};Control.DateTime.renderRange=function Control$DateTime$renderRange(n,v,u,t,y){var y=(y==null)?"span":y;var o,z;var x=v.GetFieldValue(u);var s=v.GetFieldValue(t);if(x!=null&&s!=null){if(u.FieldType==FieldTypes.DateTime&&t.FieldType==FieldTypes.DateTime){var w=new Date().parseRFC3339(x);var p=new Date().parseRFC3339(s);if(w.toDateString()==p.toDateString()){var r=p.format().split(" ");var q=r[r.length-2]+" "+r[r.length-1];z="On "+w.format()+" to "+q}else{z="From "+w.format()+" until "+p.format()}}else{z="From "+x+" until "+s}}if(z!=null){o=$("<"+y+"/>").appendTo(n);o.addClass(u.Class);o.html(z)}return o};Control.DateTime.update=function Control$DateTime$update(b){Control.Text.update(b,null)};Control.DateTime.format=function Control$DateTime$format(h,g){if(h!=null&&h.length>0){try{var e=new Date().parseRFC3339(h);return e.format(g)}catch(f){}}return h};Control.DateTime.formatUTC=function Control$DateTime$formatUTC(b){return Control.DateTime.format(b,"isoUtcDateTime")};Control.ContactList={};Control.ContactList.renderInput=function Control$ContactList$renderInput(i,n,l){$input=$('<input type="text" />').appendTo(i);$input.addClass(l.Class);$input.data("item",n);$input.data("field",l);$input.keypress(function(a){if(a.which==13){Control.ContactList.update($(a.srcElement));return false}});var p=n.GetFieldValue(l);var o="";if(p!=null&&p.IsList){var k=p.GetItems();for(var m in k){var j=k[m].GetFieldValue(FieldNames.EntityRef);if(j!=null){o+=j.Name}break}}$input.val(o);Control.Text.autoCompleteContact($input,Control.ContactList.update);return $input};Control.ContactList.update=function Control$ContactList$update(j){var q=j.data("item");var p=j.data("field");var m=j.val();if(m==null||m.length==0){q.RemoveReferences(p);return}var k;var r=j.data(FieldNames.Contacts);if(r!=null){k=$.parseJSON(r)}if(k!=null&&k.ItemTypeID==ItemTypes.Reference){k={Name:k.Name,ID:k.FieldValues[0].Value};q.AddReference(p,k,true)}else{if(k!=null){k=Item.Extend(k);var o=k.GetFieldValue(FieldNames.FacebookID);var n=DataModel.FindContact(k.Name,o);if(n!=null){q.AddReference(p,k,true);return}}else{k=Item.Extend({Name:m,ItemTypeID:ItemTypes.Contact})}var l=DataModel.UserSettings.GetDefaultList(ItemTypes.Contact);DataModel.InsertItem(k,l,null,null,null,function(a){q.AddReference(p,a,true)})}};Control.LocationList={};Control.LocationList.renderInput=function Control$LocationList$renderInput(i,l,j){$input=$('<input type="text" />').appendTo(i);$input.addClass(j.Class);$input.data("item",l);$input.data("field",j);$input.keypress(function(a){if(a.which==13){Control.LocationList.update($(a.srcElement));return false}});var p=l.GetFieldValue(j);var o="";if(p!=null&&p.IsList){var n=p.GetItems();for(var k in n){var m=n[k].GetFieldValue(FieldNames.EntityRef);if(m!=null){o=m.Name}break}}$input.val(o);Control.Text.autoCompletePlace($input,Control.LocationList.update);return $input};Control.LocationList.update=function Control$LocationList$update(j){var n=j.data("item");var m=j.data("field");var k=j.val();if(k==null||k.length==0){n.RemoveReferences(m);return}var o=j.data(FieldNames.LatLong);var r=j.data("place");if(r!=null&&r.geometry!=null){o=r.geometry.location.toUrlValue()}var l=DataModel.FindLocation(k,o);if(l!=null){n.AddReference(m,l,true)}else{var p=DataModel.UserSettings.GetDefaultList(ItemTypes.Location);var q=Item.Extend({Name:k,ItemTypeID:ItemTypes.Location});if(r!=null&&r.geometry!=null){Control.Text.applyPlace(q,r)}else{q.SetFieldValue(FieldNames.Address,k);if(o!=null){q.SetFieldValue(FieldNames.LatLong,o)}}DataModel.InsertItem(q,p,null,null,null,function(a){n.AddReference(m,a,true)})}};Control.List={};Control.List.sortable=function Control$List$sortable(b){b.sortable({axis:"y",handle:".drag-handle",stop:function(q,u){$("i").tooltip("hide");var a=u.item;var s=a.data("item");if(s!=null){var t=a.parent("ul").children("li");for(var r in t){if(s.ID==$(t[r]).data("item").ID){var i=$(t[r]).prevAll("li").first();var p=Number((i.length==0)?0:i.data("item").SortOrder);var e=$(t[r]).nextAll("li").first();var o=Number((e.length==0)?p+1000:e.data("item").SortOrder);var v=s.Copy();v.SortOrder=p+((o-p)/2);s.Update(v);break}}}}})};Control.ItemType={};Control.ItemType.renderDropdown=function Control$ItemType$renderDropdown(r,w,B){var y=DataModel.Constants.ItemTypes;var u=y[w.ItemTypeID].Name;var t=t=$('<div class="control-group"></div>').appendTo(r);if(B!=true){var A=(w.IsFolder()||w.IsList)?"List":"Item";var z='<label class="control-label">Type of '+A+"</label>";$(z).appendTo(t)}var p=$('<div class="btn-group" />').appendTo(t);var o=$('<a class="btn dropdown-toggle" data-toggle="dropdown" />').appendTo(p);Control.Icons.forItemType(w).appendTo(o);if(B!=true){$("<span>&nbsp;&nbsp;"+u+"</span>").appendTo(o);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(o)}var q=$('<ul class="dropdown-menu" />').appendTo(p);q.data("item",w);for(var v in y){var x=y[v];if(x.UserID==SystemUsers.User||x.UserID==DataModel.User.ID){var s=$("<li><a></a></li>").appendTo(q);s.find("a").append(Control.Icons.forItemType(v));s.find("a").append("<span>&nbsp;&nbsp;"+y[v].Name+"</span>");s.data("value",v);s.click(function(a){Control.ItemType.update($(this));a.preventDefault()})}}return t};Control.ItemType.update=function Control$ItemType$update(h){var i=h.parent().data("item");var j=i.Copy();j.ItemTypeID=h.data("value");var f=h.parents(".btn-group").first().find(".btn");f.find("i").replaceWith(Control.Icons.forItemType(j));var g=h.find("span").first();if(g.length>0){f.find("span").first().html(g.html())}i.Update(j)};Control.ActionType={};Control.ActionType.renderDropdown=function Control$ActionType$renderDropdown(q,w,z){if(!w.HasField(FieldNames.ActionType)){return}var u=w.GetFieldValue(w.GetField(FieldNames.ActionType));if(u==null){u=ActionTypes.Default}var s=s=$('<div class="control-group"></div>').appendTo(q);if(z!=true){var y=(w.IsFolder()||w.IsList)?"List":"Item";var x='<label class="control-label">Type of '+y+"</label>";$(x).appendTo(s)}var o=$('<div class="btn-group" />').appendTo(s);var n=$('<a class="btn dropdown-toggle" data-toggle="dropdown" />').appendTo(o);Control.Icons.forActionType(u).appendTo(n);if(z!=true){$("<span>&nbsp;&nbsp;"+u+"</span>").appendTo(n);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(n)}var p=$('<ul class="dropdown-menu" />').appendTo(o);p.data("item",w);for(var v in ActionTypes){var t=ActionTypes[v];var r=$("<li><a></a></li>").appendTo(p);r.find("a").append(Control.Icons.forActionType(t));r.find("a").append("<span>&nbsp;&nbsp;"+t+"</span>");r.data("value",v);r.click(function(a){Control.ActionType.update($(this));a.preventDefault()})}return s};Control.ActionType.update=function Control$ActionType$update(j){var k=j.parent().data("item");var n=k.Copy();var l=j.data("value");var m=ActionTypes[l];n.SetFieldValue(n.GetField(FieldNames.ActionType),m);var h=j.parents(".btn-group").first().find(".btn");h.find("i").replaceWith(Control.Icons.forActionType(ActionTypes[m]));var i=j.find("span").first();if(i.length>0){h.find("span").first().html(i.html())}k.Update(n)};Control.DeferButton={};Control.DeferButton.renderDropdown=function Control$DeferButton$renderDropdown(k,n){if(!n.HasField(FieldNames.DueDate)){return}var m=$('<div class="control-group"></div>').appendTo(k);var i=$('<div class="btn-group" />').appendTo(m);var h=$('<a class="btn dropdown-toggle" data-toggle="dropdown"><h2 class="icon-calendar"/></a>').appendTo(i);var j=$('<ul class="dropdown-menu" />').appendTo(i);j.data("item",n);var l=$("<li><a></a></li>").css("border-top","0px").appendTo(j);l.find("a").append("<span>&nbsp;Tomorrow</span>");l.click(function(a){Control.DeferButton.update(n,1);a.preventDefault()});l=$("<li><a></a></li>").css("border-top","0px").appendTo(j);l.find("a").append("<span>&nbsp;Next week</span>");l.click(function(a){Control.DeferButton.update(n,7);a.preventDefault()});l=$("<li><a></a></li>").css("border-top","0px").appendTo(j);l.find("a").append("<span>&nbsp;Next month</span>");l.click(function(a){Control.DeferButton.update(n,30);a.preventDefault()});return m};Control.DeferButton.update=function Control$DeferButton$update(k,i){var l=k.Copy();var j=k.GetField(FieldNames.DueDate);var g=k.GetFieldValue(j);var h=new Date(g);switch(i){case 7:i=7-h.getDay();h.setDate(h.getDate()+i);break;case 30:h.setDate(1);h.setMonth(h.getMonth()+1);break;default:h.setDate(h.getDate()+i);break}l.SetFieldValue(j,h.toUTCString());k.Update(l)};Control.ThemePicker={};Control.ThemePicker.render=function Control$ThemePicker$render(l){var p=DataModel.Constants.Themes;var n=DataModel.UserSettings.Preferences.Theme;var m=$('<div class="control-group"><label class="control-label">Theme</label></div>').appendTo(l);var j=$('<div class="btn-group" />').appendTo(m);var i=$('<a class="btn dropdown-toggle" data-toggle="dropdown" />').appendTo(j);$("<span>"+n+"</span>").appendTo(i);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(i);var k=$('<ul class="dropdown-menu" />').appendTo(j);for(var o in p){$("<li><a>"+p[o]+"</a></li>").appendTo(k)}k.click(function(b){var a=$(b.target);var c=a.html();DataModel.UserSettings.UpdateTheme(c);a.parents(".btn-group").find("span").first().html(c);b.preventDefault()});return m};Control.DateFormat=function Control$DateFormat(){var h=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,f=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,g=/[^-+\dA-Z]/g,e=function(b,a){b=String(b);a=a||2;while(b.length<a){b="0"+b}return b};return function(d,z,C){var m=Control.DateFormat;if(arguments.length==1&&Object.prototype.toString.call(d)=="[object String]"&&!/\d/.test(d)){z=d;d=undefined}d=d?new Date(d):new Date;if(isNaN(d)){throw SyntaxError("invalid date")}z=String(m.masks[z]||z||m.masks["default"]);if(z.slice(0,4)=="UTC:"){z=z.slice(4);C=true}var a=C?"getUTC":"get",b=d[a+"Date"](),c=d[a+"Day"](),x=d[a+"Month"](),D=d[a+"FullYear"](),s=d[a+"Hours"](),y=d[a+"Minutes"](),B=d[a+"Seconds"](),w=d[a+"Milliseconds"](),A=C?0:d.getTimezoneOffset(),o={d:b,dd:e(b),ddd:m.i18n.dayNames[c],dddd:m.i18n.dayNames[c+7],m:x+1,mm:e(x+1),mmm:m.i18n.monthNames[x],mmmm:m.i18n.monthNames[x+12],yy:String(D).slice(2),yyyy:D,h:s%12||12,hh:e(s%12||12),H:s,HH:e(s),M:y,MM:e(y),s:B,ss:e(B),l:e(w,3),L:e(w>99?Math.round(w/10):w),t:s<12?"a":"p",tt:s<12?"am":"pm",T:s<12?"A":"P",TT:s<12?"AM":"PM",Z:C?"UTC":(String(d).match(f)||[""]).pop().replace(g,""),o:(A>0?"-":"+")+e(Math.floor(Math.abs(A)/60)*100+Math.abs(A)%60,4),S:["th","st","nd","rd"][b%10>3?0:(b%100-b%10!=10)*b%10]};return z.replace(h,function(i){return i in o?o[i]:i.slice(1,i.length-1)})}}();Control.DateFormat.masks={"default":"ddd, mmm dd, yyyy h:MM TT",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",shortDateTime:"mm/dd/yyyy h:MM TT",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};Control.DateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(c,d){return Control.DateFormat(this,c,d)};Date.prototype.parseRFC3339=function(h){var g=/(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;if(h.toString().match(new RegExp(g))){var d=h.match(new RegExp(g));var f=0;this.setUTCDate(1);this.setUTCFullYear(parseInt(d[1],10));this.setUTCMonth(parseInt(d[3],10)-1);this.setUTCDate(parseInt(d[5],10));this.setUTCHours(parseInt(d[7],10));this.setUTCMinutes(parseInt(d[9],10));this.setUTCSeconds(parseInt(d[11],10));if(d[12]){this.setUTCMilliseconds(parseFloat(d[12])*1000)}else{this.setUTCMilliseconds(0)}if(d[13]!="Z"){f=(d[15]*60)+parseInt(d[17],10);f*=((d[14]=="-")?-1:1);this.setTime(this.getTime()-f*60*1000)}}else{this.setTime(Date.parse(h))}return this};var DataModel=function DataModel$(){};DataModel.Constants={};DataModel.User={};DataModel.Folders={};DataModel.Suggestions={};DataModel.ActionTypes={};DataModel.UserSettings;DataModel.onDataChangedHandlers={};DataModel.timeStamp="/Date(0)/";DataModel.Init=function DataModel$Init(c,d){this.processConstants($.parseJSON(c));this.processUserData($.parseJSON(d))};DataModel.Close=function DataModel$Close(){Service.Close();DataModel.UserSettings.Save()};DataModel.AddDataChangedHandler=function(d,c){this.onDataChangedHandlers[d]=c};DataModel.RemoveDataChangedHandler=function(b){delete this.onDataChangedHandlers[b]};DataModel.Refresh=function DataModel$Refresh(d){var c=DataModel.UserSettings.ViewState;Service.GetResource(Service.UsersResource,null,function(a){DataModel.processUserData(a.result);DataModel.UserSettings.ViewState=c;DataModel.restoreSelection()})};DataModel.FindItem=function DataModel$FindItem(f){if(f!=null){var d=DataModel.Folders[f];if(d!=null){return d}for(id in DataModel.Folders){d=DataModel.Folders[id];var e=d.Items[f];if(e!=null){return e}}}return null};DataModel.FindActionType=function DataModel$FindActionType(c){if(c!=null){var d=DataModel.ActionTypes[c];if(d!=null){return d}}return null};DataModel.FindLocation=function DataModel$FindLocation(g,l){for(id in DataModel.Folders){var h=DataModel.Folders[id];if(h.ItemTypeID==ItemTypes.Location){for(id in h.Items){var i=h.Items[id];if(i.ItemTypeID==ItemTypes.Location){var k=i.GetFieldValue(FieldNames.LatLong);if(l!=null&&k!=null){if(l==k){return i}}else{var j=i.GetFieldValue(FieldNames.Address);if(g==j){return i}}}}}}return null};DataModel.FindContact=function DataModel$FindContact(j,f){for(id in DataModel.Folders){var g=DataModel.Folders[id];if(g.ItemTypeID==ItemTypes.Contact){for(id in g.Items){var h=g.Items[id];if(h.ItemTypeID==ItemTypes.Contact){var i=h.GetFieldValue(FieldNames.FacebookID);if(f!=null&&i!=null){if(f==i){return h}}else{if(j==h.Name){return h}}}}}}return null};DataModel.GetItems=function DataModel$GetItems(j,n,h){var m={};var i=(typeof(j)=="object")?j:DataModel.Folders[j];if(i!=undefined){if(h!=true){for(var k in i.Items){var l=i.Items[k];if(l.ParentID==n&&l.IsList){m[k]=i.Items[k]}}}for(var k in i.Items){var l=i.Items[k];if(l.ParentID==n&&!l.IsList){m[k]=i.Items[k]}}}return m};DataModel.InsertItem=function DataModel$InsertItem(q,m,k,n,j,l){if(q!=null&&q.Name!=null){var r=Service.ItemsResource;if(m==null){r=Service.FoldersResource}else{if(m.IsFolder()){q.FolderID=m.ID;q.ParentID=null;q.ItemTypeID=(q.ItemTypeID==null)?m.ItemTypeID:q.ItemTypeID}else{if(m.IsList!=null&&m.IsList){q.FolderID=m.FolderID;q.ParentID=m.ID;q.ItemTypeID=(q.ItemTypeID==null)?m.ItemTypeID:q.ItemTypeID}else{return false}}}if(k==null){if(m==null){var o=DataModel.FoldersMap.itemAt(-1);q.SortOrder=(o==null)?1000:o.SortOrder+1000}else{var p=ItemMap.itemAt(m.GetItems(),-1);q.SortOrder=(p==null)?1000:p.SortOrder+1000}}if(q.ID==null){q.ID=Math.uuid()}delete q.Created;if(m==null){q=DataModel.addFolder(q,j)}else{m.addItem(q,j)}Service.InsertResource(r,q,function(b){var a=b.result;q.update(a,null);if(l!=null){l(a)}});return true}return false};DataModel.InsertFolder=function DataModel$InsertFolder(f,d,e){return DataModel.InsertItem(f,null,d,e)};DataModel.UpdateItem=function DataModel$UpdateItem(h,j,f){if(h!=null&&j!=null){h.update(j,f);j.LastModified=DataModel.timeStamp;var i=(h.IsFolder())?Service.FoldersResource:Service.ItemsResource;var g=[h,j];if(i==Service.FoldersResource){g=[h.Copy(),j]}Service.UpdateResource(i,h.ID,g,function(a){var b=a.result;var c=h.update(b,null)});return true}return false};DataModel.DeleteItem=function DataModel$DeleteItem(l,j){if(l!=null){if(l.IsFolder()){DataModel.FoldersMap.remove(l);DataModel.fireDataChanged()}else{var o=l.GetParent();if(o!=null&&o.ItemTypeID==ItemTypes.Reference){l.GetFolder().ItemsMap.remove(l)}else{if(j!=null){var i=j.IsFolder()?j.ID:j.FolderID;var k=j.IsFolder()?null:j.ID;l.GetFolder().ItemsMap.remove(l);DataModel.deleteReferences(l.ID);DataModel.fireDataChanged(i,k)}else{var m=l.selectNextItem();var n=(m==null)?null:m.ID;l.GetFolder().ItemsMap.remove(l);DataModel.deleteReferences(l.ID);DataModel.fireDataChanged(l.FolderID,n)}}}var p=(l.IsFolder())?Service.FoldersResource:Service.ItemsResource;Service.DeleteResource(p,l.ID,l,function(b){var a=b.result});return true}return false};DataModel.GetSuggestions=function DataModel$GetSuggestions(h,e,f){var g={};if(e==null){e=DataModel.User}g.EntityID=e.ID;g.FieldName=f;g.EntityType=EntityTypes.User;if(e.hasOwnProperty("ItemTypeID")){g.EntityType=(e.hasOwnProperty("FolderID"))?EntityTypes.Item:EntityTypes.Folder}Service.InsertResource(Service.SuggestionsResource,g,function(a){var b=a.result;if(b.length>0){DataModel.SuggestionsRetrieved=new Date()}DataModel.processSuggestions(b);if(h!=null){h(DataModel.Suggestions)}})};DataModel.SelectSuggestion=function DataModel$SelectSuggestion(j,h,g){h=(h==null)?Reasons.Chosen:h;var i=$.extend({},j);i.TimeSelected=DataModel.timeStamp;i.ReasonSelected=h;var f=[j,i];Service.UpdateResource(Service.SuggestionsResource,j.ID,f,function(a){var b=a.result;if(g!=null){g(i)}})};DataModel.RemoveSuggestion=function DataModel$RemoveSuggestion(d){var c=DataModel.Suggestions[d.GroupID];if(c!=null){delete c.Suggestions[d.ID]}};DataModel.fireDataChanged=function(e,g){if(DataModel.UserSettings.GetFolder(e)==null){for(var h in DataModel.onDataChangedHandlers){var f=DataModel.onDataChangedHandlers[h];if(typeof(f)=="function"){f(e,g)}}}};DataModel.getFolder=function(d){var c=DataModel.Folders[d];if(c==null){c=DataModel.UserSettings.GetFolder(d)}return c};DataModel.addFolder=function(d,c){d=Folder.Extend(d);if(d.ItemsMap==null){d.ItemsMap=new ItemMap([]);d.Items=d.ItemsMap.Items}DataModel.FoldersMap.append(d);if(c===undefined){DataModel.fireDataChanged(d.ID)}else{if(c!=null){DataModel.fireDataChanged(c.FolderID,c.ID)}}return d};DataModel.deleteReferences=function(n){for(var h in DataModel.Folders){var i=DataModel.Folders[h];for(var l in i.Items){var m=i.Items[l];if(m.ItemTypeID==ItemTypes.Reference){for(var k in m.FieldValues){var j=m.FieldValues[k];if(j.FieldName==FieldNames.EntityRef&&j.Value==n){m.GetFolder().ItemsMap.remove(m)}}}}}};DataModel.processConstants=function DataModel$processConstants(r){var i={};for(var s in r){i[s]=r[s]}var p=i.ItemTypes;for(var n in p){var o=ItemType.Extend(p[n]);var m={};for(var q in o.Fields){var j=o.Fields[q];j.ClassName="fn-"+j.Name.toLowerCase();j.Class=j.ClassName+" dt-"+j.DisplayType.toLowerCase();m[j.Name]=j}o.Fields=m;p[n]=o}i.ItemTypesMap=new ItemMap(p);i.ItemTypes=i.ItemTypesMap.Items;i.PrioritiesByName={};for(var n in i.Priorities){var t=i.Priorities[n];i.PrioritiesByName[t.Name]=t}DataModel.Constants=i};DataModel.processUserData=function DataModel$processUserData(e){var h={};for(var f in e){h[f]=e[f]}var g={};g.ID=h.ID;g.Name=h.Name;g.Email=h.Email;g.CreateDate=h.CreateDate;DataModel.User=g;DataModel.processFolders(h.Folders);DataModel.processActionTypes(DataModel.Constants.ActionTypes)};DataModel.processSuggestions=function DataModel$processSuggestions(t){var x={};var n=[];var r={};var u=0;for(var s in t){var w=t[s];if(w.ParentID==null){var q=w.GroupDisplayName;var p=r[q];if(p===undefined){p=(w.GroupDisplayName==SuggestionTypes.RefreshEntity)?w.GroupDisplayName:"Group_"+(u++).toString();r[q]=p;x[p]={GroupID:p,DisplayName:w.GroupDisplayName,Suggestions:{}}}w.GroupID=p;x[p].Suggestions[w.ID]=w}else{n.push(w)}}for(s in n){var i=n[s];for(p in x){var o=x[p];var v=o.Suggestions[i.ParentID];if(v!=null){if(v.Suggestions==null){v.Suggestions={}}v.Suggestions[i.ID]=i;break}}}DataModel.Suggestions=x};DataModel.processFolders=function DataModel$processFolders(k){var j,p;for(var l in k){k[l]=Folder.Extend(k[l]);var m=k[l].Items;for(var n in m){m[n]=Item.Extend(m[n])}k[l].ItemsMap=new ItemMap(m);k[l].Items=k[l].ItemsMap.Items;if(k[l].Name==SystemFolders.Client){j=l}if(k[l].Name==SystemFolders.WebClient){p=l}}var i=k.splice(j,1)[0];if(p==null){DataModel.UserSettings=new UserSettings(i);Service.InsertResource(Service.FoldersResource,{Name:SystemFolders.WebClient,ItemTypeID:ItemTypes.NameValue,SortOrder:0},function(a){var b=a.result;b=Folder.Extend(b);DataModel.UserSettings=new UserSettings(i,b)})}else{if(p>j){p--}var o=k.splice(p,1)[0];DataModel.UserSettings=new UserSettings(i,o)}DataModel.FoldersMap=new ItemMap(k);DataModel.Folders=DataModel.FoldersMap.Items};DataModel.processActionTypes=function DataModel$processActionTypes(c){var c={};for(var d in ActionTypes){c[d]=ActionType.Extend({Name:ActionTypes[d],ID:ActionTypes[d]})}DataModel.ActionTypesMap=new ItemMap(c);DataModel.ActionTypes=DataModel.ActionTypesMap.Items};DataModel.restoreSelection=function DataModel$restoreSelection(f){if(f===undefined&&DataModel.UserSettings!=null){f=DataModel.UserSettings.ViewState.SelectedItem}if(f!=null){var e=DataModel.FindItem(f);if(e!=null){DataModel.fireDataChanged(e.FolderID,e.ID);return}}var d=DataModel.UserSettings.ViewState.SelectedFolder;if(d!=null){DataModel.fireDataChanged(d);return}DataModel.fireDataChanged()};function Folder(){}Folder.Extend=function Folder$Extend(b){return $.extend(new Folder(),b)};Folder.prototype.Copy=function(){var b=$.extend(new Folder(),this);b.Items={};b.ItemsMap={};return b};Folder.prototype.IsFolder=function(){return true};Folder.prototype.IsDefault=function(){var b=DataModel.UserSettings.GetDefaultList(this.ItemTypeID);if(b!=null){return(b.IsFolder())?(this.ID==b.ID):(this.ID==b.FolderID)}return false};Folder.prototype.IsSelected=function(){return DataModel.UserSettings.IsFolderSelected(this.ID)};Folder.prototype.IsExpanded=function(){return DataModel.UserSettings.IsFolderExpanded(this.ID)};Folder.prototype.Expand=function(b){DataModel.UserSettings.ExpandFolder(this.ID,b)};Folder.prototype.GetItemType=function(){return DataModel.Constants.ItemTypes[this.ItemTypeID]};Folder.prototype.GetItems=function(b){return DataModel.GetItems(this,null,b)};Folder.prototype.GetItem=function(b){return this.Items[b]};Folder.prototype.GetItemByName=function(e,f){for(id in this.Items){var d=this.Items[id];if(d.Name==e){if(f===undefined||d.ParentID==f){return d}}}return null};Folder.prototype.GetItemByValue=function(f,e){for(id in this.Items){var d=this.Items[id];if(d.ItemTypeID==ItemTypes.NameValue||d.ItemTypeID==ItemTypes.Reference){if(f==d.GetFieldValue(FieldNames.Value)&&(e===undefined||d.ParentID==e)){return d}}}return null};Folder.prototype.GetSelectedItem=function(){for(id in this.Items){if(DataModel.UserSettings.IsItemSelected(id)==true){return this.Items[id]}}return null};Folder.prototype.InsertItem=function(h,f,g,e){return DataModel.InsertItem(h,this,f,g,e)};Folder.prototype.Update=function(b){return DataModel.UpdateItem(this,b)};Folder.prototype.Delete=function(){return DataModel.DeleteItem(this)};Folder.prototype.addItem=function(f,d){f=Item.Extend(f);if(this.ItemsMap==null){this.ItemsMap=new ItemMap([f]);this.Items=this.ItemsMap.Items}else{this.ItemsMap.append(f)}if(d===undefined){var e=(f.IsList)?f.ID:f.ID;DataModel.fireDataChanged(this.ID,e)}else{if(d!=null){DataModel.fireDataChanged(d.FolderID,d.ID)}}};Folder.prototype.update=function(b){if(this.ID==b.ID){b=Folder.Extend(b);b.ItemsMap=this.ItemsMap;b.Items=this.ItemsMap.Items;b.FolderUsers=this.FolderUsers;DataModel.FoldersMap.update(b);DataModel.Folders=DataModel.FoldersMap.Items;DataModel.fireDataChanged(this.ID);return true}return false};function Item(){}Item.Extend=function Item$Extend(b){return $.extend(new Item(),b)};Item.prototype.Copy=function(){var d=this.GetFolder();var c=(d==null)?this:d.GetItem(this.ID);return $.extend(true,new Item(),(c==null)?this:c)};Item.prototype.IsFolder=function(){return false};Item.prototype.IsDefault=function(){var b=DataModel.UserSettings.GetDefaultList(this.ItemTypeID);if(b!=null){return(this.ID==b.ID)}return false};Item.prototype.Select=function(){return DataModel.UserSettings.Selection(this.FolderID,this.ID)};Item.prototype.IsSelected=function(b){return DataModel.UserSettings.IsItemSelected(this.ID,b)};Item.prototype.GetFolder=function(){return(DataModel.getFolder(this.FolderID))};Item.prototype.GetParent=function(){return(this.ParentID==null)?null:this.GetFolder().Items[this.ParentID]};Item.prototype.GetParentContainer=function(){return(this.ParentID==null)?this.GetFolder():this.GetParent()};Item.prototype.GetItemType=function(){return DataModel.Constants.ItemTypes[this.ItemTypeID]};Item.prototype.GetItems=function(b){return DataModel.GetItems(this.FolderID,this.ID,b)};Item.prototype.InsertItem=function(h,f,g,e){return DataModel.InsertItem(h,this,f,g,e)};Item.prototype.Update=function(d,c){return DataModel.UpdateItem(this,d,c)};Item.prototype.Delete=function(b){return DataModel.DeleteItem(this,b)};Item.prototype.HasField=function(b){return this.GetItemType().HasField(b)};Item.prototype.GetField=function(b){return this.GetItemType().Fields[b]};Item.prototype.GetFields=function(){return this.GetItemType().Fields};Item.prototype.Refresh=function(){var b=this;Service.GetResource(Service.ItemsResource,this.ID,function(d){var a=d.result;if(a!=null){b.update(a,null)}})};Item.prototype.GetFieldValue=function(f,h){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){return this.Name}for(var i in this.FieldValues){var g=this.FieldValues[i];if(g.FieldName==f.Name){if(g.Value!=null&&f.FieldType==FieldTypes.Guid){var j=DataModel.FindItem(g.Value);if(j!=null){return j}}if(f.FieldType==FieldTypes.Boolean){if(typeof(g.Value)=="string"){g.Value=(g.Value.toLowerCase()=="true")}}return g.Value}}if(f.FieldType=="Boolean"){return false}return null}return undefined};Item.prototype.SetFieldValue=function(f,j){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){this.Name=j;return true}if(this.FieldValues==null){this.FieldValues=[]}var i=false;for(var h in this.FieldValues){var g=this.FieldValues[h];if(g.FieldName==f.Name){g.Value=j;i=true;break}}if(!i){this.FieldValues=this.FieldValues.concat({FieldName:f.Name,ItemID:this.ID,Value:j})}return true}return false};Item.prototype.AddReference=function(g,h,k){if(typeof(g)=="string"){g=this.GetField(g)}if(g!=null&&this.HasField(g.Name)&&g.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(g);if(j!=null){if(k==true){return this.replaceReference(j,h)}else{return this.addReference(j,h)}}else{var l=this;var i={Name:g.Name,IsList:true,ItemTypeID:ItemTypes.Reference,FolderID:l.FolderID,ParentID:l.ID,UserID:l.UserID};Service.InsertResource(Service.ItemsResource,i,function(b){var a=b.result;l.addItem(a,null);a=DataModel.FindItem(a.ID);l.addReference(a,h);var c=$.extend({},l);c.SetFieldValue(g.Name,a.ID);l.Update(c)})}return true}return false};Item.prototype.RemoveReferences=function(f){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)&&f.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(f);if(j!=null&&j.IsList){var i=j.GetItems();for(var g in i){var h=i[g];h.Delete()}}return true}return false};Item.prototype.GetActionType=function(){var d=this.GetFieldValue(this.GetField(FieldNames.ActionType));if(d==null){d=ActionTypes.Default}var c=DataModel.FindActionType(d);return c};Item.prototype.GetLocation=function(){var f=this.GetFieldValue(this.GetField(FieldNames.Locations));if(f!=null){var e=DataModel.GetItems(f.FolderID,f.ID,true);for(var d in e){return e[d].GetFieldValue(e[d].GetField(FieldNames.EntityRef))}}return null};Item.prototype.GetContact=function(){var f=this.GetFieldValue(this.GetField(FieldNames.Contacts));if(f!=null){var e=DataModel.GetItems(f.FolderID,f.ID,true);for(var d in e){return e[d].GetFieldValue(e[d].GetField(FieldNames.EntityRef))}}return null};Item.prototype.GetPhoneNumber=function(){var c=this.GetLocation();if(c==null){c=this.GetContact()}if(c!=null){var d=c.GetFieldValue(c.GetField(FieldNames.Phone));d=d.replace(/[^0-9]+/g,"");return d}return null};Item.prototype.GetMapLink=function(){var g=this.GetLocation();if(g==null){g=this.GetContact()}if(g!=null){var h=g.GetFieldValue(FieldNames.WebLinks);if(h!=null&&h.length>0){var j=new LinkArray(h).Links();for(var f in j){var i=j[f];if(i.Name=="Map"&&i.Url!=null){return i}}}}return null};Item.prototype.Complete=function(){var e=this.Copy();e.Status=StatusTypes.Complete;e.SetFieldValue(this.GetField(FieldNames.Complete),true);if(e.HasField(FieldNames.CompletedOn)){e.SetFieldValue(FieldNames.CompletedOn,new Date().format())}this.Update(e,null);var d=this.nextStep();if(d!=null){var f=d.Copy();f.Status=StatusTypes.Active;d.Update(f,null)}};Item.prototype.Skip=function(){var e=this.Copy();e.Status=StatusTypes.Skipped;this.Update(e,null);var d=this.nextStep();if(d!=null){var f=d.Copy();f.Status=StatusTypes.Active;d.Update(f,null)}};Item.prototype.addItem=function(d,c){this.GetFolder().addItem(d,c)};Item.prototype.update=function(f,d){if(this.ID==f.ID){f=Item.Extend(f);var e=this.GetFolder();if(this.FolderID==f.FolderID){e.ItemsMap.update(f);e.Items=e.ItemsMap.Items}else{e.ItemsMap.remove(this);f.GetFolder().ItemsMap.append(f)}if(d===undefined){DataModel.fireDataChanged(this.FolderID,this.ID)}else{if(d!=null){DataModel.fireDataChanged(this.FolderID,d.ID)}}return true}return false};Item.prototype.selectNextItem=function(){var h=this.GetParent();var i=(h==null)?this.GetFolder().GetItems():h.GetItems();var f=ItemMap.indexOf(i,this.ID);var g=ItemMap.itemAt(i,f+1);if(g!=null){return g}else{if(f==0){if(h!=null){return h}}else{var j=ItemMap.itemAt(i,f-1);if(j!=null){return j}}}return null};Item.prototype.addReference=function(f,e){if(f.IsList){var d=Item.Extend({Name:e.Name,ItemTypeID:ItemTypes.Reference,FolderID:f.FolderID,ParentID:f.ID,UserID:f.UserID});d.SetFieldValue(FieldNames.EntityRef,e.ID);d.SetFieldValue(FieldNames.EntityType,EntityTypes.Item);f.InsertItem(d,null,null,null);return true}return false};Item.prototype.replaceReference=function(k,j){if(k.IsList){var i=k.GetItems();for(var g in i){var h=i[g];var l=h.Copy();l.SetFieldValue(FieldNames.EntityRef,j.ID);h.Update(l,k.GetParent());return true}return this.addReference(k,j)}return false};Item.prototype.nextStep=function(){var g=this.GetParent();var h=(g==null)?this.GetFolder().GetItems():g.GetItems();var e=ItemMap.indexOf(h,this.ID);var f=ItemMap.itemAt(h,e+1);return f};function ActionType(){}ActionType.Extend=function ActionType$Extend(b){return $.extend(new ActionType(),b)};ActionType.prototype.Copy=function(){var b=$.extend(new ActionType(),this);return b};ActionType.prototype.GetSteps=function(n,o){if(o===undefined){o=StatusTypes.Active}var p={};for(var k in DataModel.Folders){var j=DataModel.Folders[k];for(var m in j.Items){var l=j.Items[m];if(l.ItemTypeID==ItemTypes.Step){var i=l.GetActionType();if(i===this){if(l.Status==o){p[l.ID]=l}if(!l.GetFieldValue(l.GetField(FieldNames.Complete))){p[l.ID]=l}}}}}return p};function ItemType(){}ItemType.Extend=function ItemType$Extend(b){return $.extend(new ItemType(),b)};ItemType.prototype.HasField=function(b){return(this.Fields.hasOwnProperty(b))};function ItemMap(b){this.array=b;this.updateMap()}ItemMap.prototype.updateMap=function(){this.Items={};for(var b in this.array){if(this.array[b].hasOwnProperty("ID")){this.Items[this.array[b].ID]=this.array[b]}else{throw ItemMap.errorMustHaveID}}};ItemMap.prototype.indexOf=function(d){for(var c in this.array){if(this.array[c].ID==d.ID){return c}}return -1};ItemMap.prototype.itemAt=function(b){if(b<0){return this.array[this.array.length-1]}if(b<this.array.length){return this.array[b]}return null};ItemMap.prototype.append=function(b){if(b.hasOwnProperty("ID")){this.array=this.array.concat(b);this.Items[b.ID]=this.array[this.array.length-1]}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.update=function(h){if(h.hasOwnProperty("ID")){var g=this.indexOf(h);var e=this.itemAt(g);if(h.hasOwnProperty("SortOrder")&&e.hasOwnProperty("SortOrder")&&(h.SortOrder!=e.SortOrder)){this.array.splice(g,1);for(var f in this.array){if(this.array[f].hasOwnProperty("SortOrder")&&h.SortOrder<this.array[f].SortOrder){this.array.splice(f,0,h);this.updateMap();return}}this.array.push(h);this.updateMap()}else{this.array[g]=h;this.Items[h.ID]=this.array[g]}}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.remove=function(d){if(d.hasOwnProperty("ID")){var c=this.indexOf(d);if(c>=0){this.array.splice(c,1);delete this.Items[d.ID]}}else{throw ItemMap.errorMustHaveID}};ItemMap.count=function(f){var d=0,e;for(e in f){if(f.hasOwnProperty(e)){d++}}return d};ItemMap.indexOf=function(j,g){var h=-1,f=0;for(var i in j){if(i==g){h=f;break}f++}return h};ItemMap.itemAt=function(h,e){for(var g in h){var f=h[g];if(e--==0){return f}}return(e<0)?f:null};ItemMap.errorMustHaveID="ItemMap requires all items in array to have an ID property.";function LinkArray(b){this.links=[];if(b!=null&&b.length>0){this.links=$.parseJSON(b)}}LinkArray.prototype.Links=function(){return this.links};LinkArray.prototype.ToJson=function(){return JSON.stringify(this.links)};LinkArray.prototype.Remove=function(b){this.links.splice(b,1)};LinkArray.prototype.Add=function(d,e){if(e!=null){this.links.push({Name:e,Url:d});return this.links}var f=d.split(",");if(f.length>1){e=$.trim(f[0]);d=$.trim(f[1]);this.links.push({Name:e,Url:d})}else{this.links.push({Url:d})}return this.links};LinkArray.prototype.ToText=function(){var f="";for(var d in this.links){var e=this.links[d];if(e.hasOwnProperty("Name")){if(e.Name!=null&&e.Name.length>0&&e.Name!=e.Url){f+=e.Name+", "}}f+=e.Url+"\r\n"}return f};LinkArray.prototype.Parse=function(h){var f=h.split(/\r\n|\r|\n/g);for(var e in f){var g=f[e].split(",");if(g.length==1&&g[0].length>0){this.links.push({Url:g[0]})}if(g.length==2){this.links.push({Name:g[0],Url:g[1]})}}};function UserSettings(c,d){this.clientFolder=c;this.webClientFolder=d;this.init(UserSettings.viewStateName,UserSettings.viewStateKey);this.init(UserSettings.preferencesName,UserSettings.preferencesKey)}UserSettings.defaultListsKey="DefaultLists";UserSettings.viewStateName="ViewState";UserSettings.viewStateKey="WebViewState";UserSettings.preferencesName="Preferences";UserSettings.preferencesKey="WebPreferences";UserSettings.prototype.GetFolder=function(b){if(this.clientFolder.ID==b){return this.clientFolder}if(this.webClientFolder.ID==b){return this.webClientFolder}return null};UserSettings.prototype.GetDefaultList=function(i){var g=this.clientFolder.GetItemByName(UserSettings.defaultListsKey);if(g!=null){var f=this.clientFolder.GetItemByValue(i,g.ID);if(f!=null){var j=f.GetFieldValue(FieldNames.EntityRef);if(typeof(j)=="object"){return j}}}var h;for(id in DataModel.Folders){h=DataModel.Folders[id];if(h.ItemTypeID==i){return h}}return h};UserSettings.prototype.Selection=function(c,d){this.ViewState.SelectedFolder=c;this.ViewState.SelectedItem=d};UserSettings.prototype.IsFolderSelected=function(b){return(this.ViewState.SelectedFolder==b)};UserSettings.prototype.IsItemSelected=function(f,d){if(d==true){var e=DataModel.FindItem(this.ViewState.SelectedItem);if(e!=null&&e.ParentID==f){return true}}return(this.ViewState.SelectedItem==f)};UserSettings.prototype.ExpandFolder=function(d,c){if(this.ViewState.ExpandedFolders==null){this.ViewState.ExpandedFolders={}}if(c==true){this.ViewState.ExpandedFolders[d]=true}else{delete this.ViewState.ExpandedFolders[d]}};UserSettings.prototype.IsFolderExpanded=function(b){return(this.ViewState.ExpandedFolders!=null&&this.ViewState.ExpandedFolders[b]==true)};UserSettings.prototype.Save=function(){var c={};for(var d in DataModel.Folders){if(DataModel.Folders[d].IsExpanded()){c[d]=true}}this.ViewState.ExpandedFolders=c;this.update(UserSettings.viewStateName,UserSettings.viewStateKey)};UserSettings.prototype.UpdateTheme=function(b){if(this.Preferences.Theme!=b){this.Preferences.Theme=b;this.update(UserSettings.preferencesName,UserSettings.preferencesKey);Service.ChangeTheme(b)}};UserSettings.prototype.init=function(g,e){var f="item"+g;if(this.webClientFolder!=null){this[f]=this.webClientFolder.GetItemByName(e,null)}if(this[f]==null){this[g]={};if(this.webClientFolder!=null){this.webClientFolder.InsertItem(Item.Extend({Name:e,ItemTypeID:ItemTypes.NameValue}),null,null,null)}}else{var h=this[f].GetFieldValue(FieldNames.Value);this[g]=(h==null)?{}:$.parseJSON(h)}};UserSettings.prototype.update=function(g,e){if(this.webClientFolder!=null){var f="item"+g;if(this[f]==null){this[f]=this.webClientFolder.GetItemByName(e,null)}var h=this[f].Copy();h.SetFieldValue(FieldNames.Value,JSON.stringify(this[g]));this[f].Update(h)}};var ItemTypes={Category:"00000000-0000-0000-0000-000000000007",Activity:"00000000-0000-0000-0000-000000000001",Step:"00000000-0000-0000-0000-000000000002",Contact:"00000000-0000-0000-0000-000000000003",Location:"00000000-0000-0000-0000-000000000004",System:"00000000-0000-0000-0000-000000000000",Reference:"00000000-0000-0000-0000-000000000005",NameValue:"00000000-0000-0000-0000-000000000006"};var FieldNames={Name:"Name",Description:"Description",Repeat:"Repeat",Active:"Active",Skip:"Skip",Complete:"Complete",CompletedOn:"CompletedOn",DueDate:"DueDate",EndDate:"EndDate",ActionType:"ActionType",Birthday:"Birthday",Address:"Address",WebLink:"WebLink",WebLinks:"WebLinks",Email:"Email",Phone:"Phone",HomePhone:"HomePhone",WorkPhone:"WorkPhone",Amount:"Amount",Cost:"Cost",ItemTags:"ItemTags",EntityRef:"EntityRef",EntityType:"EntityType",Contacts:"Contacts",Locations:"Locations",Value:"Value",Category:"Category",LatLong:"LatLong",FacebookID:"FacebookID",Sources:"Sources",Gender:"Gender",Picture:"Picture"};var EntityTypes={User:"User",Folder:"Folder",Item:"Item"};var FieldTypes={String:"String",Boolean:"Boolean",Integer:"Integer",DateTime:"DateTime",Phone:"Phone",Email:"Email",Url:"Url",Address:"Address",Currency:"Currency",TagIDs:"TagIDs",Guid:"Guid",JSON:"JSON"};var DisplayTypes={Hidden:"Hidden",Text:"Text",TextArea:"TextArea",Checkbox:"Checkbox",DatePicker:"DatePicker",DateTimePicker:"DateTimePicker",Phone:"Phone",Email:"Email",Link:"Link",Currency:"Currency",Address:"Address",Priority:"Priority",TagList:"TagList",Reference:"Reference",Contact:"Contact",ContactList:"ContactList",LocationList:"LocationList",LinkArray:"LinkArray"};var SuggestionTypes={ChooseOne:"ChooseOne",ChooseOneSubject:"ChooseOneSubject",ChooseMany:"ChooseMany",ChooseManyWithChildren:"ChooseManyWithChildren",GetFBConsent:"GetFBConsent",GetGoogleConsent:"GetGoogleConsent",GetADConsent:"GetADConsent",NavigateLink:"NavigateLink",RefreshEntity:"RefreshEntity"};var Reasons={Chosen:"Chosen",Ignore:"Ignore",Like:"Like",Dislike:"Dislike"};var Sources={Directory:"Directory",Facebook:"Facebook",Local:"Local"};var SystemFolders={Client:"$Client",WebClient:"$WebClient"};var SystemUsers={System:"00000000-0000-0000-0000-000000000001",User:"00000000-0000-0000-0000-000000000002"};var ActionTypes={Call:"Call",SendEmail:"Email",Find:"Find",Schedule:"Schedule on calendar",Map:"Map",TextMessage:"Text",Default:"Uncategorized"};var StatusTypes={Active:"Active",Complete:"Complete",Skipped:"Skipped"};function ActionTypeList(b){this.onSelectionChangedHandlers={};this.init(b)}ActionTypeList.prototype.init=function(b){this.actionTypes=b;this.$element=null};ActionTypeList.prototype.addSelectionChangedHandler=function(d,c){this.onSelectionChangedHandlers[d]=c};ActionTypeList.prototype.removeSelectionChangedHandler=function(b){this.onSelectionChangedHandlers[b]=undefined};ActionTypeList.prototype.fireSelectionChanged=function(d){for(var f in this.onSelectionChangedHandlers){var e=this.onSelectionChangedHandlers[f];if(typeof(e)=="function"){e(d)}}};ActionTypeList.prototype.render=function(h,k){if(k!=null){this.init(k)}h.empty();this.$element=$('<ul class="nav nav-pills nav-stacked" />').appendTo(h);var g=null;for(var l in this.actionTypes){var i=this.actionTypes[l];var j=Browser.IsMobile()?"":i.Name;$actionType=$("<li><a><strong>&nbsp;"+j+"</strong></a></li>").appendTo(this.$element);$actionType.data("control",this);$actionType.data("item",i);$actionType.click(function(){Control.get(this).actionTypeClicked($(this))});$actionType.find("strong").prepend(Control.Icons.forActionType(i));if(this.currentActionType==null){this.currentActionType=i;g=$actionType}if(this.currentActionType==i){g=$actionType}}this.select(g,this.currentActionType);this.fireSelectionChanged(this.currentActionType)};ActionTypeList.prototype.actionTypeClicked=function(c){var d=c.data("item");this.select(c,d);this.currentActionType=d;this.fireSelectionChanged(d)};ActionTypeList.prototype.select=function(c,d){this.deselect();c.addClass("active")};ActionTypeList.prototype.deselect=function(){this.$element.find("li").removeClass("active")};var NextStepsPage=function NextStepsPage$(){this.dataModel=null;this.stepList=null;this.actionTypeList=null};NextStepsPage.Init=function NextStepsPage$Init(b){NextStepsPage.dataModel=b;NextStepsPage.checkBrowser();NextStepsPage.dataModel.AddDataChangedHandler("nextsteps",NextStepsPage.ManageDataChange);NextStepsPage.$element=$(".dashboard-region");NextStepsPage.$center=$(".dashboard-center");NextStepsPage.$left=$(".dashboard-left");NextStepsPage.actionTypeList=new ActionTypeList(b.ActionTypes);NextStepsPage.actionTypeList.addSelectionChangedHandler("nextsteps",NextStepsPage.ManageActionType);NextStepsPage.stepManager=new StepManager(NextStepsPage,NextStepsPage.$center);NextStepsPage.stepManager.addSelectionChangedHandler("nextsteps",NextStepsPage.ManageActionType);NextStepsPage.showManager(NextStepsPage.stepManager);$(window).bind("load",NextStepsPage.resize);$(window).bind("resize",NextStepsPage.resize);$(window).bind("unload",NextStepsPage.Close);$logo=$(".brand a");$logo.unbind("click");$logo.click(function(){NextStepsPage.dataModel.Refresh();return false});NextStepsPage.showHeaderOptions()};NextStepsPage.Close=function NextStepsPage$Close(b){$(".header-icons").hide();NextStepsPage.dataModel.Close()};NextStepsPage.ManageDataChange=function NextStepsPage$ManageDataChange(c,d){NextStepsPage.actionTypeList.render(NextStepsPage.$left,NextStepsPage.dataModel.ActionTypes)};NextStepsPage.ManageActionType=function NextStepsPage$ManageActionType(b){NextStepsPage.showManager(NextStepsPage.stepManager);NextStepsPage.stepManager.selectActionType(b)};NextStepsPage.render=function NextStepsPage$render(c,d){NextStepsPage.actionTypeList.render(NextStepsPage.$left)};NextStepsPage.showHeaderOptions=function NextStepsPage$showHeaderOptions(){$dropdown=$(".navbar-fixed-top .pull-right .dropdown-menu");$menuitem=$dropdown.find(".option-refresh");$menuitem.show();$menuitem.click(function(b){NextStepsPage.dataModel.Refresh();b.preventDefault()})};NextStepsPage.showManager=function NextStepsPage$showManager(d,c){if(NextStepsPage.currentManager!=d){NextStepsPage.currentManager=d;(d.addWell==true)?NextStepsPage.$center.addClass("well"):NextStepsPage.$center.removeClass("well")}d.show(c)};NextStepsPage.resize=function NextStepsPage$resize(){if(NextStepsPage.resizing){return}NextStepsPage.resizing=true;$(window).unbind("resize",NextStepsPage.resize);var h=$(window).height();var g=$(".navbar-fixed-top").height();var f=$(".navbar-fixed-bottom").height();var e=h-(g+f+30);NextStepsPage.$left.height(e);NextStepsPage.$center.height(e);NextStepsPage.actionTypeList.render(NextStepsPage.$left);$(window).bind("resize",NextStepsPage.resize);NextStepsPage.resizing=false};NextStepsPage.checkBrowser=function NextStepsPage$checkBrowser(){if(Browser.IsMSIE()&&Browser.MSIE_Version()<9){var c="We're Sorry!";var d="This application currently requires an HTML5-compatible browser. We encourage you to try using the application with the latest version of Internet Explorer, Chrome, or FireFox.<br/>Thank you";Control.alert(d,c)}};function StepList(b){this.parentControl=b;this.$element=null;this.listView=new ListView(this)}StepList.prototype.render=function(d,e,f){if(this.$element==null){this.$element=d}this.listView.render(this.$element,e,f)};StepList.prototype.selectItem=function(b){this.parentControl.fireSelectionChanged(b)};function ListView(b){this.parentControl=b;this.$element=null;this.list=null}ListView.prototype.hide=function(){if(this.$element!=null){this.$element.hide()}};ListView.prototype.show=function(){if(this.$element!=null){this.$element.show()}};ListView.prototype.render=function(f,i,h){if(i==null){return}if(this.$element==null){this.$element=$('<ul class="nav nav-list" />').appendTo(f)}this.hide();this.$element.empty();if(h!=null){this.$element.css("max-height",h)}if(this.renderListItems(i.GetSteps())>0){this.show();var g=this.$element.find("li.selected");if(g.offset()!=null){var j=g.offset().top-h+this.$element.scrollTop();if(j>0){this.$element.animate({scrollTop:j},500)}}}};ListView.prototype.renderListItems=function(t){var s=0;for(var q in t){var r=t[q];var o=$("<li />").appendTo(this.$element);o.data("control",this);o.data("item",r);var n=$('<a class="form-inline" />').appendTo(o);if(Browser.IsMobile()){this.renderToolbar(o,r)}else{var l=Control.Icons.completeBtn(r).appendTo(n);l.addClass("pull-right");var p=Control.Icons.skipBtn(r).appendTo(n);p.addClass("pull-right");var m=Control.DeferButton(n,r);m.addClass("pull-right");var k=this.actionButton(r);if(k!=null){k.appendTo(n);k.addClass("pull-right")}}this.renderNameField(n,r);o.bind("click",function(a){if($(this).hasClass("ui-sortable-helper")||$(a.srcElement).hasClass("dt-checkbox")||$(a.srcElement).hasClass("dropdown-toggle")||$(a.srcElement).parent().hasClass("dropdown-toggle")||$(a.srcElement).hasClass("dt-email")){return}var b=$(this).data("item");Control.get(this).parentControl.selectItem(b)});this.renderFields(n,r);s++}return s};ListView.prototype.renderToolbar=function(k,n){var m=$('<div class="btn-toolbar" />').appendTo(k);m.css("height","28px");var j=Control.DeferButton.renderDropdown(m,n);j.addClass("pull-left");var i=$('<a class="btn step-button" />').append(Control.Icons.completeBtn(n)).appendTo(m);i.addClass("pull-left");i.one("click",function(b){var a=i.find("h2");a.click()});var l=$('<a class="btn step-button" />').append(Control.Icons.skipBtn(n)).appendTo(m);l.addClass("pull-left");l.one("click",function(b){var a=l.find("h2");a.click()});var h=this.actionButton(n);if(h!=null){$('<a class="btn step-button" />').append(h).appendTo(m);h.addClass("pull-left");h.one("click",function(b){var a=h.find("h2");a.click()})}};ListView.prototype.renderButtons=function(l,n){var i=$('<div class="well well-tiny"><ul class="nav nav-pills step-button-list" /></div>').appendTo(l);var j=$('<li class="step-button" />').append(Control.Icons.completeBtn(n));j.css("border-top","0px");j.one("click",function(b){var a=j.find("h2");a.click()});i.find("ul").append(j);var m=$('<li class="step-button" />').append(Control.Icons.skipBtn(n));m.css("border-top","0px");m.one("click",function(a){m.find("h2").click()});i.find("ul").append(m);var k=$('<li class="step-button" />').append(Control.Icons.deferBtn(n));k.css("border-top","0px");k.one("click",function(a){k.find("h2").click()});i.find("ul").append(k);var h=$('<li class="step-button" />').append(this.actionButton(n));h.css("border-top","0px");h.one("click",function(a){h.find("h2").click()});i.find("ul").append(h)};ListView.prototype.actionButton=function(f){var d=f.GetActionType();if(d==null){return null}var e=d.Name;switch(e){case ActionTypes.Call:if(f.GetPhoneNumber()!=null){return Control.Icons.callBtn(f)}break;case ActionTypes.Map:if(f.GetMapLink()!=null){return Control.Icons.mapBtn(f)}break}};ListView.prototype.renderNameField=function(g,j){var i=j.GetFields();field=i[FieldNames.Name];var f=$("<br />");f.css("line-height","1px");f.css("font-size","1px");f.css("height","1px");f.appendTo(g);var h=Control.Text.renderLabel(g,j,field).appendTo(g);h.css("margin-top","-5px")};ListView.prototype.renderFields=function(g,k){var h=$("<div />").appendTo(g);var j=k.GetFields();for(var l in j){var i=j[l];this.renderField(h,k,i)}$("<small>&nbsp;</small>").appendTo(h)};ListView.prototype.renderField=function(g,l,k){var h;switch(k.Name){case FieldNames.DueDate:if(l.HasField(FieldNames.EndDate)){var j=l.GetField(FieldNames.EndDate);h=Control.DateTime.renderRange(g,l,k,j,"small")}else{if(l.HasField(FieldNames.Complete)&&l.GetFieldValue(FieldNames.Complete)!=true){h=Control.Text.render(g,l,k,"small","Due on ")}}break;case FieldNames.CompletedOn:if(l.GetFieldValue(FieldNames.Complete)==true){h=Control.Text.render(g,l,k,"small","Completed on ")}break;case FieldNames.Category:h=Control.Text.render(g,l,k,"small");break;case FieldNames.Email:h=Control.Text.renderEmail(g,l,k);break;case FieldNames.Address:var i=l.GetFieldValue(FieldNames.Address);if(i!=l.Name){h=Control.Text.render(g,l,k,"small")}break;default:break}return h};function StepManager(d,c){this.parentControl=d;this.$parentElement=c;this.addWell=false;this.$element=null;this.currentActionType=null;this.currentItem=null;this.views={};this.onSelectionChangedHandlers={};this.stepList=new StepList(this)}StepManager.ListView="fm-list-view";StepManager.prototype.addSelectionChangedHandler=function(d,c){this.onSelectionChangedHandlers[d]=c};StepManager.prototype.removeSelectionChangedHandler=function(b){this.onSelectionChangedHandlers[b]=undefined};StepManager.prototype.fireSelectionChanged=function(e){for(var f in this.onSelectionChangedHandlers){var d=this.onSelectionChangedHandlers[f];if(typeof(d)=="function"){d(e.GetActionType());this.activeView(StepManager.ListView)}}};StepManager.prototype.hide=function(){if(this.$element!=null){this.$element.hide()}};StepManager.prototype.show=function(j){if(this.$element==null){this.$element=$('<div class="manager-folders" />').appendTo(this.$parentElement);var h=$('<ul class="nav nav-tabs" />').appendTo(this.$element);h.data("control",this);var f=$('<li><a data-toggle="tab">List View</a></li>').appendTo(h);f.find("a").attr("href","."+StepManager.ListView);var g=$('<div class="tab-content" />').appendTo(this.$element);var i=$('<div class="tab-pane" />').appendTo(g);i.addClass(StepManager.ListView);this.views[StepManager.ListView]=i;$('a[data-toggle="tab"]').on("shown",function(b){var a=$(b.target).parents(".nav-tabs");Control.get(a).viewChanged($(b.target))})}if(j==true){this.render()}this.$element.show()};StepManager.prototype.render=function(){var h=this.$element.find(".nav-tabs");var g=this.$element.find(".tab-content");h.find("li a:first").empty().append(this.activeListName());var k=this.activeView();var j=this.activeItem();var i=this.views[k];var l=this.$parentElement.outerHeight()-h.outerHeight();if(k==StepManager.ListView){this.stepList.render(i,this.activeList(),l)}h.find('a[href=".'+k+'"]').tab("show")};StepManager.prototype.selectActionType=function(b){this.currentActionType=b;this.currentItem=null;if(this.currentActionType!=null){this.render()}};StepManager.prototype.selectItem=function(b){this.currentItem=b;if(this.currentItem!=null){this.currentActionType=this.currentItem.GetActionType();this.render()}else{this.selectActionType(this.currentActionType)}};StepManager.prototype.activeItem=function(){var f=null;if(this.currentItem!=null){if(this.currentItem.IsList){f=this.currentItem}else{return this.currentItem}}else{if(this.currentActionType!=null){f=this.currentActionType}}if(f!=null){var e=f.GetSteps();for(var d in e){if(!e[d].IsList){this.currentItem=e[d];break}}}return null};StepManager.prototype.activeList=function(){return this.currentActionType};StepManager.prototype.activeListName=function(){var d=this.activeList();if(d!=null){var c=Control.Icons.forActionType(d);return $("<span>&nbsp;"+d.Name+"</span>").prepend(c)}return $("<span>List View</span>")};StepManager.prototype.activeView=function(d){var c=Control.findParent(this,"dataModel").dataModel;if(d===undefined){return StepManager.ListView}else{this.render()}};StepManager.prototype.viewChanged=function(b){this.activeView(b.attr("href").substr(1))};