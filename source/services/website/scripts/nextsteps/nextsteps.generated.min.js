function ActionTypeList(b){this.onSelectionChangedHandlers={};this.init(b)}ActionTypeList.prototype.init=function(b){this.actionTypes=b;this.$element=null};ActionTypeList.prototype.addSelectionChangedHandler=function(d,c){this.onSelectionChangedHandlers[d]=c};ActionTypeList.prototype.removeSelectionChangedHandler=function(b){this.onSelectionChangedHandlers[b]=undefined};ActionTypeList.prototype.fireSelectionChanged=function(d){for(var f in this.onSelectionChangedHandlers){var e=this.onSelectionChangedHandlers[f];if(typeof(e)=="function"){e(d)}}};ActionTypeList.prototype.render=function(e,g){if(g!=null){this.init(g)}e.empty();this.$element=$('<ul class="nav nav-pills nav-stacked" />').appendTo(e);for(var h in this.actionTypes){var f=this.actionTypes[h];$actionType=$("<li><a><strong>&nbsp;"+f.Name+"</strong></a></li>").appendTo(this.$element);$actionType.data("control",this);$actionType.data("item",f);$actionType.click(function(){Control.get(this).actionTypeClicked($(this))})}};ActionTypeList.prototype.actionTypeClicked=function(c){var d=c.data("item");this.select(c,d);this.fireSelectionChanged(d)};ActionTypeList.prototype.select=function(c,d){this.deselect();c.addClass("active")};ActionTypeList.prototype.deselect=function(){this.$element.find("li").removeClass("active")};var NextStepsModel=function NextStepsModel$(){};NextStepsModel.Constants={};NextStepsModel.ActionTypes={};NextStepsModel.Steps={};NextStepsModel.onDataChangedHandlers={};NextStepsModel.timeStamp="/Date(0)/";NextStepsModel.Init=function NextStepsModel$Init(c,d){this.processConstants($.parseJSON(c));this.processNextStepsData($.parseJSON(d))};NextStepsModel.Close=function NextStepsModel$Close(){Service.Close()};NextStepsModel.AddDataChangedHandler=function(d,c){this.onDataChangedHandlers[d]=c};NextStepsModel.RemoveDataChangedHandler=function(b){delete this.onDataChangedHandlers[b]};NextStepsModel.FindItem=function NextStepsModel$FindItem(d){if(d!=null){var c=NextStepsModel.Steps[d];if(c!=null){return c}}return null};NextStepsModel.FindActionType=function NextStepsModel$FindActionType(c){if(c!=null){var d=NextStepsModel.ActionTypes[c];if(d!=null){return d}}return null};NextStepsModel.UpdateItem=function NextStepsModel$UpdateItem(h,j,f){if(h!=null&&j!=null){h.update(j,f);j.LastModified=NextStepsModel.timeStamp;var i=Service.ItemsResource;var g=[h,j];Service.UpdateResource(i,h.ID,g,function(a){var b=a.result;var c=h.update(b,null)});return true}return false};NextStepsModel.fireDataChanged=function(e,g){for(var h in NextStepsModel.onDataChangedHandlers){var f=NextStepsModel.onDataChangedHandlers[h];if(typeof(f)=="function"){f(e,g)}}};NextStepsModel.processConstants=function NextStepsModel$processConstants(r){var i={};for(var s in r){i[s]=r[s]}var p=i.ItemTypes;for(var n in p){var o=ItemType.Extend(p[n]);var m={};for(var q in o.Fields){var j=o.Fields[q];j.ClassName="fn-"+j.Name.toLowerCase();j.Class=j.ClassName+" dt-"+j.DisplayType.toLowerCase();m[j.Name]=j}o.Fields=m;p[n]=o}i.ItemTypesMap=new ItemMap(p);i.ItemTypes=i.ItemTypesMap.Items;i.PrioritiesByName={};for(var n in i.Priorities){var t=i.Priorities[n];i.PrioritiesByName[t.Name]=t}NextStepsModel.Constants=i};NextStepsModel.processNextStepsData=function NextStepsModel$processNextStepsData(j){var i={};for(var k in ActionTypes){i[k]=ActionType.Extend({Name:ActionTypes[k],ID:ActionTypes[k]});i[k].steps=[]}NextStepsModel.ActionTypesMap=new ItemMap(i);NextStepsModel.ActionTypes=NextStepsModel.ActionTypesMap.Items;var n=[];for(var k in j){var m=Item.Extend(j[k]);n[k]=m;var h=m.GetActionType();var l=NextStepsModel.ActionTypes[h.Name].steps.length;NextStepsModel.ActionTypes[h.Name].steps[l++]=m}for(var k in NextStepsModel.ActionTypes){NextStepsModel.ActionTypes[k].StepsMap=new ItemMap(NextStepsModel.ActionTypes[k].steps);NextStepsModel.ActionTypes[k].Steps=NextStepsModel.ActionTypes[k].StepsMap.Items}NextStepsModel.StepsMap=new ItemMap(n);NextStepsModel.Steps=NextStepsModel.StepsMap.Items};function ActionType(){}ActionType.Extend=function ActionType$Extend(b){return $.extend(new ActionType(),b)};ActionType.prototype.Copy=function(){var b=$.extend(new ActionType(),this);b.Steps={};b.StepsMap={};return b};ActionType.prototype.IsActionType=function(){return true};ActionType.prototype.GetSteps=function(){return this.Steps};ActionType.prototype.GetStep=function(b){return this.Steps[b]};ActionType.prototype.GetSelectedItem=function(){for(id in this.Items){if(DataModel.UserSettings.IsItemSelected(id)==true){return this.Items[id]}}return null};function Item(){}Item.Extend=function Item$Extend(b){return $.extend(new Item(),b)};Item.prototype.Copy=function(){var b=NextStepsModel.FindItem(this.ID);return $.extend(true,new Item(),(b==null)?this:b)};Item.prototype.IsActionType=function(){return false};Item.prototype.GetItemType=function(){return NextStepsModel.Constants.ItemTypes[this.ItemTypeID]};Item.prototype.Update=function(d,c){return NextStepsModel.UpdateItem(this,d,c)};Item.prototype.HasField=function(b){return this.GetItemType().HasField(b)};Item.prototype.GetField=function(b){return this.GetItemType().Fields[b]};Item.prototype.GetFields=function(){return this.GetItemType().Fields};Item.prototype.GetActionType=function(){var b=this.GetFieldValue(this.GetField(FieldNames.ActionType));if(b==null){b=NextStepsModel.FindActionType(ActionTypes.Default)}return b};Item.prototype.GetParentContainer=function(){return this.GetActionType()};Item.prototype.Refresh=function(){var b=this;Service.GetResource(Service.ItemsResource,this.ID,function(d){var a=d.result;if(a!=null){b.update(a,null)}})};Item.prototype.GetFieldValue=function(f,h){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){return this.Name}for(var i in this.FieldValues){var g=this.FieldValues[i];if(g.FieldName==f.Name){if(g.Value!=null&&f.FieldType==FieldTypes.Guid){var j=NextStepsModel.FindItem(g.Value);if(j!=null){return j}}if(f.FieldType==FieldTypes.Boolean){if(typeof(g.Value)=="string"){g.Value=(g.Value.toLowerCase()=="true")}}return g.Value}}if(f.FieldType=="Boolean"){return false}return null}return undefined};Item.prototype.SetFieldValue=function(f,j){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){this.Name=j;return true}if(this.FieldValues==null){this.FieldValues=[]}var i=false;for(var h in this.FieldValues){var g=this.FieldValues[h];if(g.FieldName==f.Name){g.Value=j;i=true;break}}if(!i){this.FieldValues=this.FieldValues.concat({FieldName:f.Name,ItemID:this.ID,Value:j})}return true}return false};Item.prototype.AddReference=function(g,h,k){if(typeof(g)=="string"){g=this.GetField(g)}if(g!=null&&this.HasField(g.Name)&&g.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(g);if(j!=null){if(k==true){return this.replaceReference(j,h)}else{return this.addReference(j,h)}}else{var l=this;var i={Name:g.Name,IsList:true,ItemTypeID:ItemTypes.Reference,FolderID:l.FolderID,ParentID:l.ID,UserID:l.UserID};Service.InsertResource(Service.ItemsResource,i,function(b){var a=b.result;l.addItem(a,null);a=NextStepsModel.FindItem(a.ID);l.addReference(a,h);var c=$.extend({},l);c.SetFieldValue(g.Name,a.ID);l.Update(c)})}return true}return false};Item.prototype.RemoveReferences=function(f){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)&&f.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(f);if(j!=null&&j.IsList){var i=j.GetItems();for(var g in i){var h=i[g];h.Delete()}}return true}return false};Item.prototype.addItem=function(d,c){this.GetActionType().addItem(d,c)};Item.prototype.update=function(f,d){if(this.ID==f.ID){f=Item.Extend(f);var e=this.GetActionType();if(e==f.GetActionType()){e.StepsMap.update(f);e.Items=e.StepsMap.Items}else{e.ItemsMap.remove(this);f.GetActionType().ItemsMap.append(f)}if(d===undefined){NextStepsModel.fireDataChanged(e,this.ID)}else{if(d!=null){NextStepsModel.fireDataChanged(e,d.ID)}}return true}return false};Item.prototype.selectNextItem=function(){var h=this.GetParent();var i=(h==null)?this.GetActionType().GetItems():h.GetItems();var f=ItemMap.indexOf(i,this.ID);var g=ItemMap.itemAt(i,f+1);if(g!=null){return g}else{if(f==0){if(h!=null){return h}}else{var j=ItemMap.itemAt(i,f-1);if(j!=null){return j}}}return null};function ItemType(){}ItemType.Extend=function ItemType$Extend(b){return $.extend(new ItemType(),b)};ItemType.prototype.HasField=function(b){return(this.Fields.hasOwnProperty(b))};function ItemMap(b){this.array=b;this.updateMap()}ItemMap.prototype.updateMap=function(){this.Items={};for(var b in this.array){if(this.array[b].hasOwnProperty("ID")){this.Items[this.array[b].ID]=this.array[b]}else{throw ItemMap.errorMustHaveID}}};ItemMap.prototype.indexOf=function(d){for(var c in this.array){if(this.array[c].ID==d.ID){return c}}return -1};ItemMap.prototype.itemAt=function(b){if(b<0){return this.array[this.array.length-1]}if(b<this.array.length){return this.array[b]}return null};ItemMap.prototype.append=function(b){if(b.hasOwnProperty("ID")){this.array=this.array.concat(b);this.Items[b.ID]=this.array[this.array.length-1]}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.update=function(h){if(h.hasOwnProperty("ID")){var g=this.indexOf(h);var e=this.itemAt(g);if(h.hasOwnProperty("SortOrder")&&e.hasOwnProperty("SortOrder")&&(h.SortOrder!=e.SortOrder)){this.array.splice(g,1);for(var f in this.array){if(this.array[f].hasOwnProperty("SortOrder")&&h.SortOrder<this.array[f].SortOrder){this.array.splice(f,0,h);this.updateMap();return}}this.array.push(h);this.updateMap()}else{this.array[g]=h;this.Items[h.ID]=this.array[g]}}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.remove=function(d){if(d.hasOwnProperty("ID")){var c=this.indexOf(d);if(c>=0){this.array.splice(c,1);delete this.Items[d.ID]}}else{throw ItemMap.errorMustHaveID}};ItemMap.count=function(f){var d=0,e;for(e in f){if(f.hasOwnProperty(e)){d++}}return d};ItemMap.indexOf=function(j,g){var h=-1,f=0;for(var i in j){if(i==g){h=f;break}f++}return h};ItemMap.itemAt=function(h,e){for(var g in h){var f=h[g];if(e--==0){return f}}return(e<0)?f:null};ItemMap.errorMustHaveID="ItemMap requires all items in array to have an ID property.";function LinkArray(b){this.links=[];if(b!=null&&b.length>0){this.links=$.parseJSON(b)}}LinkArray.prototype.Links=function(){return this.links};LinkArray.prototype.ToJson=function(){return JSON.stringify(this.links)};LinkArray.prototype.Remove=function(b){this.links.splice(b,1)};LinkArray.prototype.Add=function(d,e){if(e!=null){this.links.push({Name:e,Url:d});return this.links}var f=d.split(",");if(f.length>1){e=$.trim(f[0]);d=$.trim(f[1]);this.links.push({Name:e,Url:d})}else{this.links.push({Url:d})}return this.links};LinkArray.prototype.ToText=function(){var f="";for(var d in this.links){var e=this.links[d];if(e.hasOwnProperty("Name")){if(e.Name!=null&&e.Name.length>0&&e.Name!=e.Url){f+=e.Name+", "}}f+=e.Url+"\r\n"}return f};LinkArray.prototype.Parse=function(h){var f=h.split(/\r\n|\r|\n/g);for(var e in f){var g=f[e].split(",");if(g.length==1&&g[0].length>0){this.links.push({Url:g[0]})}if(g.length==2){this.links.push({Name:g[0],Url:g[1]})}}};var NextStepsPage=function NextStepsPage$(){this.dataModel=null;this.stepList=null;this.actionTypeList=null};NextStepsPage.Init=function NextStepsPage$Init(b){NextStepsPage.dataModel=b;NextStepsPage.checkBrowser();NextStepsPage.$element=$(".dashboard-region");NextStepsPage.$center=$(".dashboard-center");NextStepsPage.$left=$(".dashboard-left");NextStepsPage.actionTypeList=new ActionTypeList(b.ActionTypes);NextStepsPage.actionTypeList.addSelectionChangedHandler("nextsteps",NextStepsPage.ManageActionType);NextStepsPage.stepManager=new StepManager(NextStepsPage,NextStepsPage.$center);NextStepsPage.stepManager.addSelectionChangedHandler("nextsteps",NextStepsPage.ManageActionType);NextStepsPage.showManager(NextStepsPage.stepManager);$(window).bind("load",NextStepsPage.resize);$(window).bind("resize",NextStepsPage.resize);$(window).bind("unload",NextStepsPage.Close);$logo=$(".brand a");$logo.unbind("click");$logo.click(function(){NextStepsPage.dataModel.Refresh();return false});NextStepsPage.showHeaderOptions()};NextStepsPage.Close=function NextStepsPage$Close(b){$(".header-icons").hide();NextStepsPage.dataModel.Close()};NextStepsPage.ManageActionType=function NextStepsPage$ManageActionType(b){NextStepsPage.showManager(NextStepsPage.stepManager);NextStepsPage.stepManager.selectActionType(b)};NextStepsPage.render=function NextStepsPage$render(c,d){NextStepsPage.actionTypeList.render(NextStepsPage.$left)};NextStepsPage.showHeaderOptions=function NextStepsPage$showHeaderOptions(){$dropdown=$(".navbar-fixed-top .pull-right .dropdown-menu");$menuitem=$dropdown.find(".option-refresh");$menuitem.show();$menuitem.click(function(b){NextStepsPage.dataModel.Refresh();b.preventDefault()});$menuitem=$dropdown.find(".option-settings");$menuitem.show();$menuitem.click(function(b){NextStepsPage.showManager(NextStepsPage.settingsManager);b.preventDefault()});$menuitem=$dropdown.find(".option-help");$menuitem.show();$menuitem.click(function(b){NextStepsPage.showManager(NextStepsPage.helpManager);b.preventDefault()})};NextStepsPage.showManager=function NextStepsPage$showManager(d,c){if(NextStepsPage.currentManager!=d){NextStepsPage.currentManager=d;(d.addWell==true)?NextStepsPage.$center.addClass("well"):NextStepsPage.$center.removeClass("well")}d.show(c)};NextStepsPage.resize=function NextStepsPage$resize(){if(NextStepsPage.resizing){return}NextStepsPage.resizing=true;$(window).unbind("resize",NextStepsPage.resize);var h=$(window).height();var g=$(".navbar-fixed-top").height();var f=$(".navbar-fixed-bottom").height();var e=h-(g+f+30);NextStepsPage.$left.height(e);NextStepsPage.$center.height(e);NextStepsPage.actionTypeList.render(NextStepsPage.$left);$(window).bind("resize",NextStepsPage.resize);NextStepsPage.resizing=false};NextStepsPage.checkBrowser=function NextStepsPage$checkBrowser(){if(Browser.IsMSIE()&&Browser.MSIE_Version()<9){var c="We're Sorry!";var d="This application currently requires an HTML5-compatible browser. We encourage you to try using the application with the latest version of Internet Explorer, Chrome, or FireFox.<br/>Thank you";Control.alert(d,c)}};function StepList(b){this.parentControl=b;this.$element=null;this.listView=new ListView(this)}StepList.prototype.render=function(d,e,f){if(this.$element==null){this.$element=d}this.listView.render(this.$element,e,f)};StepList.prototype.selectItem=function(b){this.parentControl.fireSelectionChanged(b)};function ListView(b){this.parentControl=b;this.$element=null;this.list=null}ListView.prototype.hide=function(){if(this.$element!=null){this.$element.hide()}};ListView.prototype.show=function(){if(this.$element!=null){this.$element.show()}};ListView.prototype.render=function(f,i,h){if(i==null){return}if(this.$element==null){this.$element=$('<ul class="nav nav-list" />').appendTo(f)}this.hide();this.$element.empty();if(h!=null){this.$element.css("max-height",h)}if(this.renderListItems(i.GetSteps())>0){this.show();var g=this.$element.find("li.selected");if(g.offset()!=null){var j=g.offset().top-h+this.$element.scrollTop();if(j>0){this.$element.animate({scrollTop:j},500)}}}};ListView.prototype.renderListItems=function(n){var m=0;for(var k in n){var l=n[k];var j=$("<li />").appendTo(this.$element);j.data("control",this);j.data("item",l);var i=$('<a class="form-inline" />').appendTo(j);var h=Control.Icons.deleteBtn(l).appendTo(i);h.addClass("pull-right");this.renderNameField(i,l);j.bind("click",function(a){if($(this).hasClass("ui-sortable-helper")||$(a.srcElement).hasClass("dt-checkbox")||$(a.srcElement).hasClass("dt-email")){return}var b=$(this).data("item");Control.get(this).parentControl.selectItem(b)});this.renderFields(i,l);m++}return m};ListView.prototype.renderNameField=function(e,h){var g=h.GetFields();var f=g[FieldNames.Complete];if(f!=null){Control.Checkbox.render(e,h,f)}var f=g[FieldNames.WebLinks];if(f!=null){e.append(Control.Icons.forMap(h))}e.append(Control.Icons.forSources(h));f=g[FieldNames.Name];Control.Text.renderLabel(e,h,f)};ListView.prototype.renderFields=function(g,k){var h=$("<div />").appendTo(g);var j=k.GetFields();for(var l in j){var i=j[l];this.renderField(h,k,i)}$("<small>&nbsp;</small>").appendTo(h)};ListView.prototype.renderField=function(g,l,k){var h;switch(k.Name){case FieldNames.DueDate:if(l.HasField(FieldNames.EndDate)){var j=l.GetField(FieldNames.EndDate);h=Control.DateTime.renderRange(g,l,k,j,"small")}else{if(l.HasField(FieldNames.Complete)&&l.GetFieldValue(FieldNames.Complete)!=true){h=Control.Text.render(g,l,k,"small","Due on ")}}break;case FieldNames.CompletedOn:if(l.GetFieldValue(FieldNames.Complete)==true){h=Control.Text.render(g,l,k,"small","Completed on ")}break;case FieldNames.Category:h=Control.Text.render(g,l,k,"small");break;case FieldNames.Email:h=Control.Text.renderEmail(g,l,k);break;case FieldNames.Address:var i=l.GetFieldValue(FieldNames.Address);if(i!=l.Name){h=Control.Text.render(g,l,k,"small")}break;default:break}return h};function StepManager(d,c){this.parentControl=d;this.$parentElement=c;this.addWell=false;this.$element=null;this.currentActionType=null;this.currentItem=null;this.views={};this.onSelectionChangedHandlers={};this.stepList=new StepList(this)}StepManager.ListView="fm-list-view";StepManager.ItemView="fm-item-view";StepManager.prototype.addSelectionChangedHandler=function(d,c){this.onSelectionChangedHandlers[d]=c};StepManager.prototype.removeSelectionChangedHandler=function(b){this.onSelectionChangedHandlers[b]=undefined};StepManager.prototype.fireSelectionChanged=function(e){for(var f in this.onSelectionChangedHandlers){var d=this.onSelectionChangedHandlers[f];if(typeof(d)=="function"){d(e.GetActionType(),e.ID);this.activeView(StepManager.ItemView)}}};StepManager.prototype.hide=function(){if(this.$element!=null){this.$element.hide()}};StepManager.prototype.show=function(j){if(this.$element==null){this.$element=$('<div class="manager-folders" />').appendTo(this.$parentElement);var h=$('<ul class="nav nav-tabs" />').appendTo(this.$element);h.data("control",this);var f=$('<li><a data-toggle="tab">List View</a></li>').appendTo(h);f.find("a").attr("href","."+StepManager.ListView);var g=$('<div class="tab-content" />').appendTo(this.$element);var i=$('<div class="tab-pane" />').appendTo(g);i.addClass(StepManager.ListView);this.views[StepManager.ListView]=i;$('a[data-toggle="tab"]').on("shown",function(b){var a=$(b.target).parents(".nav-tabs");Control.get(a).viewChanged($(b.target))})}if(j==true){this.render()}this.$element.show()};StepManager.prototype.render=function(){var h=this.$element.find(".nav-tabs");var g=this.$element.find(".tab-content");h.find("li a:first").empty().append(this.activeListName());var k=this.activeView();var j=this.activeItem();var i=this.views[k];var l=this.$parentElement.outerHeight()-h.outerHeight();if(k==StepManager.ListView){this.stepList.render(i,this.activeList(),l)}h.find('a[href=".'+k+'"]').tab("show")};StepManager.prototype.selectActionType=function(b){this.currentActionType=b;this.currentItem=null;if(this.currentActionType!=null){this.render()}};StepManager.prototype.selectItem=function(b){this.currentItem=b;if(this.currentItem!=null){this.currentActionType=this.currentItem.GetFolder();this.render()}else{this.selectFolder(this.currentActionType)}};StepManager.prototype.activeItem=function(){var f=null;if(this.currentItem!=null){if(this.currentItem.IsList){f=this.currentItem}else{return this.currentItem}}else{if(this.currentActionType!=null){f=this.currentActionType}}if(f!=null){var e=f.GetSteps();for(var d in e){if(!e[d].IsList){this.currentItem=e[d];break}}}return null};StepManager.prototype.activeList=function(){if(this.currentItem!=null){return(this.currentItem.IsList)?this.currentItem:this.currentItem.GetParentContainer()}else{if(this.currentActionType!=null){return this.currentActionType}}return null};StepManager.prototype.activeListName=function(){var d=this.activeList();if(d!=null){var c=Control.Icons.forItemType(d);return $("<span>&nbsp;"+d.Name+"</span>").prepend(c)}return $("<span>List View</span>")};StepManager.prototype.activeView=function(d){var c=Control.findParent(this,"dataModel").dataModel;if(d===undefined){return StepManager.ListView}else{this.render()}};StepManager.prototype.viewChanged=function(b){this.activeView(b.attr("href").substr(1))};