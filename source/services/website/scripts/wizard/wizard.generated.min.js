var Control=function Control$(){};Control.noDelay={delay:{show:0,hide:0}};Control.noDelayBottom={delay:{show:0,hide:0},placement:"bottom"};Control.ttDelay={delay:{show:0,hide:0}};Control.ttDelayBottom={delay:{show:0,hide:0},placement:"bottom"};Control.preventDefault=function Control$preventDefault(b){b.preventDefault()};Control.delegate=function Control$delegate(g,f){var e={object:g,handler:f};e.invoke=function(){return this.object[this.handler]()};return e};Control.get=function Control$get(b){return $(b).data("control")};Control.findParent=function Control$findParent(c,e){while(c.parentControl!=null){c=c.parentControl;if(c[e]!=null){return c}}return null};Control.expand=function Control$expand(e,g){var f=!(isNaN(g));if(f==true){if(Browser.IsMSIE()){e.collapse("show");e.show("blind",{direction:"vertical"},g)}else{e.show("blind",{direction:"vertical"},g,function(){e.collapse("show")})}}else{e.collapse("show")}};Control.collapse=function Control$collapse(e,g){var f=!(isNaN(g));if(f==true){e.collapse("hide")}else{e.collapse("hide")}};Control.alert=function Control$alert(h,g,f){var e=$("#modalMessage");if(e.length==0){h.replace("<br/>","\r");alert(h);if(f!=null){f()}}else{if(g==null){g="Warning!"}e.find(".modal-header h3").html(g);e.find(".modal-body p").html(h);e.modal("show");if(f!=null){e.find(".modal-header .close").unbind("click").click(function(){f()});e.find(".modal-footer .btn-primary").unbind("click").click(function(){f()})}}};Control.confirm=function Control$confirm(j,i,h,g){var f=$("#modalPrompt");if(f.length==0){j.replace("<br>","\r");if(confirm(j)==true){if(h!=null){h()}}else{if(g!=null){g()}}}else{if(i==null){i="Confirm?"}f.find(".modal-header h3").html(i);f.find(".modal-body p").html(j);f.modal({backdrop:"static",keyboard:false});f.find(".modal-footer .btn-primary").unbind("click").click(function(){f.modal("hide");if(h!=null){h()}});f.find(".modal-footer .btn-cancel").unbind("click").click(function(){f.modal("hide");if(g!=null){g()}})}};Control.popup=function Control$popup(f,j,i,h){var g=$("#modalPrompt");if(g.length==0){alert("Page requires modalPrompt control to support popup!")}else{g=g.clone();g.attr("id","modalPromptOpen");g=g.appendTo($("body"));if(j==null){j="Input required."}g.find(".modal-header h3").html(j);g.find(".modal-body p").empty().append(f);g.modal({backdrop:"static",keyboard:false});g.find(".modal-footer .btn-primary").click(function(){g.modal("hide");var a=[];$.each(g.find(".modal-body input"),function(){a.push($(this).val())});$.each(g.find(".modal-body textarea"),function(){a.push($(this).val())});if(i!=null){i(a)}$("#modalPromptOpen").remove()});g.find(".modal-footer .btn-cancel").unbind("click").click(function(){g.modal("hide");if(h!=null){h()}$("#modalPromptOpen").remove()})}};Control.working=function Control$working(p,m,o){var k=$("#modalMessage");if(k.length==0){p.replace("<br/>","\r");alert(p);if(o!=null){o()}}else{var n=function(){k.modal("hide");window.clearTimeout(r);if(o!=null){o()}};k=k.clone();var q=new Spinner().spin();k.find(".modal-header h3").html(p);var l=k.find(".modal-body p").html("&nbsp;");var j=$("<center></center>").appendTo(l);j.append(q.el).css("height","15");k.find(".modal-header .close").unbind("click").click(n);k.find(".modal-footer .btn-primary").unbind("click").click(n);k.modal("show");var r=window.setTimeout(n,m)}};Control.DateFormat=function Control$DateFormat(){var h=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,f=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,g=/[^-+\dA-Z]/g,e=function(b,a){b=String(b);a=a||2;while(b.length<a){b="0"+b}return b};return function(m,A,D){var o=Control.DateFormat;if(arguments.length==1&&Object.prototype.toString.call(m)=="[object String]"&&!/\d/.test(m)){A=m;m=undefined}m=m?new Date(m):new Date;if(isNaN(m)){throw SyntaxError("invalid date")}A=String(o.masks[A]||A||o.masks["default"]);if(A.slice(0,4)=="UTC:"){A=A.slice(4);D=true}var a=D?"getUTC":"get",b=m[a+"Date"](),c=m[a+"Day"](),y=m[a+"Month"](),E=m[a+"FullYear"](),w=m[a+"Hours"](),z=m[a+"Minutes"](),C=m[a+"Seconds"](),x=m[a+"Milliseconds"](),B=D?0:m.getTimezoneOffset(),s={d:b,dd:e(b),ddd:o.i18n.dayNames[c],dddd:o.i18n.dayNames[c+7],m:y+1,mm:e(y+1),mmm:o.i18n.monthNames[y],mmmm:o.i18n.monthNames[y+12],yy:String(E).slice(2),yyyy:E,h:w%12||12,hh:e(w%12||12),H:w,HH:e(w),M:z,MM:e(z),s:C,ss:e(C),l:e(x,3),L:e(x>99?Math.round(x/10):x),t:w<12?"a":"p",tt:w<12?"am":"pm",T:w<12?"A":"P",TT:w<12?"AM":"PM",Z:D?"UTC":(String(m).match(f)||[""]).pop().replace(g,""),o:(B>0?"-":"+")+e(Math.floor(Math.abs(B)/60)*100+Math.abs(B)%60,4),S:["th","st","nd","rd"][b%10>3?0:(b%100-b%10!=10)*b%10]};return A.replace(h,function(i){return i in s?s[i]:i.slice(1,i.length-1)})}}();Control.DateFormat.masks={"default":"ddd, mmm dd, yyyy h:MM TT",shortDate:"mm/dd/yyyy",mediumDate:"ddd, mmm dd, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",shortDateTime:"mm/dd/yyyy h:MM TT",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};Control.DateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(c,e){return Control.DateFormat(this,c,e)};Date.prototype.parseRFC3339=function(i){var h=/(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;if(i.toString().match(new RegExp(h))){var f=i.match(new RegExp(h));var g=0;this.setUTCDate(1);this.setUTCFullYear(parseInt(f[1],10));this.setUTCMonth(parseInt(f[3],10)-1);this.setUTCDate(parseInt(f[5],10));this.setUTCHours(parseInt(f[7],10));this.setUTCMinutes(parseInt(f[9],10));this.setUTCSeconds(parseInt(f[11],10));if(f[12]){this.setUTCMilliseconds(parseFloat(f[12])*1000)}else{this.setUTCMilliseconds(0)}if(f[13]!="Z"){g=(f[15]*60)+parseInt(f[17],10);g*=((f[14]=="-")?-1:1);this.setTime(this.getTime()-g*60*1000)}}else{this.setTime(Date.parse(i))}return this};Date.prototype.parseTime=function(k){if(k==""){return null}var j=k.match(/^(\d+)(:(\d\d))?\s*((a|(p))m?)?$/i);if(j==null){return null}var h=parseInt(j[1],10);var i=j[6];if(h==12&&!i){h=0}else{h+=(h<12&&i)?12:0}var g=new Date();g.setHours(h);g.setMinutes(parseInt(j[3],10)||0);g.setSeconds(0,0);return g};Control.Text={};Control.Text.render=function Control$Text$render(i,l,k,m,o,n){var m=(m==null)?"span":m;var j;var p=l.GetFieldValue(k);if(k.DisplayType==DisplayTypes.DatePicker){p=Control.DateTime.format(p,"mediumDate")}else{if(k.FieldType==FieldTypes.DateTime){p=Control.DateTime.format(p)}}if(p!=null){j=$("<"+m+"/>").appendTo(i);j.addClass(k.Class);p=((o==null)?"":o)+p+((n==null)?"":n);j.html(p)}return j};Control.Text.renderLabel=function Control$Text$renderLabel(f,i,h){var g;var j=i.GetFieldValue(h);if(j!=null){g=$("<label><strong>"+j+"</strong></label>").appendTo(f);g.addClass(h.Class)}return g};Control.Text.renderEmail=function Control$Text$renderEmail(f,i,h){var g;var j=i.GetFieldValue(h);if(j!=null){g=$("<a />").appendTo(f);g.addClass(h.Class);g.attr("href","mailto:"+j);g.html(j)}return g};Control.Text.renderActivityLink=function Control$Text$renderActivityLink(g,j,i){var h;var k=j.Name;if(j.IsStep()){var l=j.GetParent();k=l.Name}if(k!=null){h=$("<a>"+k+"</a>").appendTo(g);h.css("whitespace","nowrap");h.click(function(a){i(l)})}return h};Control.Text.renderInput=function Control$Text$renderInput(e,g,f){$text=$('<input type="text" />').appendTo(e);$text=Control.Text.base($text,g,f);Control.Text.placeholder($text,f);$text.change(function(a){Control.Text.update($(a.srcElement))});$text.keypress(function(a){if(a.which==13){Control.Text.update($(a.srcElement));return false}});return $text};Control.Text.renderInputNew=function Control$Text$renderInput(e,g,f,h){$text=$('<input type="text" />').appendTo(e);$text=Control.Text.base($text,g,f);$text.data("list",h);$text.keypress(function(a){if(a.which==13){Control.Text.insert($(a.srcElement));return false}});if(g.ItemTypeID==ItemTypes.Location){Control.Text.autoCompletePlace($text,Control.Text.insert)}else{if(g.ItemTypeID==ItemTypes.Contact){Control.Text.autoCompleteContact($text,Control.Text.insert);Control.Text.placeholder($text,"Enter a contact")}else{if(g.ItemTypeID==ItemTypes.Step){Control.Text.placeholder($text,"Enter next step")}else{Control.Text.placeholder($text,"Enter an item")}}}return $text};Control.Text.renderTextArea=function Control$Text$renderTextArea(e,g,f){$text=$("<textarea></textarea>").appendTo(e);$text=Control.Text.base($text,g,f);Control.Text.placeholder($text,f);$text.change(function(a){Control.Text.update($(a.srcElement))});return $text};Control.Text.renderInputAddress=function Control$Text$renderInputAddress(e,h,f,g){hander=(g!=null)?g:Control.Text.updateAddress;$text=$('<input type="text" />').appendTo(e);$text=Control.Text.base($text,h,f);$text.keypress(function(a){if(a.which==13){g($(a.srcElement));return false}});$text=Control.Text.autoCompletePlace($text,g);return $text};Control.Text.renderInputGrocery=function Control$Text$renderInputGrocery(e,g,f){$text=$('<input type="text" />').appendTo(e);$text=Control.Text.base($text,g,f);$text.keypress(function(a){if(a.which==13){Control.Text.updateGrocery($(a.srcElement));return false}});$text=Control.Text.autoCompleteGrocery($text,Control.Text.updateGrocery);return $text};Control.Text.autoCompletePlace=function Control$Text$autoCompletePlace(f,j){f.unbind("keypress");f.keypress(function(a){if(a.which==13){return false}});var g=new google.maps.places.Autocomplete(f[0]);var h=function(a,b){var c=0.5;return new google.maps.LatLngBounds(new google.maps.LatLng(a-c,b-c),new google.maps.LatLng(a+c,b+c))};var i=h(47.65,-122.3);g.setBounds(i);google.maps.event.addListener(g,"place_changed",function(){f.data("place",g.getPlace());j(f)});return f};Control.Text.autoCompleteAddress=function Control$Text$autoCompleteAddress(c,e){c.autocomplete({source:function(a,b){Service.Geocoder().geocode({address:a.term},function(i,j){if(j==google.maps.GeocoderStatus.OK){var h=$.map(i,function(f){return{label:f.formatted_address,value:f.formatted_address,latlong:f.geometry.location.toUrlValue()}});b(h)}})},select:function(a,b){$(this).val(b.item.label);$(this).data(FieldNames.LatLong,b.item.latlong);e($(this));return false},minLength:2});return c};Control.Text.autoCompleteContact=function Control$Text$autoCompleteContact(c,e){c.autocomplete({source:function(a,b){Service.InvokeController("UserInfo","PossibleContacts",{startsWith:a.term},function(k){var l=k.result;var i=[];if(l.Count>0){for(var j in l.Contacts){i.push({label:j,value:j,json:l.Contacts[j]})}}b(i)})},select:function(a,b){$(this).val(b.item.label);$(this).data(FieldNames.Contacts,b.item.json);e($(this));return false},minLength:1});return c};Control.Text.autoCompleteGrocery=function Control$Text$autoCompleteGrocery(c,e){c.autocomplete({source:function(a,b){Service.InvokeController("Grocery","GroceryNames",{startsWith:a.term},function(m){var n=m.result;var i=[];if(n.Count>0){for(var k in n.Groceries){var l=n.Groceries[k];i.push({label:l.Name,value:l.Name,json:l})}}b(i)})},select:function(a,b){$(this).val(b.item.label);$(this).data("grocery",b.item.json);e($(this));return false},minLength:1});return c};Control.Text.insert=function Control$Text$insert(j){var k=j.data("field");if(k.Name==FieldNames.Name){var r=j.val();if(r==null||r.length==0){return false}var m=j.data("item");var p=j.data("list");if(m.ItemTypeID==ItemTypes.Location){var q=j.data("place");var o=j.data(FieldNames.LatLong);if(q!=null&&q.geometry!=null){m=Control.Text.applyPlace(m,q);r=q.name}else{if(o!=null){m.SetFieldValue(FieldNames.LatLong,o);m.SetFieldValue(FieldNames.Address,r)}}}if(m.ItemTypeID==ItemTypes.Contact){var n=j.data(FieldNames.Contacts);if(n!=null){contact=$.parseJSON(n);if(contact.ItemTypeID==ItemTypes.Contact){m=Item.Extend(contact)}}}if(m.ItemTypeID==ItemTypes.Grocery){var l=j.data("grocery");if(l!=null){Control.Text.applyGrocery(m,l);r=l.Name}}m.SetFieldValue(k,r);p.InsertItem(m)}};Control.Text.update=function Control$Text$update(h,i){var l=h.data("item");var k=h.data("field");var n=h.val();var j=l.GetFieldValue(k);if(k.FieldType==FieldTypes.DateTime){n=Control.DateTime.format(n)}if(n!=j){var m=l.Copy();m.SetFieldValue(k,n);l.Update(m,i)}};Control.Text.updateAddress=function Control$Text$updateAddress(j){var n=j.data("item");var m=j.data("field");var r=j.val();var l=n.GetFieldValue(m);var q=n.Copy();var p=j.data("place");var o=j.data(FieldNames.LatLong);if(p!=null&&p.geometry!=null){q=Control.Text.applyPlace(q,p,m.Name)}else{if(o!=null){var k=n.GetFieldValue(FieldNames.LatLong);if(k==null||k!=o){q.SetFieldValue(FieldNames.LatLong,o);q.SetFieldValue(m,r)}}else{if(r!=l){q.SetFieldValue(m,r)}}}n.Update(q)};Control.Text.applyPlace=function Control$Text$applyPlace(g,i,f){if(g.Name==null||f==FieldNames.Name){g.SetFieldValue(FieldNames.Name,i.name)}g.SetFieldValue(FieldNames.LatLong,i.geometry.location.toUrlValue());g.SetFieldValue(FieldNames.Address,i.formatted_address);if(i.formatted_phone_number!=null&&g.GetFieldValue(FieldNames.Phone)==null){g.SetFieldValue(FieldNames.Phone,i.formatted_phone_number)}var h=g.GetFieldValue(FieldNames.WebLinks);if(h==null||h=="[]"){var j=new LinkArray();if(i.types[0]=="street_address"){j.Add("http://maps.google.com/maps?z=15&t=m&q="+i.formatted_address,"Map")}else{j.Add(i.url,"Map")}if(i.website!=null){j.Add(i.website,"Website")}g.SetFieldValue(FieldNames.WebLinks,j.ToJson())}return g};Control.Text.updateGrocery=function Control$Text$updateGrocery(h){var l=h.data("item");var j=h.data("field");var n=h.val();var i=l.GetFieldValue(j);var m=l.Copy();var k=h.data("grocery");if(k!=null){m=Control.Text.applyGrocery(m,k,j.Name)}else{if(n!=i){m.SetFieldValue(j,n)}}l.Update(m)};Control.Text.applyGrocery=function Control$Text$applyGrocery(g,f,e){if(g.Name==null||e==FieldNames.Name){g.SetFieldValue(FieldNames.Name,f.Name)}g.SetFieldValue(FieldNames.Category,f.Category);g.SetFieldValue(FieldNames.Picture,f.ImageUrl);return g};Control.Text.base=function Control$Text$base(e,g,f){e.addClass(f.Class);e.data("item",g);e.data("field",f);e.val(g.GetFieldValue(f));return e};Control.Text.placeholder=function Control$Text$placeholder(c,e){if(typeof(e)=="object"){e="Enter "+e.DisplayName.toLowerCase()}c.attr("placeholder",e);if(Browser.IsMSIE()){if(c.val()==null||c.val().length==0){c.val(e);c.addClass("ie-placeholder")}c.focus(function(){var a=$(this);if(a.val()==a.attr("placeholder")){a.val("");a.removeClass("ie-placeholder")}});c.blur(function(){var a=$(this);if(a.val()==null||a.val().length==0){a.val(a.attr("placeholder"));a.addClass("ie-placeholder")}})}};Control.Checkbox={};Control.Checkbox.render=function Control$Checkbox$render(e,g,f){$checkbox=$('<input type="checkbox" class="checkbox" />').appendTo(e);$checkbox.addClass(f.Class);$checkbox.attr("title",f.DisplayName).tooltip(Control.ttDelay);if(g.GetFieldValue(f)==true){$checkbox.attr("checked","checked")}$checkbox.data("item",g);$checkbox.data("field",f);$checkbox.change(function(){Control.Checkbox.update($(this))});var h=g.GetParentContainer();if(g.IsStep()&&h.IsActivity()&&h.IsRunning()&&(g.IsComplete()||g.IsSkipped())){$checkbox.attr("disabled","disabled")}return $checkbox};Control.Checkbox.update=function Control$Checkbox$update(g){var k=g.data("item");var j=g.data("field");var l=(g.attr("checked")=="checked");var i=k.GetFieldValue(j);if(l!=i){g.tooltip("hide");if(l==true&&j.Name==FieldNames.Complete&&k.HasField(FieldNames.CompletedOn)){k.Complete()}else{var h=k.Copy();h.SetFieldValue(j,l);k.Update(h)}}};Control.LinkArray={};Control.LinkArray.render=function Control$LinkArray$render(i,p,n){var m=$('<div class="link-array" />').appendTo(i);$text=$('<input type="text" />').appendTo(m);$text=Control.Text.base($text,p,n);$text.val("");Control.Text.placeholder($text,"Add a link");$text.change(function(a){Control.LinkArray.update($(a.srcElement))});$text.keypress(function(a){if(a.which==13){Control.LinkArray.update($(a.srcElement));return false}});var r=new LinkArray(p.GetFieldValue(n));var s=r.Links();if(s.length>0){for(var o in s){Control.LinkArray.deleteBtn(o).appendTo(m);var q=s[o];var l=$("<a/>").appendTo(m);var t=(q.Name==null)?q.Url:q.Name;l.html(t);l.attr("href",q.Url);l.attr("target","new")}}return $text};Control.LinkArray.update=function Control$LinkArray$update(g){var i=g.data("item");var h=g.data("field");var j=new LinkArray(i.GetFieldValue(h));var l=g.val();if(l!=null&&l.length>0){j.Add(l);var k=i.Copy();k.SetFieldValue(h,j.ToJson());i.Update(k)}};Control.LinkArray.deleteBtn=function Control$Icons$deleteBtn(e){var c=$('<i class="icon-remove-circle"></i>');c.css("cursor","pointer");c.attr("title","Remove Link").tooltip(Control.noDelay);c.data("index",e);c.bind("click",function(){var b=$(this);b.tooltip("hide");var a=b.parents(".link-array").first().find("input");var j=a.data("item");var i=a.data("field");var k=new LinkArray(j.GetFieldValue(i));k.Remove(b.data("index"));var l=j.Copy();l.SetFieldValue(i,k.ToJson());j.Update(l);return false});return $('<a class="icon" />').append(c)};Control.DateTime={};Control.DateTime.renderDatePicker=function Control$DateTime$renderDatePicker(e,g,f){$date=$('<input type="text" />').appendTo(e);$date.addClass(f.Class);$date.data("item",g);$date.data("field",f);$date.val(Control.DateTime.format(g.GetFieldValue(f),"shortDate"));$date.datepicker({numberOfMonths:2,onClose:function(b,a){Control.DateTime.update(a.input)}});return $date};Control.DateTime.renderDateTimePicker=function Control$DateTime$renderDateTimePicker(e,g,f){$date=$('<input type="text" />').appendTo(e);$date.addClass(f.Class);$date.data("item",g);$date.data("field",f);$date.val(Control.DateTime.format(g.GetFieldValue(f),"shortDateTime"));$date.datetimepicker({ampm:true,timeFormat:"h:mm TT",hourGrid:4,minuteGrid:15,stepMinute:15,numberOfMonths:2,onClose:function(b,a){Control.DateTime.update(a.input)}});return $date};Control.DateTime.renderRange=function Control$DateTime$renderRange(n,v,u,t,y){var y=(y==null)?"span":y;var o,z;var x=v.GetFieldValue(u);var s=v.GetFieldValue(t);if(x!=null&&s!=null){if(u.FieldType==FieldTypes.DateTime&&t.FieldType==FieldTypes.DateTime){var w=new Date().parseRFC3339(x);var p=new Date().parseRFC3339(s);if(w.toDateString()==p.toDateString()){var r=p.format().split(" ");var q=r[r.length-2]+" "+r[r.length-1];z="On "+w.format()+" to "+q}else{z="From "+w.format()+" until "+p.format()}}else{z="From "+x+" until "+s}}if(z!=null){o=$("<"+y+"/>").appendTo(n);o.addClass(u.Class);o.html(z)}return o};Control.DateTime.update=function Control$DateTime$update(b){Control.Text.update(b,null)};Control.DateTime.format=function Control$DateTime$format(h,g){if(h!=null&&h.length>0){try{var e=new Date().parseRFC3339(h);return e.format(g)}catch(f){}}return h};Control.DateTime.formatUTC=function Control$DateTime$formatUTC(b){return Control.DateTime.format(b,"isoUtcDateTime")};Control.ContactList={};Control.ContactList.renderInput=function Control$ContactList$renderInput(j,p,m,n){$input=$('<input type="text" />').appendTo(j);$input.addClass(m.Class);$input.data("item",p);$input.data("field",m);n=(n==null)?Control.ContactList.update:n;$input.keypress(function(a){if(a.which==13){n($(a.srcElement));return false}});var r=p.GetFieldValue(m);var q="";if(r!=null&&r.IsList){var l=r.GetItems();for(var o in l){var k=l[o].GetFieldValue(FieldNames.EntityRef);if(k!=null){q+=k.Name}break}}$input.val(q);Control.Text.autoCompleteContact($input,n);return $input};Control.ContactList.update=function Control$ContactList$update(m,u){var v=m.data("item");var t=m.data("field");var p=m.val();if(p==null||p.length==0){v.RemoveReferences(t);return}var n;var w=m.data(FieldNames.Contacts);if(w!=null){n=$.parseJSON(w)}var x=v.GetParent();if(n!=null&&n.ItemTypeID==ItemTypes.Reference){var q={Name:n.Name,ID:n.FieldValues[0].Value};v.AddReference(t,q,true);if(x!=null&&x.IsActivity){x.AddReference(t,q,false)}if(u){u(n)}}else{if(n!=null){n=Item.Extend(n);var s=n.GetFieldValue(FieldNames.FacebookID);var r=DataModel.FindContact(n.Name,s);if(r!=null){v.AddReference(t,n,true);if(x!=null&&x.IsActivity){x.AddReference(t,r,false)}if(u){u(r)}return}}else{n=Item.Extend({Name:p,ItemTypeID:ItemTypes.Contact})}var o=DataModel.UserSettings.GetDefaultList(ItemTypes.Contact);DataModel.InsertItem(n,o,null,null,null,function(a){v.AddReference(t,a,true);if(x!=null&&x.IsActivity){x.AddReference(t,a,false)}if(u){u(a)}})}};Control.LocationList={};Control.LocationList.renderInput=function Control$LocationList$renderInput(j,n,k,l){$input=$('<input type="text" />').appendTo(j);$input.addClass(k.Class);$input.data("item",n);$input.data("field",k);l=(l==null)?Control.LocationList.update:l;$input.keypress(function(a){if(a.which==13){l($(a.srcElement));return false}});var r=n.GetFieldValue(k);var q="";if(r!=null&&r.IsList){var p=r.GetItems();for(var m in p){var o=p[m].GetFieldValue(FieldNames.EntityRef);if(o!=null){q=o.Name}break}}$input.val(q);Control.Text.autoCompletePlace($input,l);return $input};Control.LocationList.update=function Control$LocationList$update(l,p){var q=l.data("item");var o=l.data("field");var m=l.val();if(m==null||m.length==0){q.RemoveReferences(o);return}var u=q.GetParent();var r=l.data(FieldNames.LatLong);var v=l.data("place");if(v!=null&&v.geometry!=null){r=v.geometry.location.toUrlValue()}var n=DataModel.FindLocation(m,r);if(n!=null){q.AddReference(o,n,true);if(u!=null&&u.IsActivity){u.AddReference(o,n,false)}if(p){p(n)}}else{var s=DataModel.UserSettings.GetDefaultList(ItemTypes.Location);var t=Item.Extend({Name:m,ItemTypeID:ItemTypes.Location});if(v!=null&&v.geometry!=null){Control.Text.applyPlace(t,v)}else{t.SetFieldValue(FieldNames.Address,m);if(r!=null){t.SetFieldValue(FieldNames.LatLong,r)}}DataModel.InsertItem(t,s,null,null,null,function(a){q.AddReference(o,a,true);if(u!=null&&u.IsActivity){u.AddReference(o,a,false)}if(p){p(a)}})}};Control.List={};Control.List.sortable=function Control$List$sortable(b){b.sortable({axis:"y",handle:".drag-handle",stop:function(u,A){$("i").tooltip("hide");var a=A.item;var w=a.data("item");if(w!=null){var z=a.parent("ul").children("li");for(var v in z){var t=$(z[v]).data("item");if(t!=null&&w.ID==t.ID){var i=$(z[v]).prevAll("li").first();var y=(i.length==0)?null:i.data("item");var s=Number((y==null)?0:y.SortOrder);var e=$(z[v]).nextAll("li").first();var x=(e.length==0)?null:e.data("item");var r=Number((x==null)?s+1000:x.SortOrder);var B=w.Copy();B.SortOrder=s+((r-s)/2);w.Update(B);break}}}}})};Control.Icons={};Control.Icons.forSources=function Control$Icons$forSources(k){var h=$("<span />");if(k.HasField(FieldNames.Sources)){var l=k.GetFieldValue(FieldNames.Sources);if(l!=null){l=l.split(",");for(var j in l){switch(l[j]){case"Facebook":var i=k.GetFieldValue(FieldNames.FacebookID);var g=$('<i class="icon-facebook-sign" />').appendTo(h);if(i!=null){g.click(function(){window.open("http://www.facebook.com/"+i);return false})}break;case"Directory":h.append('<i class="icon-azure" />');break}}}else{if(k.ItemTypeID==ItemTypes.Contact){h.append('<i class="icon-user"></i>')}}}return h};Control.Icons.forItemType=function Control$Icons$forItemType(f){var g=f;if(typeof(f)=="object"){g=f.ItemTypeID}var e=$("<i></i>");switch(g){case ItemTypes.Activity:if(typeof(f)=="object"){return Control.Icons.forStatusType(f)}else{return Control.Icons.forStatusType(StatusTypes.Active)}break;case ItemTypes.Step:e.addClass("icon-check");break;case ItemTypes.Contact:e.addClass(f.IsFolder()?"icon-group":"icon-user");break;case ItemTypes.Location:e.addClass("icon-map-marker");break;case ItemTypes.Category:return Control.Icons.forFolder(f.IsFolder()?f:f.GetFolder());default:e.addClass("icon-folder-close");break}return e};Control.Icons.forStatusType=function Control$Icons$forStatusType(f){var g=f;if(typeof(f)=="object"){g=f.Status}var e=$("<i></i>");switch(g){case StatusTypes.Active:e.addClass("icon-play");break;case StatusTypes.Complete:e.addClass("icon-check");break;case StatusTypes.Paused:e.addClass("icon-pause");break;case StatusTypes.Skipped:e.addClass("icon-share");break;default:e.addClass("icon-sign-blank");break}return e};Control.Icons.forActionType=function Control$Icons$forActionType(f){var g=f;if(f!=null&&typeof(f)=="object"){g=f.Name}var e=$("<i></i>");switch(g){case ActionTypes.All:e.addClass("icon-play");break;case ActionTypes.Reminder:e.addClass("icon-time");break;case ActionTypes.Call:e.addClass("icon-phone");break;case ActionTypes.SendEmail:e.addClass("icon-envelope");break;case ActionTypes.Find:e.addClass("icon-search");break;case ActionTypes.AskFriends:e.addClass("icon-facebook");break;case ActionTypes.Schedule:e.addClass("icon-calendar");break;case ActionTypes.Errand:e.addClass("icon-shopping-cart");break;case ActionTypes.TextMessage:e.addClass("icon-list-alt");break;default:e.addClass("icon-question-sign");break}return e};Control.Icons.forFolder=function Control$Icons$forFolder(f){var g=f;if(f!=null&&typeof(f)=="object"){g=f.Name}var e=$("<i></i>");switch(g){case UserEntities.Inbox:e.addClass("icon-envelope");break;case UserEntities.People:e.addClass("icon-group");break;case UserEntities.Places:e.addClass("icon-globe");break;case UserEntities.Personal:e.addClass("icon-user");break;case UserEntities.Home:e.addClass("icon-home");break;case UserEntities.Auto:e.addClass("icon-truck");break;default:e.addClass("icon-folder-close");break}return e};Control.Icons.deleteBtn=function Control$Icons$deleteBtn(e){var c=$('<i class="icon-remove-sign"></i>');c.css("cursor","pointer");c.data("item",e);c.attr("title","Delete").tooltip(Control.noDelay);c.bind("click",function(){var a=$(this);a.tooltip("hide");var f=a.data("item");var b=(f.ParentID==null)?f.GetFolder():f.GetParent();f.Delete(b);return false});return $('<a class="icon" />').append(c)};Control.Icons.forMap=function Control$Icons$forMap(i){var j=i.GetFieldValue(FieldNames.WebLinks);if(j!=null&&j.length>0){var l=new LinkArray(j).Links();for(var h in l){var k=l[h];if(k.Name=="Map"&&k.Url!=null){var g=$('<i class="icon-map-marker"></i>');g.attr("href",k.Url);g.attr("title","Map").tooltip(Control.ttDelay);g.click(function(){window.open($(this).attr("href"));return false});return g}}}return $("<i></i>")};Control.Icons.completeBtn=function Control$Icons$completeBtn(g,f){var e=$('<i class="icon-check icon-large"></i>');e.data("item",g);e.attr("title","Done");if(!Browser.IsMobile()){e.attr("title","Complete").tooltip(Control.ttDelay)}e.click(function(){var a=$(this);a.tooltip("hide");var b=a.data("item");if(f==null){b.Complete();return true}if(f(b)){b.Complete();return true}return false});return $('<a class="icon" />').append(e)};Control.Icons.completeHandler=function Control$Icons$completeHandler(n){var j=n.GetActionType();var k=n.GetParent();if(j==null||k==null){return false}var h=null;var m=null;switch(j.Name){case ActionTypes.Find:h=$("<div>Where will this happen?<p/></div>");var l=n.GetField(FieldNames.Locations);var i=Control.LocationList.renderInput(h,n,l,function(a){return false});m=k.Name;break;default:return true}if(h!=null){Control.popup(h,m,function(a){Control.LocationList.update(i);n.Complete();return true},function(a){return false})}return false};Control.Icons.skipBtn=function Control$Icons$skipBtn(e){var c=$('<i class="icon-share icon-large"></i>');c.data("item",e);c.attr("title","Skip");if(!Browser.IsMobile()){c.tooltip(Control.ttDelay)}c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");b.Skip();return true});return $('<a class="icon" />').append(c)};Control.Icons.deferBtn=function Control$Icons$deferBtn(e){var c=$('<i class="icon-time icon-large icon-blue"></i>');c.data("item",e);c.attr("title","Defer");if(!Browser.IsMobile()){c.tooltip(Control.ttDelay)}c.bind("click",function(){var a=$(this);a.tooltip("hide");return true});return c};Control.Icons.infoBtn=function Control$Icons$infoBtn(e){var c=$('<i class="icon-info-sign  icon-large"></i>');c.data("item",e);c.attr("title","Info");if(!Browser.IsMobile()){c.tooltip(Control.ttDelay)}c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");NextStepsPage.showManager(NextStepsPage.infoManager);NextStepsPage.infoManager.selectItem(b);return false});return $('<a class="icon" />').append(c)};Control.Icons.callBtn=function Control$Icons$callBtn(g){var e=$('<i class="icon-phone icon-large"></i>');e.data("item",g);e.attr("title","Call");if(!Browser.IsMobile()){e.tooltip(Control.ttDelay)}var f=function(a){a=a.replace(/[^0-9]+/g,"");if(Browser.IsMobile()){window.open("tel:"+a)}else{Control.alert("<p>This action only works on a mobile device</p>","call "+Control.Icons.formatPhoneNumber(a))}};e.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");var c=b.GetPhoneNumber();if(c!=null){f(c)}else{Control.Icons.infoDialog(b,FieldNames.Phone,"Phone","tel",f)}return false});return $('<a class="icon" />').append(e)};Control.Icons.formatPhoneNumber=function Control$Icons$formatPhoneNumber(b){if(b.length==7){return b.slice(0,3)+"-"+b.slice(3,7)}if(b.length==10){return"("+b.slice(0,3)+") "+b.slice(3,6)+"-"+b.slice(6,10)}return b};Control.Icons.mapBtn=function Control$Icons$mapBtn(e){var c=$('<i class="icon-map-marker icon-large icon-blue"></i>');c.data("item",e);c.attr("title","Map");if(!Browser.IsMobile()){c.tooltip(Control.ttDelay)}c.bind("click",function(){var k=$(this);k.tooltip("hide");var o=k.data("item");var p=o.GetMapLink();if(p!=null){window.open(p)}else{var n=o.Name;if(o.IsLocation()){var a=$("<div>Please select a location or address<p/></div>");var m=o.GetField(FieldNames.Address);var b=Control.Text.renderInputAddress(a,o,m,function(f){return false});Control.popup(a,n,function(f){Control.Text.updateAddress(b);var g=b.data("place");if(g!=null){if(Browser.IsMobile()){window.open("maps:"+escape(g.formatted_address))}else{window.open("http://maps.google.com/?q="+escape(g.formatted_address))}}})}else{var l;if(o.IsActivity()||o.IsStep()){l="Where is this taking place?"}else{if(o.IsContact()||o.IsLocation()){l="Please select the location or address"}}var a=$("<div>"+l+"<p/></div>");var m=o.GetField(FieldNames.Locations);var b=Control.LocationList.renderInput(a,o,m,function(f){return false});Control.popup(a,n,function(f){Control.LocationList.update(b);var g=b.data("place");if(g!=null){if(Browser.IsMobile()){window.open("maps:"+escape(g.formatted_address))}else{window.open("http://maps.google.com/?q="+escape(g.formatted_address))}}})}}return false});return $('<a class="icon" />').append(c)};Control.Icons.emailBtn=function Control$Icons$emailBtn(g){var e=$('<i class="icon-envelope icon-large icon-blue"></i>');e.data("item",g);e.attr("title","Email");if(!Browser.IsMobile()){e.tooltip(Control.ttDelay)}var f=function(a){window.open("mailto:"+a)};e.click(function(){var a=$(this);a.tooltip("hide");var c=a.data("item");var b=c.GetEmail();if(b!=null){f(b)}else{Control.Icons.infoDialog(c,FieldNames.Email,"Email","email",f)}return false});return $('<a class="icon" />').append(e)};Control.Icons.textBtn=function Control$Icons$textBtn(g){var e=$('<i class="icon-list-alt icon-large"></i>');e.data("item",g);e.attr("title","Text");if(!Browser.IsMobile()){e.tooltip(Control.ttDelay)}var f=function(a){a=a.replace(/[^0-9]+/g,"");if(Browser.IsMobile()){window.open("sms:"+a)}else{Control.alert("<p>This action only works on a mobile device</p>","text "+Control.Icons.formatPhoneNumber(a))}};e.click(function(){var a=$(this);a.tooltip("hide");var b=a.data("item");var c=b.GetPhoneNumber();if(c!=null){f(c)}else{Control.Icons.infoDialog(b,FieldNames.Phone,"Phone","sms",f)}return false});return $('<a class="icon" />').append(e)};Control.Icons.scheduleBtn=function Control$Icons$scheduleBtn(e){var c=$('<i class="icon-calendar icon-large"></i>');c.data("item",e);c.attr("title","Calendar");if(!Browser.IsMobile()){c.attr("title","Add to calendar").tooltip(Control.ttDelay)}c.bind("click",function(){var b=$(this);b.tooltip("hide");var j=b.data("item");var h=j.GetParent();var a=$('<div><label>Date: </label><input id="datepicker" type="date"/><label>Start time: </label><input type="time"/><label>End time: </label><input type="time"/><label>Title: </label><input type="text" id="name"/></div>');a.find("#name").val(h.Name);a.find("#datepicker").val((new Date()).format("shortDate"));if(!Browser.IsMobile()&&Browser.IsMSIE()){a.find("#datepicker").datepicker()}var i="When should appointment be scheduled for?";Control.popup(a,i,function(s){if(s[0].length==0){Control.alert("Please provide a date for the appointment","Schedule appointment")}else{var w=new Date();w.setHours(0,0,0,0);var x=new Date(s[0]);if(x<w){Control.alert("The date you provided is in the past","Schedule appointment");return}var g=new Date(x);var y=x.parseTime(s[1]);var r=g.parseTime(s[2]);if(y!=null){x.setHours(y.getHours());x.setMinutes(y.getMinutes());if(r!=null){g.setHours(r.getHours());g.setMinutes(r.getMinutes())}else{g.setHours(y.getHours()+1);g.setMinutes(y.getMinutes())}}else{x.setHours(0);x.setMinutes(0);g.setDate(g.getDate()+1);g.setHours(0);g.setMinutes(0)}var t=j.GetLocation();var u=(t!=null)?t.GetFieldValue(FieldNames.Address):null;var v=(s[3].length>0)?s[3]:h.Name;var f=Appointment.Extend({Name:v,StartTime:x,EndTime:g,Location:u,ItemID:j.ID});Service.InvokeController("Actions","CreateAppointment",{Appointment:f},function(l){var m=l.result;if(m.StatusCode!="200"){Control.alert("Server was unable to add appointment","Schedule appointment")}else{var n=m.Result;var o=j.update(n,null);j.Complete();var k=(y!=null)?x.format("shortDateTime"):x.format("shortDate")}});Control.working("Adding appointment to calendar",1000)}});return false});return $('<a class="icon" />').append(c)};Control.Icons.askFriendsBtn=function Control$Icons$askFriendsBtn(e){var c=$('<i class="icon-facebook icon-large"></i>');c.data("item",e);c.attr("title","Ask");if(!Browser.IsMobile()){c.attr("title","Ask Facebook Friends").tooltip(Control.ttDelay)}c.bind("click",function(){var b=$(this);b.tooltip("hide");var l=b.data("item");var j=l.GetParent();var a=$("<div><label>Question: </label><textarea /></div>");var m="Redmond";var n="Do you know a good "+l.GetExtendedFieldValue(ExtendedFieldNames.Article)+" in "+m+"?";a.find("textarea").val(n).css("height","75");var k="Ask Facebook friends";Control.popup(a,k,function(f){if(f[0].length==0){Control.alert("Please provide a question to ask on Facebook","Ask Facebook friends")}else{n=f[0];Service.InvokeController("Actions","PostOnFacebook",{Question:n},function(g){var h=g.result;if(h.StatusCode!="200"){Control.alert("Server was unable to post on Facebook","Ask Facebook friends")}else{var i=h.Result;if(i!=null){var o=l.update(i,null);l.Complete()}}});Control.working("Posting question to Facebook",1500)}});return false});return $('<a class="icon" />').append(c)};Control.Icons.findLocalBtn=function Control$Icons$findLocalBtn(e){var c=$('<i class="icon-search icon-large"></i>');c.data("item",e);c.attr("title","Find");if(!Browser.IsMobile()){c.tooltip(Control.ttDelay)}c.bind("click",function(){var a=$(this);a.tooltip("hide");var b=a.data("item");var f=b.Name.toLowerCase();f=f.replace(/^find an /,"");f=f.replace(/^find a /,"");f=f.replace(/^find /,"");window.open("https://maps.google.com/?q="+f+"&radius=1");return false});return $('<a class="icon" />').append(c)};Control.Icons.infoDialogForContactOrLocation=function Control$Icons$infoDialogForContactOrLocation(o,k,p,n,l){k=(k==null)?FieldNames.Phone:k;p=(p==null)?"Phone":p;n=(n==null)?"tel":n;var m="Please enter "+(o.IsLocation()?"location":"contact")+" information";var j=$("<div><label>"+p+'</label><input type="'+n+'" id="dataField"/></div>');var i=j.find("#dataField");Control.popup(j,m,function(b){if(b[0].length==0){Control.alert("Please provide a "+p.toLocaleLowerCase()+" for the location or contact","Call")}else{var a=b[0];var c=Item.Extend(o);c.SetFieldValue(k,a);o.Update(c);if(l!=null){l(a)}}})};Control.Icons.infoDialog=function Control$Icons$infoDialog(v,r,w,u,s){if(v.IsLocation()||v.IsContact()){return Control.Icons.infoDialogForContactOrLocation(v,r,w,u,s)}r=(r==null)?FieldNames.Phone:r;w=(w==null)?"Phone":w;u=(u==null)?"tel":u;var t="Please choose a location or a contact";var o=$('<div class="form-vertical control-group"></div>');$('<label class="control-label">Choose a location</label>').appendTo(o);var x=v.GetField(FieldNames.Locations);var p=Control.LocationList.renderInput(o,v,x,function(a){if(r==FieldNames.Phone){var b=a.data("place");if(b!=null){n.val(b.formatted_phone_number)}else{n.val("")}}else{n.val("")}});o.append('<label class="control-label">Or, choose a contact</label>');var q=v.GetField(FieldNames.Contacts);var m=Control.ContactList.renderInput(o,v,q,function(a){var c=a.data(FieldNames.Contacts);var b=Item.Extend($.parseJSON(c));b=DataModel.FindItem(b.ID);if(b!=null){n.val(b.GetFieldValue(r))}else{n.val("")}});o.append('<div class="controls" style="margin-top:6px"><label class="control-label">'+w+'</label><input type="'+u+'" id="dataField"/></div>');var n=o.find("#dataField");p.blur(function(a){if(p.val().length>0){m.attr("disabled",true)}else{m.attr("disabled",false)}return true});m.blur(function(a){if(m.val().length>0){p.attr("disabled",true)}else{p.attr("disabled",false)}return true});Control.popup(o,t,function(b){if(b[2].length==0){Control.alert("Please provide a phone number for the location or contact","Call")}else{if((b[0].length==0||b[0]=="Enter a location")&&b[1].length==0){Control.alert("Please provide a location or contact","Call")}else{var a=b[2];if(b[1].length>0){Control.ContactList.update(m,function(e){e=Item.Extend(e);var c=Item.Extend(e);c.SetFieldValue(r,a);e.Update(c)})}else{if(b[0].length>0){Control.LocationList.update(p,function(e){e=Item.Extend(e);var c=Item.Extend(e);c.SetFieldValue(r,a);e.Update(c)})}}if(s!=null){s(a)}}}})};Control.ItemType={};Control.ItemType.renderDropdown=function Control$ItemType$renderDropdown(r,w,B){var y=DataModel.Constants.ItemTypes;var u=y[w.ItemTypeID].Name;var t=t=$('<div class="control-group"></div>').appendTo(r);if(B!=true){var A=(w.IsFolder()||w.IsList)?"List":"Item";var z='<label class="control-label">Type of '+A+"</label>";$(z).appendTo(t)}var p=$('<div class="btn-group" />').appendTo(t);var o=$('<a class="btn dropdown-toggle" data-toggle="dropdown" />').appendTo(p);Control.Icons.forItemType(w).appendTo(o);if(B!=true){$("<span>&nbsp;&nbsp;"+u+"</span>").appendTo(o);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(o)}var q=$('<ul class="dropdown-menu" />').appendTo(p);q.data("item",w);for(var v in y){var x=y[v];if(x.UserID==SystemUsers.User||x.UserID==DataModel.User.ID){var s=$("<li><a></a></li>").appendTo(q);s.find("a").append(Control.Icons.forItemType(v));s.find("a").append("<span>&nbsp;&nbsp;"+y[v].Name+"</span>");s.data("value",v);s.click(function(a){Control.ItemType.update($(this));a.preventDefault()})}}return t};Control.ItemType.update=function Control$ItemType$update(h){var i=h.parent().data("item");var j=i.Copy();j.ItemTypeID=h.data("value");var f=h.parents(".btn-group").first().find(".btn");f.find("i").replaceWith(Control.Icons.forItemType(j));var g=h.find("span").first();if(g.length>0){f.find("span").first().html(g.html())}i.Update(j)};Control.ActionType={};Control.ActionType.renderDropdown=function Control$ActionType$renderDropdown(q,w,z){if(!w.HasField(FieldNames.ActionType)){return $("<dummy />")}var u=w.GetFieldValue(FieldNames.ActionType);if(u==null){u=ActionTypes.Reminder}var s=s=$('<div class="control-group"></div>').appendTo(q);if(z!=true){var y=(w.IsFolder()||w.IsList)?"List":"Item";var x='<label class="control-label">Type of '+y+"</label>";$(x).appendTo(s)}var o=$('<div class="dropdown" />').appendTo(s);var n=$('<a class="icon dropdown-toggle" data-toggle="dropdown" />').appendTo(o);Control.Icons.forActionType(u).appendTo(n);if(z!=true){$("<span>&nbsp;&nbsp;"+u+"</span>").appendTo(n);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(n)}var p=$('<ul class="dropdown-menu" />').appendTo(o);p.data("item",w);for(var v in ActionTypes){var t=ActionTypes[v];if(t==ActionTypes.All){continue}var r=$("<li><a></a></li>").appendTo(p);r.find("a").append(Control.Icons.forActionType(t));r.find("a").append("<span>&nbsp;&nbsp;"+t+"</span>");r.data("value",v);r.click(function(a){Control.ActionType.update($(this));a.preventDefault()})}return s};Control.ActionType.update=function Control$ActionType$update(j){var k=j.parent().data("item");var n=k.Copy();var l=j.data("value");var m=ActionTypes[l];n.SetFieldValue(n.GetField(FieldNames.ActionType),m);var h=j.parents(".btn-group").first().find(".btn");h.find("i").replaceWith(Control.Icons.forActionType(m));var i=j.find("span").first();if(i.length>0){h.find("span").first().html(i.html())}k.Update(n)};Control.DeferButton={};Control.DeferButton.renderDropdown=function Control$DeferButton$renderDropdown(p,w){if(!w.HasField(FieldNames.DueDate)){return}var v=w.GetField(FieldNames.DueDate);var t=w.GetFieldValue(v);var u=new Date(t);if(u.compareTo(Date.today().add(30).days())==1){return}var n=$('<div class="control-group inline" />').appendTo(p);if(Browser.IsMobile()){n.addClass("btn-group")}else{n.addClass("dropdown dropcenter")}var q=Control.Icons.deferBtn(w);var m=$('<a class="dropdown-toggle" data-toggle="dropdown"></a>').append(q).appendTo(n);if(Browser.IsMobile()){m.addClass("btn btn-step")}var o=$('<ul class="dropdown-menu" />').appendTo(n);o.data("item",w);var x=q.attr("title");q.attr("title",null);var s=$("<p />").appendTo(m);s.html(x);var r;if(u.compareTo(Date.today().add(1).days())==-1){var r=$("<li><a></a></li>").css("border-top","0px").appendTo(o);r.find("a").append("<span>&nbsp;Tomorrow</span>");r.click(function(a){Control.DeferButton.update(w,1);a.preventDefault()})}if(u.compareTo(Date.today().add(6).days())==-1){r=$("<li><a></a></li>").css("border-top","0px").appendTo(o);r.find("a").append("<span>&nbsp;Next week</span>");r.click(function(a){Control.DeferButton.update(w,7);a.preventDefault()})}if(u.compareTo(Date.today().add(30).days())==-1){r=$("<li><a></a></li>").css("border-top","0px").appendTo(o);r.find("a").append("<span>&nbsp;Next month</span>");r.click(function(a){Control.DeferButton.update(w,30);a.preventDefault()})}return n};Control.DeferButton.update=function Control$DeferButton$update(i,g){var j=i.Copy();var h=i.GetField(FieldNames.DueDate);var f=Date.today();switch(g){case 7:f=f.next().sunday();break;case 30:f=f.next().month().moveToFirstDayOfMonth();break;default:f=f.add(g).days();break}j.SetFieldValue(h,f.format("shortDate"));i.Update(j)};Control.ThemePicker={};Control.ThemePicker.render=function Control$ThemePicker$render(l){var p=DataModel.Constants.Themes;var n=DataModel.UserSettings.Preferences.Theme;var m=$('<div class="control-group"><label class="control-label">Theme</label></div>').appendTo(l);var j=$('<div class="btn-group" />').appendTo(m);var i=$('<a class="btn dropdown-toggle" data-toggle="dropdown" />').appendTo(j);$("<span>"+n+"</span>").appendTo(i);$('<span class="pull-right">&nbsp;&nbsp;<span class="caret" /></span>').appendTo(i);var k=$('<ul class="dropdown-menu" />').appendTo(j);for(var o in p){$("<li><a>"+p[o]+"</a></li>").appendTo(k)}k.click(function(b){var a=$(b.target);var c=a.html();DataModel.UserSettings.UpdateTheme(c);a.parents(".btn-group").find("span").first().html(c);b.preventDefault()});return m};Control.Actions={};Control.Actions.render=function Control$Actions$render(k,n){if(Browser.IsMobile()){var m=$('<div class="btn-toolbar hide" />').appendTo(k);var j=Control.DeferButton.renderDropdown(m,n);this.mobileButton(Control.Icons.skipBtn(n),true).appendTo(m);this.mobileButton(Control.Icons.completeBtn(n,function(a){return Control.Icons.completeHandler(a)}),true).appendTo(m);this.mobileButton(Control.Icons.infoBtn(n),false).appendTo(m);var h=this.renderAction(n);if(h!=null){this.mobileButton(h).prependTo(m)}}else{var m=$('<div class="btn-toolbar pull-right" />').appendTo(k);var j=Control.DeferButton.renderDropdown(m,n);var l=Control.Icons.skipBtn(n).appendTo(m);var i=Control.Icons.completeBtn(n,function(a){return Control.Icons.completeHandler(a)}).appendTo(m);var h=this.renderAction(n);if(h!=null){h.prependTo(m)}}};Control.Actions.renderAction=function Control$Actions$renderAction(g){var e=g.GetActionType();if(e==null){return null}var f=e.Name;switch(f){case ActionTypes.Call:return Control.Icons.callBtn(g);case ActionTypes.TextMessage:return Control.Icons.textBtn(g);case ActionTypes.SendEmail:return Control.Icons.emailBtn(g);case ActionTypes.Errand:return Control.Icons.mapBtn(g);case ActionTypes.Find:return Control.Icons.findLocalBtn(g);case ActionTypes.Schedule:return Control.Icons.scheduleBtn(g);case ActionTypes.AskFriends:return Control.Icons.askFriendsBtn(g)}};Control.Actions.mobileButton=function Control$Actions$mobileButton(i,k){var g=$('<a class="btn btn-step" />').append(i);var h=i.find("i");h.addClass("icon-blue");var l=h.attr("title");h.attr("title",null);var j=$("<p />").appendTo(g);j.html(l);g.click(function(a){h.click();return(k==true)?true:false});return g};var DataModel=function DataModel$(){};DataModel.Constants={};DataModel.User={};DataModel.Folders={};DataModel.Suggestions={};DataModel.GalleryCategories={};DataModel.ActionTypes={};DataModel.UserSettings;DataModel.onDataChangedHandlers={};DataModel.timeStamp="/Date(0)/";DataModel.Init=function DataModel$Init(c,e){this.processConstants($.parseJSON(c));this.processUserData($.parseJSON(e))};DataModel.Close=function DataModel$Close(){Service.Close();DataModel.UserSettings.Save()};DataModel.AddDataChangedHandler=function(e,c){this.onDataChangedHandlers[e]=c};DataModel.RemoveDataChangedHandler=function(b){delete this.onDataChangedHandlers[b]};DataModel.Refresh=function DataModel$Refresh(e){var c=DataModel.UserSettings.ViewState;Service.GetResource(Service.UsersResource,null,function(a){DataModel.processUserData(a.result);DataModel.UserSettings.ViewState=c;DataModel.restoreSelection()})};DataModel.FindItem=function DataModel$FindItem(g){if(g!=null){var e=DataModel.Folders[g];if(e!=null){return e}for(id in DataModel.Folders){e=DataModel.Folders[id];var f=e.Items[g];if(f!=null){return f}}}return null};DataModel.FindActionType=function DataModel$FindActionType(c){if(c!=null){var e=DataModel.ActionTypes[c];if(e!=null){return e}}return null};DataModel.FindLocation=function DataModel$FindLocation(g,l){for(id in DataModel.Folders){var h=DataModel.Folders[id];if(h.ItemTypeID==ItemTypes.Location){for(id in h.Items){var i=h.Items[id];if(i.ItemTypeID==ItemTypes.Location){var k=i.GetFieldValue(FieldNames.LatLong);if(l!=null&&k!=null){if(l==k){return i}}else{var j=i.GetFieldValue(FieldNames.Address);if(g==j){return i}}}}}}return null};DataModel.FindContact=function DataModel$FindContact(j,f){for(id in DataModel.Folders){var g=DataModel.Folders[id];if(g.ItemTypeID==ItemTypes.Contact){for(id in g.Items){var h=g.Items[id];if(h.ItemTypeID==ItemTypes.Contact){var i=h.GetFieldValue(FieldNames.FacebookID);if(f!=null&&i!=null){if(f==i){return h}}else{if(j==h.Name){return h}}}}}}return null};DataModel.GetItems=function DataModel$GetItems(k,p,i,l){var o={};var j=(typeof(k)=="object")?k:DataModel.Folders[k];if(j!=undefined){if(i!=true){for(var m in j.Items){var n=j.Items[m];if(n.ParentID==p&&n.IsList){o[m]=j.Items[m]}}}if(l===undefined){for(var m in j.Items){var n=j.Items[m];if(n.ParentID==p&&!n.IsList){o[m]=j.Items[m]}}}else{for(var m in j.Items){var n=j.Items[m];if(n.ParentID==p&&!n.IsList&&l==n.Group){o[m]=j.Items[m]}}}}return o};DataModel.InsertItem=function DataModel$InsertItem(q,m,k,n,j,l){if(q!=null&&q.Name!=null){var r=Service.ItemsResource;if(m==null){r=Service.FoldersResource}else{if(m.IsFolder()){q.FolderID=m.ID;q.ParentID=null;q.ItemTypeID=(q.ItemTypeID==null)?m.ItemTypeID:q.ItemTypeID}else{if(m.IsList!=null&&m.IsList){q.FolderID=m.FolderID;q.ParentID=m.ID;q.ItemTypeID=(q.ItemTypeID==null)?m.ItemTypeID:q.ItemTypeID}else{return false}}}if(k==null){if(m==null){var o=DataModel.FoldersMap.itemAt(-1);q.SortOrder=(o==null)?1000:o.SortOrder+1000}else{var p=ItemMap.itemAt(m.GetItems(),-1);q.SortOrder=(p==null)?1000:p.SortOrder+1000}}if(q.ID==null){q.ID=Math.uuid()}delete q.Created;if(m==null){q=DataModel.addFolder(q,j)}else{m.addItem(q,j)}Service.InsertResource(r,q,function(b){var a=b.result;if(a.ItemTypeID==ItemTypes.Step){q.update(a)}else{q.update(a,null)}if(l!=null){l(a)}});return true}return false};DataModel.InsertFolder=function DataModel$InsertFolder(g,e,f){return DataModel.InsertItem(g,null,e,f)};DataModel.UpdateItem=function DataModel$UpdateItem(h,j,f){if(h!=null&&j!=null){h.update(j,f);j.LastModified=DataModel.timeStamp;var i=(h.IsFolder())?Service.FoldersResource:Service.ItemsResource;var g=[h,j];if(i==Service.FoldersResource){g=[h.Copy(),j]}Service.UpdateResource(i,h.ID,g,function(a){var b=a.result;if(b.ItemTypeID==ItemTypes.Step){var c=h.update(b)}else{var c=h.update(b,null)}});return true}return false};DataModel.DeleteItem=function DataModel$DeleteItem(l,j){if(l!=null){if(l.IsFolder()){DataModel.FoldersMap.remove(l);DataModel.fireDataChanged()}else{var o=l.GetParent();if(o!=null&&o.ItemTypeID==ItemTypes.Reference){l.GetFolder().ItemsMap.remove(l)}else{if(j!=null){var i=j.IsFolder()?j.ID:j.FolderID;var k=j.IsFolder()?null:j.ID;l.GetFolder().ItemsMap.remove(l);DataModel.deleteReferences(l.ID);DataModel.fireDataChanged(i,k)}else{var m=l.selectNextItem();var n=(m==null)?null:m.ID;l.GetFolder().ItemsMap.remove(l);DataModel.deleteReferences(l.ID);DataModel.fireDataChanged(l.FolderID,n)}}}var p=(l.IsFolder())?Service.FoldersResource:Service.ItemsResource;Service.DeleteResource(p,l.ID,l,function(b){var a=b.result});return true}return false};DataModel.GetGalleryCategories=function DataModel$GetGalleryCategories(e,c){if(c==null){c="system"}Service.GetResource(Service.GalleryResource,c,function(b){var a=b.result;if(a.length>0){DataModel.GalleryCategoriesRetrieved=new Date()}DataModel.processGalleryCategories(a);if(e!=null){e(DataModel.GalleryCategories)}})};DataModel.GetSuggestions=function DataModel$GetSuggestions(h,e,f){var g={};if(e==null){e=DataModel.User}g.EntityID=e.ID;g.FieldName=f;g.EntityType=EntityTypes.User;if(e.hasOwnProperty("ItemTypeID")){g.EntityType=(e.hasOwnProperty("FolderID"))?EntityTypes.Item:EntityTypes.Folder}Service.InsertResource(Service.SuggestionsResource,g,function(a){var b=a.result;if(b.length>0){DataModel.SuggestionsRetrieved=new Date()}DataModel.processSuggestions(b);if(h!=null){h(DataModel.Suggestions)}})};DataModel.SelectSuggestion=function DataModel$SelectSuggestion(j,h,g){h=(h==null)?Reasons.Chosen:h;var i=$.extend({},j);i.TimeSelected=DataModel.timeStamp;i.ReasonSelected=h;var f=[j,i];Service.UpdateResource(Service.SuggestionsResource,j.ID,f,function(a){var b=a.result;if(g!=null){g(i)}})};DataModel.RemoveSuggestion=function DataModel$RemoveSuggestion(e){var c=DataModel.Suggestions[e.GroupID];if(c!=null){delete c.Suggestions[e.ID]}};DataModel.fireDataChanged=function(e,g){if(DataModel.UserSettings.GetFolder(e)==null){for(var h in DataModel.onDataChangedHandlers){var f=DataModel.onDataChangedHandlers[h];if(typeof(f)=="function"){f(e,g)}}}};DataModel.getFolder=function(e){var c=DataModel.Folders[e];if(c==null){c=DataModel.UserSettings.GetFolder(e)}return c};DataModel.addFolder=function(e,c){e=Folder.Extend(e);if(e.ItemsMap==null){e.ItemsMap=new ItemMap([]);e.Items=e.ItemsMap.Items}DataModel.FoldersMap.append(e);if(c===undefined){DataModel.fireDataChanged(e.ID)}else{if(c!=null){DataModel.fireDataChanged(c.FolderID,c.ID)}}return e};DataModel.deleteReferences=function(n){for(var h in DataModel.Folders){var i=DataModel.Folders[h];for(var l in i.Items){var m=i.Items[l];if(m.ItemTypeID==ItemTypes.Reference){for(var k in m.FieldValues){var j=m.FieldValues[k];if(j.FieldName==FieldNames.EntityRef&&j.Value==n){m.GetFolder().ItemsMap.remove(m)}}}}}};DataModel.processConstants=function DataModel$processConstants(r){var i={};for(var s in r){i[s]=r[s]}var p=i.ItemTypes;for(var n in p){var o=ItemType.Extend(p[n]);var m={};for(var q in o.Fields){var j=o.Fields[q];j.ClassName="fn-"+j.Name.toLowerCase();j.Class=j.ClassName+" dt-"+j.DisplayType.toLowerCase();m[j.Name]=j}o.Fields=m;p[n]=o}i.ItemTypesMap=new ItemMap(p);i.ItemTypes=i.ItemTypesMap.Items;i.PrioritiesByName={};for(var n in i.Priorities){var t=i.Priorities[n];i.PrioritiesByName[t.Name]=t}DataModel.Constants=i};DataModel.processUserData=function DataModel$processUserData(e){var h={};for(var f in e){h[f]=e[f]}var g={};g.ID=h.ID;g.Name=h.Name;g.Email=h.Email;g.CreateDate=h.CreateDate;DataModel.User=g;DataModel.processFolders(h.Folders);DataModel.processActionTypes(DataModel.Constants.ActionTypes)};DataModel.processSuggestions=function DataModel$processSuggestions(t){var x={};var n=[];var r={};var u=0;for(var s in t){var w=t[s];if(w.ParentID==null){var q=w.GroupDisplayName;var p=r[q];if(p===undefined){p=(w.GroupDisplayName==SuggestionTypes.RefreshEntity)?w.GroupDisplayName:"Group_"+(u++).toString();r[q]=p;x[p]={GroupID:p,DisplayName:w.GroupDisplayName,Suggestions:{}}}w.GroupID=p;x[p].Suggestions[w.ID]=w}else{n.push(w)}}for(s in n){var i=n[s];for(p in x){var o=x[p];var v=o.Suggestions[i.ParentID];if(v!=null){if(v.Suggestions==null){v.Suggestions={}}v.Suggestions[i.ID]=i;break}}}DataModel.Suggestions=x};DataModel.processFolders=function DataModel$processFolders(k){var j,p;for(var l in k){k[l]=Folder.Extend(k[l]);var m=k[l].Items;for(var n in m){m[n]=Item.Extend(m[n])}k[l].ItemsMap=new ItemMap(m);k[l].Items=k[l].ItemsMap.Items;if(k[l].Name==SystemFolders.Client){j=l}if(k[l].Name==SystemFolders.WebClient){p=l}}var i=k.splice(j,1)[0];if(p==null){DataModel.UserSettings=new UserSettings(i);Service.InsertResource(Service.FoldersResource,{Name:SystemFolders.WebClient,ItemTypeID:ItemTypes.NameValue,SortOrder:0},function(a){var b=a.result;b=Folder.Extend(b);DataModel.UserSettings=new UserSettings(i,b)})}else{if(p>j){p--}var o=k.splice(p,1)[0];DataModel.UserSettings=new UserSettings(i,o)}DataModel.FoldersMap=new ItemMap(k);DataModel.Folders=DataModel.FoldersMap.Items};DataModel.processActionTypes=function DataModel$processActionTypes(c){var c={};for(var e in ActionTypes){c[e]=ActionType.Extend({Name:ActionTypes[e],ID:ActionTypes[e]})}DataModel.ActionTypesMap=new ItemMap(c);DataModel.ActionTypes=DataModel.ActionTypesMap.Items};DataModel.processGalleryCategories=function DataModel$processGalleryCategories(g){for(var i in g){var h=GalleryCategory.Extend(g[i]);g[i]=h;var f=h.Activities;for(var j in f){f[j]=GalleryActivity.Extend(f[j])}h.ActivitiesMap=new ItemMap(f);h.Activities=h.ActivitiesMap.Items}DataModel.GalleryCategoriesMap=new ItemMap(g);DataModel.GalleryCategories=DataModel.GalleryCategoriesMap.Items};DataModel.restoreSelection=function DataModel$restoreSelection(g){if(g===undefined&&DataModel.UserSettings!=null){g=DataModel.UserSettings.ViewState.SelectedItem}if(g!=null){var f=DataModel.FindItem(g);if(f!=null){DataModel.fireDataChanged(f.FolderID,f.ID);return}}var e=DataModel.UserSettings.ViewState.SelectedFolder;if(e!=null){DataModel.fireDataChanged(e);return}DataModel.fireDataChanged()};function Folder(){}Folder.Extend=function Folder$Extend(b){return $.extend(new Folder(),b)};Folder.prototype.Copy=function(){var b=$.extend(new Folder(),this);b.Items={};b.ItemsMap={};return b};Folder.prototype.IsFolder=function(){return true};Folder.prototype.IsCategory=function(){return(this.ItemTypeID==ItemTypes.Category)};Folder.prototype.IsActivity=function(){return(this.ItemTypeID==ItemTypes.Activity)};Folder.prototype.IsRunning=function(){return false};Folder.prototype.IsDefault=function(){var b=DataModel.UserSettings.GetDefaultList(this.ItemTypeID);if(b!=null){return(b.IsFolder())?(this.ID==b.ID):(this.ID==b.FolderID)}return false};Folder.prototype.IsSelected=function(){return DataModel.UserSettings.IsFolderSelected(this.ID)};Folder.prototype.IsExpanded=function(){return DataModel.UserSettings.IsFolderExpanded(this.ID)};Folder.prototype.Expand=function(b){DataModel.UserSettings.ExpandFolder(this.ID,b)};Folder.prototype.GetItemType=function(){return DataModel.Constants.ItemTypes[this.ItemTypeID]};Folder.prototype.GetItems=function(c,e){return DataModel.GetItems(this,null,c,e)};Folder.prototype.GetItem=function(b){return this.Items[b]};Folder.prototype.GetItemByName=function(f,g){for(id in this.Items){var e=this.Items[id];if(e.Name==f){if(g===undefined||e.ParentID==g){return e}}}return null};Folder.prototype.GetItemByValue=function(g,f){for(id in this.Items){var e=this.Items[id];if(e.ItemTypeID==ItemTypes.NameValue||e.ItemTypeID==ItemTypes.Reference){if(g==e.GetFieldValue(FieldNames.Value)&&(f===undefined||e.ParentID==f)){return e}}}return null};Folder.prototype.GetSelectedItem=function(){for(id in this.Items){if(DataModel.UserSettings.IsItemSelected(id)==true){return this.Items[id]}}return null};Folder.prototype.InsertItem=function(h,f,g,e){return DataModel.InsertItem(h,this,f,g,e)};Folder.prototype.Update=function(b){return DataModel.UpdateItem(this,b)};Folder.prototype.Delete=function(){return DataModel.DeleteItem(this)};Folder.prototype.addItem=function(g,e){g=Item.Extend(g);if(this.ItemsMap==null){this.ItemsMap=new ItemMap([g]);this.Items=this.ItemsMap.Items}else{this.ItemsMap.append(g)}if(e===undefined){var f=(g.IsList)?g.ID:g.ID;DataModel.fireDataChanged(this.ID,f)}else{if(e!=null){DataModel.fireDataChanged(e.FolderID,e.ID)}}};Folder.prototype.update=function(b){if(this.ID==b.ID){b=Folder.Extend(b);b.ItemsMap=this.ItemsMap;b.Items=this.ItemsMap.Items;b.FolderUsers=this.FolderUsers;DataModel.FoldersMap.update(b);DataModel.Folders=DataModel.FoldersMap.Items;DataModel.fireDataChanged(this.ID);return true}return false};function Item(){}Item.Extend=function Item$Extend(b){return $.extend(new Item(),b)};Item.prototype.Copy=function(){var e=this.GetFolder();var c=(e==null)?this:e.GetItem(this.ID);return $.extend(true,new Item(),(c==null)?this:c)};Item.prototype.IsFolder=function(){return false};Item.prototype.IsDefault=function(){var b=DataModel.UserSettings.GetDefaultList(this.ItemTypeID);if(b!=null){return(this.ID==b.ID)}return false};Item.prototype.Select=function(){return DataModel.UserSettings.Selection(this.FolderID,this.ID)};Item.prototype.IsSelected=function(b){return DataModel.UserSettings.IsItemSelected(this.ID,b)};Item.prototype.GetFolder=function(){return(DataModel.getFolder(this.FolderID))};Item.prototype.GetParent=function(){return(this.ParentID==null)?null:this.GetFolder().Items[this.ParentID]};Item.prototype.GetParentContainer=function(){return(this.ParentID==null)?this.GetFolder():this.GetParent()};Item.prototype.GetItemType=function(){return DataModel.Constants.ItemTypes[this.ItemTypeID]};Item.prototype.GetItems=function(c,e){return DataModel.GetItems(this.FolderID,this.ID,c,e)};Item.prototype.InsertItem=function(h,f,g,e){return DataModel.InsertItem(h,this,f,g,e)};Item.prototype.Update=function(e,c){return DataModel.UpdateItem(this,e,c)};Item.prototype.Delete=function(b){return DataModel.DeleteItem(this,b)};Item.prototype.HasField=function(b){return this.GetItemType().HasField(b)};Item.prototype.GetField=function(b){return this.GetItemType().Fields[b]};Item.prototype.GetFields=function(){return this.GetItemType().Fields};Item.prototype.Refresh=function(){var b=this;Service.GetResource(Service.ItemsResource,this.ID,function(e){var a=e.result;if(a!=null){b.update(a,null)}})};Item.prototype.GetFieldValue=function(f,h){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){return this.Name}if(f.Name==FieldNames.Complete){return(this.Status==StatusTypes.Complete)}for(var i in this.FieldValues){var g=this.FieldValues[i];if(g.FieldName==f.Name){if(g.Value!=null&&f.FieldType==FieldTypes.Guid){var j=DataModel.FindItem(g.Value);if(j!=null){return j}}if(f.FieldType==FieldTypes.Boolean){if(typeof(g.Value)=="string"){g.Value=(g.Value.toLowerCase()=="true")}}return g.Value}}if(f.FieldType=="Boolean"){return false}return null}return undefined};Item.prototype.GetExtendedFieldValue=function(e){for(var g in this.FieldValues){var f=this.FieldValues[g];if(f.FieldName==e){return f.Value}}return undefined};Item.prototype.SetFieldValue=function(f,j){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)){if(f.Name==FieldNames.Name){this.Name=j;return true}if(f.Name==FieldNames.Complete){this.Status=(j==true)?StatusTypes.Complete:null;return true}if(this.FieldValues==null){this.FieldValues=[]}var i=false;for(var h in this.FieldValues){var g=this.FieldValues[h];if(g.FieldName==f.Name){g.Value=j;i=true;break}}if(!i){this.FieldValues=this.FieldValues.concat({FieldName:f.Name,ItemID:this.ID,Value:j})}return true}return false};Item.prototype.AddReference=function(g,h,k){if(typeof(g)=="string"){g=this.GetField(g)}if(g!=null&&this.HasField(g.Name)&&g.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(g);if(j!=null){if(k==true){return this.replaceReference(j,h)}else{return this.addReference(j,h,true)}}else{var l=this;var i={Name:g.Name,IsList:true,ItemTypeID:ItemTypes.Reference,FolderID:l.FolderID,ParentID:l.ID,UserID:l.UserID};Service.InsertResource(Service.ItemsResource,i,function(b){var a=b.result;l.addItem(a,null);a=DataModel.FindItem(a.ID);l.addReference(a,h);var c=$.extend({},l);c.SetFieldValue(g.Name,a.ID);l.Update(c)})}return true}return false};Item.prototype.RemoveReferences=function(f){if(typeof(f)=="string"){f=this.GetField(f)}if(f!=null&&this.HasField(f.Name)&&f.FieldType==FieldTypes.Guid){var j=this.GetFieldValue(f);if(j!=null&&j.IsList){var i=j.GetItems();for(var g in i){var h=i[g];h.Delete()}}return true}return false};Item.prototype.IsLocation=function(){return(this.ItemTypeID==ItemTypes.Location)};Item.prototype.IsContact=function(){return(this.ItemTypeID==ItemTypes.Contact)};Item.prototype.GetLocation=function(){var g=this.GetFieldValue(FieldNames.Locations);if(g!=null){var f=DataModel.GetItems(g.FolderID,g.ID,true);for(var e in f){return f[e].GetFieldValue(FieldNames.EntityRef)}}var h=this.GetParent();if(h!=null){g=h.GetFieldValue(FieldNames.Locations);if(g!=null){f=DataModel.GetItems(g.FolderID,g.ID,true);for(var e in f){return f[e].GetFieldValue(FieldNames.EntityRef)}}}return null};Item.prototype.GetContact=function(){var g=this.GetFieldValue(FieldNames.Contacts);if(g!=null){var f=DataModel.GetItems(g.FolderID,g.ID,true);for(var e in f){return f[e].GetFieldValue(FieldNames.EntityRef)}}var h=this.GetParent();if(h!=null){g=h.GetFieldValue(FieldNames.Locations);if(g!=null){f=DataModel.GetItems(g.FolderID,g.ID,true);for(var e in f){return f[e].GetFieldValue(FieldNames.EntityRef)}}}return null};Item.prototype.GetPhoneNumber=function(){if(this.HasField(FieldNames.Phone)){return this.GetFieldValue(FieldNames.Phone)}if(this.IsActivity()||this.IsStep()){var c=this.GetLocation();if(c!=null){var e=c.GetFieldValue(FieldNames.Phone);if(e!=null){return e}}c=this.GetContact();if(c!=null){return c.GetFieldValue(FieldNames.Phone)}}return null};Item.prototype.GetEmail=function(){if(this.HasField(FieldNames.Email)){return this.GetFieldValue(FieldNames.Email)}if(this.IsActivity()||this.IsStep()){var c=this.GetLocation();if(c!=null){var e=c.GetFieldValue(FieldNames.Email);if(e!=null){return e}}c=this.GetContact();if(c!=null){return c.GetFieldValue(FieldNames.Email)}}return null};Item.prototype.GetMapLink=function(){var e=function(c){if(c!=null){var a=c.GetFieldValue(FieldNames.Address);if(a!=null){if(Browser.IsMobile()){return"maps:"+escape(a)}else{return"http://maps.google.com/?q="+escape(a)}}var i=c.GetFieldValue(FieldNames.WebLinks);if(i!=null&&i.length>0){var l=new LinkArray(i).Links();for(var b in l){var k=l[b];if(k.Name=="Map"&&k.Url!=null){return k.Url}}}}};if(this.HasField(FieldNames.Address)){return e(this)}if(this.HasField(FieldNames.Locations)){var f=this.GetLocation();if(f!=null){var g=e(f);if(g!=null){return g}}f=this.GetContact();if(f!=null){return e(f)}}return null};Item.prototype.UpdateStatus=function(g,e){var f=this.Copy();f.Status=g;return this.Update(f,e)};Item.prototype.IsStopped=function(){return(this.Status==StatusTypes.Stopped)};Item.prototype.IsActive=function(){return(this.Status==StatusTypes.Active)};Item.prototype.IsComplete=function(){return(this.Status==StatusTypes.Complete)};Item.prototype.IsCompleted=function(){return(this.Group!=null)};Item.prototype.IsPaused=function(){return(this.Status==StatusTypes.Paused)};Item.prototype.IsSkipped=function(){return(this.Status==StatusTypes.Skipped)};Item.prototype.IsRunning=function(){return !(this.IsStopped()||this.IsPaused())};Item.prototype.StatusClass=function(){return((this.IsCompleted())?"st-completed":(this.IsStopped())?"st-stopped":("st-"+this.Status.toLowerCase()))};Item.prototype.IsCategory=function(){return(this.ItemTypeID==ItemTypes.Category)};Item.prototype.IsActivity=function(){return(this.ItemTypeID==ItemTypes.Activity)};Item.prototype.IsStep=function(){return(this.ItemTypeID==ItemTypes.Step)};Item.prototype.GetActionType=function(){var e=this.GetFieldValue(FieldNames.ActionType);if(e==null){e=ActionTypes.Reminder}var c=DataModel.FindActionType(e);if(c==null){c=DataModel.FindActionType(ActionTypes.Reminder)}return c};Item.prototype.CanResume=function(){var v={Start:false,Resume:false,Restart:false};var x=this.GetItems(true,null);if(ItemMap.count(x)==0){var q=this.GetFieldValue(FieldNames.DueDate);var p=this.GetFieldValue(FieldNames.CompletedOn);var s=(q!=null&&q.length>0);var r=(p!=null&&p.length>0);v.Start=!s;v.Resume=s&&!r;v.Restart=s&&r;return v}var n=true;var o=true;var m=true;var u=0;for(var t in x){var w=x[t];if(!w.IsStopped()){n=false}if(w.IsPaused()){u++}if(u==0&&!(w.IsComplete()||w.IsSkipped())){m=false}if(u==1&&w.IsRunning()){o=false}}v.Start=n;v.Resume=(u<2&&m&&o);v.Restart=!v.Start;return v};Item.prototype.Complete=function(){var j=new Date().format();var f=this.Copy();f.Status=StatusTypes.Complete;if(f.HasField(FieldNames.CompletedOn)){f.SetFieldValue(FieldNames.CompletedOn,j)}var g=this.nextItem();if(g!=null&&g.IsStep()){this.Update(f,null);g.Active(this.GetFieldValue(FieldNames.DueDate))}else{if(this.IsStep()){var h=this.GetParent();if(h!=null&&h.IsActivity()){var i=h.Copy();i.Status=StatusTypes.Complete;i.SetFieldValue(FieldNames.CompletedOn,j);h.Update(i,null)}}this.Update(f)}};Item.prototype.Skip=function(){var j=new Date().format();var f=this.Copy();f.Status=StatusTypes.Skipped;if(f.HasField(FieldNames.CompletedOn)){f.SetFieldValue(FieldNames.CompletedOn,j)}var g=this.nextItem();if(g!=null&&g.IsStep()){this.Update(f,null);g.Active(this.GetFieldValue(FieldNames.DueDate))}else{if(this.IsStep()){var h=this.GetParent();if(h!=null&&h.IsActivity()){var i=h.Copy();i.Status=StatusTypes.Complete;i.SetFieldValue(FieldNames.CompletedOn,j);h.Update(i,null)}}this.Update(f)}};Item.prototype.Pause=function(){var g=this.GetItems(true,null);for(var e in g){var f=g[e];if(f.IsActive()){f.UpdateStatus(StatusTypes.Paused,null);break}}this.UpdateStatus(StatusTypes.Paused)};Item.prototype.Start=function(b){return this.Active(b)};Item.prototype.Active=function(k){var n=this.GetItems(true,null);if(ItemMap.count(n)==0){var i=(k!=null)?k:this.GetFieldValue(FieldNames.DueDate);if(i==null||i.length==0){return this}else{var h=this.Copy();h.Status=StatusTypes.Active;h.SetFieldValue(FieldNames.DueDate,i);this.Update(h);return null}}var l=null;for(var j in n){var m=n[j];if(m.IsPaused()){m.UpdateStatus(StatusTypes.Active,null);this.UpdateStatus(StatusTypes.Active);return null}if(m.IsStopped()){var i=(k!=null)?k:m.GetFieldValue(FieldNames.DueDate);if(i==null||i.length==0){if(l!=null){i=l.GetFieldValue(FieldNames.DueDate)}else{i=this.GetFieldValue(FieldNames.DueDate)}}if(i!=null&&i.length>0){var h=m.Copy();h.Status=StatusTypes.Active;h.SetFieldValue(FieldNames.DueDate,i);m.Update(h,null);this.UpdateStatus(StatusTypes.Active);return null}else{return m}}l=m}this.UpdateStatus(StatusTypes.Complete);return null};Item.prototype.Restart=function(){var h=this.GetItems(true,null);if(ItemMap.count(h)==0){var e=this.Copy();e.SetFieldValue(FieldNames.DueDate,null);e.SetFieldValue(FieldNames.CompletedOn,null);this.Update(e,null);return e.Active()}else{for(var f in h){var g=h[f];var e=g.Copy();e.Status=null;e.SetFieldValue(FieldNames.DueDate,null);g.Update(e,null)}}return this.Active()};Item.prototype.Repeat=function(){var t=Recurrence.Extend(this.GetFieldValue(FieldNames.Repeat));var o=new Date();if(this.IsComplete()){o=new Date(this.GetFieldValue(FieldNames.CompletedOn))}var p=t.NextDueDate(o);if(!this.IsComplete()){}var u=this.GetItems(true,null);var s=[];for(var n in u){var r=u[n].Copy();r.ID=null;r.Status=StatusTypes.Stopped;r.SetFieldValue(FieldNames.DueDate,null);s.push(r)}var v=new Date().toUTCString();for(var n in u){var i=u[n].Copy();i.Group=v;u[n].Update(i,null)}s[0].Status=StatusTypes.Active;s[0].SetFieldValue(FieldNames.DueDate,p);var q=s[s.length-1].SortOrder+1;for(var m in s){s[m].SortOrder=q++;this.InsertItem(s[m],null,null,null)}this.UpdateStatus(StatusTypes.Active)};Item.prototype.addItem=function(e,c){this.GetFolder().addItem(e,c)};Item.prototype.update=function(g,e){if(this.ID==g.ID){g=Item.Extend(g);var f=this.GetFolder();if(this.FolderID==g.FolderID){f.ItemsMap.update(g);f.Items=f.ItemsMap.Items}else{f.ItemsMap.remove(this);g.GetFolder().ItemsMap.append(g)}if(e===undefined){DataModel.fireDataChanged(this.FolderID,this.ID)}else{if(e!=null){DataModel.fireDataChanged(this.FolderID,e.ID)}}return true}return false};Item.prototype.nextItem=function(){var g=this.GetParent();var h=(g==null)?this.GetFolder().GetItems():g.GetItems();var e=ItemMap.indexOf(h,this.ID);var f=ItemMap.itemAt(h,e+1);return f};Item.prototype.selectNextItem=function(){var h=this.GetParent();var i=(h==null)?this.GetFolder().GetItems():h.GetItems();var f=ItemMap.indexOf(i,this.ID);var g=ItemMap.itemAt(i,f+1);if(g!=null){return g}else{if(f==0){if(h!=null){return h}}else{var j=ItemMap.itemAt(i,f-1);if(j!=null){return j}}}return null};Item.prototype.addReference=function(n,l,h){if(n.IsList){if(h){var k=n.GetItems();for(var i in k){var j=k[i];var m=j.GetFieldValue(FieldNames.EntityRef);if(m.ID==l.ID){return false}}}var j=Item.Extend({Name:l.Name,ItemTypeID:ItemTypes.Reference,FolderID:n.FolderID,ParentID:n.ID,UserID:n.UserID});j.SetFieldValue(FieldNames.EntityRef,l.ID);j.SetFieldValue(FieldNames.EntityType,EntityTypes.Item);n.InsertItem(j,null,null,null);return true}return false};Item.prototype.replaceReference=function(k,j){if(k.IsList){var i=k.GetItems();for(var g in i){var h=i[g];var l=h.Copy();l.SetFieldValue(FieldNames.EntityRef,j.ID);h.Update(l,k.GetParent());return true}return this.addReference(k,j)}return false};function ItemType(){}ItemType.Extend=function ItemType$Extend(b){return $.extend(new ItemType(),b)};ItemType.prototype.HasField=function(b){return(this.Fields.hasOwnProperty(b))};function ItemMap(b){this.array=(b==null)?[]:b;this.updateMap()}ItemMap.prototype.updateMap=function(){this.Items={};for(var b in this.array){if(this.array[b].hasOwnProperty("ID")){this.Items[this.array[b].ID]=this.array[b]}else{throw ItemMap.errorMustHaveID}}};ItemMap.prototype.indexOf=function(e){for(var c in this.array){if(this.array[c].ID==e.ID){return c}}return -1};ItemMap.prototype.itemAt=function(b){if(b<0){return this.array[this.array.length-1]}if(b<this.array.length){return this.array[b]}return null};ItemMap.prototype.append=function(b){if(b.hasOwnProperty("ID")){this.array=this.array.concat(b);this.Items[b.ID]=this.array[this.array.length-1]}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.update=function(h){if(h.hasOwnProperty("ID")){var g=this.indexOf(h);var e=this.itemAt(g);if(h.hasOwnProperty("SortOrder")&&e.hasOwnProperty("SortOrder")&&(h.SortOrder!=e.SortOrder)){this.array.splice(g,1);for(var f in this.array){if(this.array[f].hasOwnProperty("SortOrder")&&h.SortOrder<this.array[f].SortOrder){this.array.splice(f,0,h);this.updateMap();return}}this.array.push(h);this.updateMap()}else{this.array[g]=h;this.Items[h.ID]=this.array[g]}}else{throw ItemMap.errorMustHaveID}};ItemMap.prototype.remove=function(e){if(e.hasOwnProperty("ID")){var c=this.indexOf(e);if(c>=0){this.array.splice(c,1);delete this.Items[e.ID]}}else{throw ItemMap.errorMustHaveID}};ItemMap.count=function(g){var e=0,f;for(f in g){if(g.hasOwnProperty(f)){e++}}return e};ItemMap.indexOf=function(j,g){var h=-1,f=0;for(var i in j){if(i==g){h=f;break}f++}return h};ItemMap.itemAt=function(h,e){for(var g in h){var f=h[g];if(e--==0){return f}}return(e<0)?f:null};ItemMap.errorMustHaveID="ItemMap requires all items in array to have an ID property.";var ItemTypes={Category:"00000000-0000-0000-0000-000000000007",Activity:"00000000-0000-0000-0000-000000000001",Step:"00000000-0000-0000-0000-000000000002",Contact:"00000000-0000-0000-0000-000000000003",Location:"00000000-0000-0000-0000-000000000004",System:"00000000-0000-0000-0000-000000000000",Reference:"00000000-0000-0000-0000-000000000005",NameValue:"00000000-0000-0000-0000-000000000006"};var FieldNames={Name:"Name",Description:"Description",Repeat:"Repeat",Complete:"Complete",CompletedOn:"CompletedOn",DueDate:"DueDate",EndDate:"EndDate",ActionType:"ActionType",Birthday:"Birthday",Address:"Address",WebLink:"WebLink",WebLinks:"WebLinks",Email:"Email",Phone:"Phone",HomePhone:"HomePhone",WorkPhone:"WorkPhone",Amount:"Amount",Cost:"Cost",ItemTags:"ItemTags",EntityRef:"EntityRef",EntityType:"EntityType",Contacts:"Contacts",Locations:"Locations",Value:"Value",Category:"Category",LatLong:"LatLong",FacebookID:"FacebookID",Sources:"Sources",Gender:"Gender",Picture:"Picture"};var ExtendedFieldNames={Intent:"Intent",SubjectHint:"SubjectHint",Article:"Article",CalEventID:"CalEventID",SelectedCount:"SelectedCount",SortBy:"SortBy"};var EntityTypes={User:"User",Folder:"Folder",Item:"Item"};var FieldTypes={String:"String",Boolean:"Boolean",Integer:"Integer",DateTime:"DateTime",Phone:"Phone",Email:"Email",Url:"Url",Address:"Address",Currency:"Currency",TagIDs:"TagIDs",Guid:"Guid",JSON:"JSON"};var DisplayTypes={Hidden:"Hidden",Text:"Text",TextArea:"TextArea",Checkbox:"Checkbox",DatePicker:"DatePicker",DateTimePicker:"DateTimePicker",Phone:"Phone",Email:"Email",Link:"Link",Currency:"Currency",Address:"Address",Priority:"Priority",TagList:"TagList",Reference:"Reference",Contact:"Contact",ContactList:"ContactList",LocationList:"LocationList",LinkArray:"LinkArray"};var SuggestionTypes={ChooseOne:"ChooseOne",ChooseOneSubject:"ChooseOneSubject",ChooseMany:"ChooseMany",ChooseManyWithChildren:"ChooseManyWithChildren",GetFBConsent:"GetFBConsent",GetGoogleConsent:"GetGoogleConsent",GetADConsent:"GetADConsent",NavigateLink:"NavigateLink",RefreshEntity:"RefreshEntity"};var Reasons={Chosen:"Chosen",Ignore:"Ignore",Like:"Like",Dislike:"Dislike"};var StatusTypes={Active:"Active",Complete:"Complete",Paused:"Paused",Paused:"Paused",Skipped:"Skipped",Stopped:null};var Sources={Directory:"Directory",Facebook:"Facebook",Local:"Local"};var SystemFolders={Client:"$Client",WebClient:"$WebClient"};var UserEntities={Inbox:"Inbox",People:"People",Places:"Places",Personal:"Personal",Home:"Home",Auto:"Auto"};var SystemUsers={System:"00000000-0000-0000-0000-000000000001",User:"00000000-0000-0000-0000-000000000002"};var ActionTypes={All:"Next Steps",Reminder:"Reminder",Call:"Call",Schedule:"Add to calendar",Errand:"Errand",SendEmail:"Email",TextMessage:"Text",AskFriends:"Ask on Facebook",Find:"Find local business"};function ActionType(){}ActionType.Extend=function ActionType$Extend(b){return $.extend(new ActionType(),b)};ActionType.prototype.Copy=function(){var b=$.extend(new ActionType(),this);return b};ActionType.prototype.GetSteps=function(o,p){if(p===undefined){p=StatusTypes.Active}var q=[];var l=0;for(var j in DataModel.Folders){var i=DataModel.Folders[j];for(var n in i.Items){var m=i.Items[n];if(m.IsStep()){if(this.Name==ActionTypes.All||this.Name==m.GetActionType().Name){if(m.Status==p){q[l++]=m}}}}}q.sort(function(a,b){var c=a.GetFieldValue(FieldNames.DueDate);var e=b.GetFieldValue(FieldNames.DueDate);if(c==e){return 0}if(c==null){return 1}if(e==null){return -1}var f=new Date(c);var g=new Date(e);if(f==g){return 0}if(f>g){return 1}return -1});return q};function Appointment(){}Appointment.Extend=function Appointment$Extend(b){return $.extend(new Appointment(),b)};Appointment.prototype.Copy=function(){var b=$.extend(new Appointment(),this);return b};function GalleryCategory(){}GalleryCategory.Extend=function GalleryCategory$Extend(b){return $.extend(new GalleryCategory(),b)};GalleryCategory.prototype.Copy=function(){var b=$.extend(new GalleryCategory(),this);b.Activities={};b.ItemsMap={};return b};GalleryCategory.prototype.IsSelected=function(){return DataModel.UserSettings.IsCategorySelected(this.ID)};GalleryCategory.prototype.IsExpanded=function(){return DataModel.UserSettings.IsCategoryExpanded(this.ID)};GalleryCategory.prototype.Expand=function(b){DataModel.UserSettings.ExpandCategory(this.ID,b)};GalleryCategory.prototype.GetActivities=function(){return this.Activities};GalleryCategory.prototype.GetActivity=function(b){return this.Activities[b]};GalleryCategory.prototype.IsGalleryCategory=function(){return true};GalleryCategory.prototype.IsGalleryActivity=function(){return false};GalleryCategory.prototype.Install=function(){Service.InvokeController("Actions","InstallCategory",{category:this},function(c){var e=c.result;if(e.StatusCode!="200"){Control.alert("Server was unable to install the category","Install Category")}else{Dashboard.dataModel.Refresh()}})};function GalleryActivity(){}GalleryActivity.Extend=function GalleryActivity$Extend(b){return $.extend(new GalleryActivity(),b)};GalleryActivity.prototype.Copy=function(){var b=$.extend(new GalleryActivity(),this);b.ItemsMap={};return b};GalleryActivity.prototype.IsGalleryCategory=function(){return false};GalleryActivity.prototype.IsGalleryActivity=function(){return true};GalleryActivity.prototype.IsSelected=function(){return DataModel.UserSettings.IsActivitySelected(this.ID)};GalleryActivity.prototype.Install=function(){Service.InvokeController("Actions","InstallActivity",{activity:this,category:null},function(c){var e=c.result;if(e.StatusCode!="200"){Control.alert("Server was unable to install the category","Install Activity")}else{Dashboard.dataModel.Refresh()}})};function LinkArray(b){this.links=[];if(b!=null&&b.length>0){this.links=$.parseJSON(b)}}LinkArray.prototype.Links=function(){return this.links};LinkArray.prototype.ToJson=function(){return JSON.stringify(this.links)};LinkArray.prototype.Remove=function(b){this.links.splice(b,1)};LinkArray.prototype.Add=function(e,f){if(f!=null){this.links.push({Name:f,Url:e});return this.links}var g=e.split(",");if(g.length>1){f=$.trim(g[0]);e=$.trim(g[1]);this.links.push({Name:f,Url:e})}else{this.links.push({Url:e})}return this.links};LinkArray.prototype.ToText=function(){var g="";for(var e in this.links){var f=this.links[e];if(f.hasOwnProperty("Name")){if(f.Name!=null&&f.Name.length>0&&f.Name!=f.Url){g+=f.Name+", "}}g+=f.Url+"\r\n"}return g};LinkArray.prototype.Parse=function(i){var g=i.split(/\r\n|\r|\n/g);for(var f in g){var h=g[f].split(",");if(h.length==1&&h[0].length>0){this.links.push({Url:h[0]})}if(h.length==2){this.links.push({Name:h[0],Url:h[1]})}}};function Recurrence(){this.Frequency=Recurrence.Frequencys.Daily;this.Interval=1;this.ByDay=[];this.ByMonthDay=[];this.ByYearDay=[];this.ByMonth=[]}Recurrence.Extend=function Recurrence$Extend(b){if(typeof(b)=="string"){b=$.parseJSON(b)}if(b!=null){if(typeof(b.Interval)=="string"){b.Interval=parseInt(b.Interval)}b.ByDay=(typeof(b.ByDay)=="string")?[]:b.ByDay;b.ByMonthDay=(b.ByMonthDay=="")?[]:b.ByMonthDay;b.ByYearDay=(b.ByYearDay=="")?[]:b.ByYearDay;b.ByMonth=(b.ByMonth=="")?[]:b.ByMonth}return $.extend(new Recurrence(),b)};Recurrence.Frequencys={Daily:"Daily",Weekly:"Weekly",Monthly:"Monthly",Yearly:"Yearly"};Recurrence.FrequencyLabels={Daily:"days",Weekly:"weeks",Monthly:"months",Yearly:"years"};Recurrence.WeekdayLabels=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];Recurrence.MonthLabels=["January","February","March","April","May","June","July","August","September","October","November","December"];Recurrence.prototype.ToJson=function(){return JSON.stringify(this)};Recurrence.prototype.IsEnabled=function(){return(this.On!=null)};Recurrence.prototype.Enable=function(){this.On=1};Recurrence.prototype.Disable=function(){delete this["On"]};Recurrence.prototype.IsDaily=function(){return this.Frequency==Recurrence.Frequencys.Daily};Recurrence.prototype.IsWeekly=function(){return this.Frequency==Recurrence.Frequencys.Weekly};Recurrence.prototype.IsMonthly=function(){return this.Frequency==Recurrence.Frequencys.Monthly};Recurrence.prototype.IsYearly=function(){return this.Frequency==Recurrence.Frequencys.Yearly};Recurrence.prototype.HasWeekdays=function(){return this.ByDay.length>0};Recurrence.prototype.HasWeekday=function(b){return this.ByDay.indexOf(b)!=-1};Recurrence.prototype.AddWeekday=function(b){this.ByDay.push(b)};Recurrence.prototype.RemoveWeekday=function(c){var e=this.ByDay.indexOf(d);if(e>=0){this.ByDay.splice(e,1)}};Recurrence.prototype.NoMonthDays=function(){this.ByMonthDay.length=0};Recurrence.prototype.FirstMonthDay=function(){return(this.ByMonthDay.length==0)?0:this.ByMonthDay[0]};Recurrence.prototype.HasMonthDay=function(b){return(this.ByMonthDay.indexOf(b)>=0)};Recurrence.prototype.AddMonthDay=function(b){this.ByMonthDay.push(b)};Recurrence.prototype.RemoveMonthDay=function(c){var e=this.ByMonthDay.indexOf(c);if(e>=0){this.ByMonthDay.splice(e,1)}};Recurrence.prototype.NoYearDays=function(){this.ByYearDay.length=0};Recurrence.prototype.FirstYearDay=function(){return(this.ByYearDay.length==0)?0:this.ByYearDay[0]};Recurrence.prototype.HasYearDay=function(b){return(this.ByYearDay.indexOf(b)>=0)};Recurrence.prototype.AddYearDay=function(b){this.ByYearDay.push(b)};Recurrence.prototype.RemoveYearDay=function(c){var e=this.ByYearDay.indexOf(c);if(e>=0){this.ByYearDay.splice(e,1)}};Recurrence.prototype.NoMonths=function(){this.ByMonth.length=0};Recurrence.prototype.FirstMonth=function(){return(this.ByMonth.length==0)?0:this.ByMonth[0]};Recurrence.prototype.HasMonth=function(b){return(this.ByMonth.indexOf(b)>=0)};Recurrence.prototype.AddMonth=function(b){this.ByMonth.push(b)};Recurrence.prototype.RemoveMonth=function(c){var e=this.ByMonth.indexOf(c);if(e>=0){this.ByMonth.splice(e,1)}};Recurrence.prototype.Summary=function(){var h="Do not repeat";if(this.IsEnabled()){var j=Recurrence.FrequencyLabels[this.Frequency];if(this.Interval==1){j=j.substr(0,j.length-1)}var k=this.Interval.toString();var i="</strong> after completing current activity ";if(this.IsWeekly()){var g=this.ByDay;if(g.length>0){k=(this.Interval==1)?"every":"every "+k;if(g.length==7){i="each day"}else{i="";$.each(g,function(b,a){i+=(b==0)?" on ":((b==g.length-1)?" and ":", ");i+=Recurrence.WeekdayLabels[a]})}i+="</strong>"}}if(this.IsMonthly()){if(this.FirstMonthDay()>0){k=(this.Interval==1)?"every":"every "+k;i="on the "+this.AddSuffix(this.FirstMonthDay())+"</strong> of the month"}}if(this.IsYearly()){if(this.FirstMonth()>0){k=(this.Interval==1)?"every":"every "+k;if(this.FirstYearDay()==0){i="in "+Recurrence.MonthLabels[this.FirstMonth()-1]}else{i="on "+Recurrence.MonthLabels[this.FirstMonth()-1];i+=" "+this.AddSuffix(this.FirstYearDay())}}i+="</strong>"}var h="Repeat <strong>"+k+" "+j+" "+i}return h};Recurrence.prototype.AddSuffix=function(f){var e=f%10;var g;switch(e){case 1:g="st";break;case 2:g="nd";break;case 3:g="rd";break;default:g="th";break}g=(f>10&&f<14)?"th":g;return f+g};Recurrence.prototype.NextDueDate=function(g){if(typeof(g)=="string"){g=new Date(g)}if(this.IsDaily()){g.add(this.Interval).days()}if(this.IsWeekly()){g.add(this.Interval).weeks();if(this.ByDay.length>0){if(this.ByDay[0]!=g.getDay()){g.moveToDayOfWeek(this.ByDay[0])}}}if(this.IsMonthly()){g.add(this.Interval).months();if(this.ByMonthDay.length>0){var f=Date.getDaysInMonth(g.getFullYear(),g.getMonth());var e=(this.ByMonthDay[0]>f)?f:this.ByMonthDay[0];g.setDate(e)}}if(this.IsYearly()){g.add(this.Interval).years();if(this.ByMonth.length>0){g.setMonth(this.ByMonth[0]-1);if(this.ByYearDay.length>0){var f=Date.getDaysInMonth(g.getFullYear(),g.getMonth());var e=(this.ByYearDay[0]>f)?f:this.ByYearDay[0];g.setDate(e)}else{g.setDate(1)}}}return g.format("shortDate")};function UserSettings(c,e){this.clientFolder=c;this.webClientFolder=e;this.init(UserSettings.viewStateName,UserSettings.viewStateKey);this.init(UserSettings.preferencesName,UserSettings.preferencesKey)}UserSettings.defaultListsKey="DefaultLists";UserSettings.viewStateName="ViewState";UserSettings.viewStateKey="WebViewState";UserSettings.preferencesName="Preferences";UserSettings.preferencesKey="WebPreferences";UserSettings.prototype.GetFolder=function(b){if(this.clientFolder.ID==b){return this.clientFolder}if(this.webClientFolder.ID==b){return this.webClientFolder}return null};UserSettings.prototype.GetDefaultList=function(j){var h=this.clientFolder.GetItemByName(UserSettings.defaultListsKey);if(h!=null){var g=this.clientFolder.GetItemByValue(j,h.ID);if(g!=null){var k=g.GetFieldValue(FieldNames.EntityRef);if(typeof(k)=="object"){return k}}}var i;for(id in DataModel.Folders){i=DataModel.Folders[id];if(i.ItemTypeID==j){return i}}return i};UserSettings.prototype.Selection=function(c,e){this.ViewState.SelectedFolder=c;this.ViewState.SelectedItem=e};UserSettings.prototype.IsFolderSelected=function(b){return(this.ViewState.SelectedFolder==b)};UserSettings.prototype.IsCategorySelected=function(b){return(this.ViewState.SelectedCategory==b)};UserSettings.prototype.IsActivitySelected=function(b){return(this.ViewState.SelectedActivity==b)};UserSettings.prototype.IsItemSelected=function(g,e){if(e==true){var f=DataModel.FindItem(this.ViewState.SelectedItem);if(f!=null&&f.ParentID==g){return true}}return(this.ViewState.SelectedItem==g)};UserSettings.prototype.ExpandFolder=function(e,c){if(this.ViewState.ExpandedFolders==null){this.ViewState.ExpandedFolders={}}if(c==true){this.ViewState.ExpandedFolders[e]=true}else{delete this.ViewState.ExpandedFolders[e]}};UserSettings.prototype.ExpandCategory=function(c,e){if(this.ViewState.ExpandedCategories==null){this.ViewState.ExpandedCategories={}}if(e==true){this.ViewState.ExpandedCategories[c]=true}else{delete this.ViewState.ExpandedCategories[c]}};UserSettings.prototype.IsFolderExpanded=function(b){return(this.ViewState.ExpandedFolders!=null&&this.ViewState.ExpandedFolders[b]==true)};UserSettings.prototype.IsCategoryExpanded=function(b){return(this.ViewState.ExpandedCategories!=null&&this.ViewState.ExpandedCategories[b]==true)};UserSettings.prototype.Save=function(){var c={};for(var e in DataModel.Folders){if(DataModel.Folders[e].IsExpanded()){c[e]=true}}this.ViewState.ExpandedFolders=c;this.update(UserSettings.viewStateName,UserSettings.viewStateKey)};UserSettings.prototype.UpdateTheme=function(b){if(this.Preferences.Theme!=b){this.Preferences.Theme=b;this.update(UserSettings.preferencesName,UserSettings.preferencesKey);Service.ChangeTheme(b)}};UserSettings.prototype.init=function(h,f){var g="item"+h;if(this.webClientFolder!=null){this[g]=this.webClientFolder.GetItemByName(f,null)}if(this[g]==null){this[h]={};if(this.webClientFolder!=null){this.webClientFolder.InsertItem(Item.Extend({Name:f,ItemTypeID:ItemTypes.NameValue}),null,null,null)}}else{var i=this[g].GetFieldValue(FieldNames.Value);this[h]=(i==null)?{}:$.parseJSON(i)}};UserSettings.prototype.update=function(h,f){if(this.webClientFolder!=null){var g="item"+h;if(this[g]==null){this[g]=this.webClientFolder.GetItemByName(f,null)}var i=this[g].Copy();i.SetFieldValue(FieldNames.Value,JSON.stringify(this[h]));this[g].Update(i)}};function SuggestionManager(b){this.dataModel=b}SuggestionManager.findSuggestion=function SuggestionManager$findSuggestion(i,j){if(i!=null){for(var g in i){var f=i[g].Suggestions;if(f!=null){for(var h in f){if(f[h].SuggestionType==j){return f[h]}}}}}return null};SuggestionManager.prototype.select=function(g,e){var f=false;switch(g.SuggestionType){case SuggestionTypes.ChooseOne:f=this.chooseSuggestion(g);break;case SuggestionTypes.ChooseOneSubject:f=this.chooseSuggestion(g);break;case SuggestionTypes.ChooseMany:f=this.chooseMany(g);break;case SuggestionTypes.NavigateLink:f=this.navigateLink(g);break;case SuggestionTypes.GetFBConsent:f=this.getFacebookConsent(g,e);break;case SuggestionTypes.GetGoogleConsent:f=this.getGoogleConsent(g,e);break;case SuggestionTypes.GetADConsent:f=this.getCloudADConsent(g);break;default:f=this.chooseSuggestion(g);break}return f};SuggestionManager.prototype.chooseSuggestion=function(g,e){var f=this.dataModel;f.SelectSuggestion(g,Reasons.Chosen,function(a){if(e!=null){e()}});this.ignoreSuggestions(g);return true};SuggestionManager.prototype.ignoreSuggestions=function(j){var f=this.dataModel;var g=f.Suggestions[j.GroupID];if(g!=null){for(var h in g.Suggestions){var i=g.Suggestions[h];if(i.ID!=j.ID){f.SelectSuggestion(i,Reasons.Ignore)}}}};SuggestionManager.prototype.likeSuggestion=function(e,c){this.dataModel.SelectSuggestion(e,Reasons.Like,function(a){if(c!=null){c()}});return false};SuggestionManager.prototype.dislikeSuggestion=function(g,e){var f=this.dataModel;f.SelectSuggestion(g,Reasons.Dislike,function(a){if(e!=null){e()}});return false};SuggestionManager.prototype.navigateLink=function(b){return this.likeSuggestion(b,function(){window.open(b.Value)})};SuggestionManager.prototype.chooseMany=function(b){return this.likeSuggestion(b,function(){})};SuggestionManager.prototype.getFacebookConsent=function(h,f){var e=this.dataModel;var g="You will be redirected to Facebook to allow this application to access your Facebook information. This application will use information about yourself to help setup your user profile. This application will use information about your friends to help manage your Contacts. <br><br>Do you want to continue?";Control.confirm(g,"Facebook Consent?",function(){Service.GetFacebookConsent(f)});return false};SuggestionManager.prototype.getCloudADConsent=function(g){var e=this.dataModel;var f="You will be redirected to the Cloud Directory portal. Login with your Office 365 credentials to allow this application to access your directory information. This application will use information about yourself and other users to help manage your Contacts. <br><br>Do you want to continue?";Control.confirm(f,"Cloud Directory Consent?",function(){Service.GetCloudADConsent()});return false};SuggestionManager.prototype.getGoogleConsent=function(h,f){var e=this.dataModel;var g="You will be redirected to Google to allow this application to manage your Google Calendar. This application will interact with your calendar to keep your tasks and appointments synchronized. <br><br>Do you want to continue?";Control.confirm(g,"Google Calendar Consent?",function(){Service.GetGoogleConsent(f)});return false};var ProfileWizard=function ProfileWizard$(){this.dataModel=null;this.suggestionManager=null};ProfileWizard.Init=function ProfileWizard$Init(e,c){this.dataModel=e;this.checkBrowser();this.checkConsent(c);this.$element=$(".wizard-region");this.$activePanel=this.$element.find("#user_info");this.suggestionManager=new SuggestionManager(this.dataModel);this.dataModel.GetSuggestions(function(h){var b=SuggestionManager.findSuggestion(h,SuggestionTypes.GetFBConsent);var a=ProfileWizard.$element.find(".connect .fb");if(b!=null){a.css("display","block");a.attr("title","Connect to Facebook").tooltip(Control.ttDelayBottom);a.click(function(){ProfileWizard.suggestionManager.select(b,"wizard")})}var g=SuggestionManager.findSuggestion(h,SuggestionTypes.GetGoogleConsent);a=ProfileWizard.$element.find(".connect .google");if(g!=null){a.css("display","block");a.attr("title","Connect to Calendar").tooltip(Control.ttDelayBottom);a.click(function(){ProfileWizard.suggestionManager.select(g,"wizard")})}});this.$element.find(".btn-success").click(function(){ProfileWizard.showNextPanel()});$(window).bind("load",ProfileWizard.resize);$(window).bind("resize",ProfileWizard.resize);this.showActivePanel()};ProfileWizard.showActivePanel=function ProfileWizard$showActivePanel(){this.$element.find(".info-pane").removeClass("active");this.$activePanel.addClass("active")};ProfileWizard.showNextPanel=function ProfileWizard$showNextPanel(){this.$activePanel=this.$element.find(".info-pane.active").next(".info-pane");if(this.$activePanel.length>0){this.showActivePanel()}else{Service.NavigateToDashboard()}};ProfileWizard.resize=function ProfileWizard$resize(){if(ProfileWizard.resizing){return}ProfileWizard.resizing=true;$(window).unbind("resize",ProfileWizard.resize);var h=$(window).height();var f=$(".navbar-fixed-top").height();var e=$(".navbar-fixed-bottom").height();var g=h-(f+e+30);ProfileWizard.$element.find(".well").height(g);$(window).bind("resize",ProfileWizard.resize);ProfileWizard.resizing=false};ProfileWizard.checkBrowser=function ProfileWizard$checkBrowser(){if(Browser.IsMSIE()&&Browser.MSIE_Version()<9){var c="We're Sorry!";var e="This application currently requires an HTML5-compatible browser. We encourage you to try using the application with the latest version of Internet Explorer, Chrome, or FireFox.<br/>Thank you";Control.alert(e,c)}};ProfileWizard.checkConsent=function ProfileWizard$checkConsent(e){if(e!=null&&e.length>0){var g,f;switch(e){case"FBConsentFail":f="Failed!";g="This application was not able to receive consent for accessing your Facebook information.";break;case"GoogleConsentFail":f="Failed!";g="This application was not able to receive consent for managing your Google calendar.";break;case"CloudADConsentFail":f="Failed!";g="This application was not able to receive consent for accessing your Cloud Directory.";break;default:ProfileWizard.consentStatus=e;ProfileWizard.dataModel.GetSuggestions(ProfileWizard.completeConsent)}if(g!=null){Control.alert(g,f,function(){Service.NavigateToProfileWizard()})}}};ProfileWizard.completeConsent=function ProfileWizard$completeConsent(h){if(ProfileWizard.consentStatus!=null&&ProfileWizard.consentStatus.length>0){var f,e,g;switch(ProfileWizard.consentStatus){case"FBConsentSuccess":e="Success!";f="This application has successfully received consent for accessing your Facebook information.";g=SuggestionManager.findSuggestion(h,SuggestionTypes.GetFBConsent);break;case"GoogleConsentSuccess":e="Success!";f="This application has successfully received consent for managing your Google calendar.";g=SuggestionManager.findSuggestion(h,SuggestionTypes.GetGoogleConsent);break;case"CloudADConsentSuccess":e="Success!";f="This application has successfully received consent for accessing your Cloud Directory.";g=SuggestionManager.findSuggestion(h,SuggestionTypes.GetADConsent);break}ProfileWizard.consentStatus=null;if(g!=null&&g.ReasonSelected!=Reasons.Chosen){ProfileWizard.dataModel.SelectSuggestion(g,Reasons.Chosen);Control.alert(f,e,function(){Service.NavigateToProfileWizard()})}}};